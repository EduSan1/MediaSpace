{"version":3,"file":"contractMessages.js","names":["getContractStatusAsync","context","capabilities","ITCAgreements","getCapabilitiesAsync","contractStatus","error","Log","warn","message","getContractMessagesAsync","getRequiredContractMessagesAsync","status","includes","messages","isFatal","newLine","rootUrl","formatContractMessage","convertHTMLToASCII","content","subject","filter","Boolean","join","assertContractMessagesAsync","spinner","Array","isArray","length","stop","log","chalk","yellow","bold","isDebug","JSON","stringify","addNewLineIfNone","CommandError"],"sources":["../../src/appleApi/contractMessages.ts"],"sourcesContent":["import { ITCAgreements, RequestContext } from '@expo/apple-utils';\nimport chalk from 'chalk';\nimport { Ora } from 'ora';\n\nimport CommandError from '../CommandError';\nimport Log from '../log';\nimport { convertHTMLToASCII } from './convertHTMLToASCII';\n\nasync function getContractStatusAsync(\n  context: RequestContext\n): Promise<ITCAgreements.ITCContractStatus | null> {\n  try {\n    const capabilities = await ITCAgreements.getCapabilitiesAsync(context);\n    return capabilities?.contractStatus ?? null;\n  } catch (error: any) {\n    Log.warn(`Failed to get iTunes contract status: ${error.message}`);\n    return null;\n  }\n}\n\nasync function getContractMessagesAsync(context: RequestContext) {\n  try {\n    return await ITCAgreements.getContractMessagesAsync(context);\n  } catch (error: any) {\n    Log.warn(`Failed to get iTunes contract messages: ${error.message}`);\n    return null;\n  }\n}\n\nasync function getRequiredContractMessagesAsync(\n  context: RequestContext\n): Promise<{ messages: ITCAgreements.ITCContractMessage[]; isFatal: boolean }> {\n  // This emulates the check that's performed on the ASC website's \"apps\"\n  // page before presenting the (+) create app button.\n  const status = await getContractStatusAsync(context);\n\n  if (status) {\n    if (['FREE_APP_AGREEMENT_ACTIVE', 'PAID_APP_AGREEMENT_ACTIVE'].includes(status)) {\n      // The user can freely create an app, no contracts need to be accepted.\n      // No need to check for messages because afaict no vital messages will be present.\n      return { messages: [], isFatal: false };\n    } else if (\n      ['FREE_APP_AGREEMENT_OUTDATED', 'PAID_APP_AGREEMENT_OUTDATED', 'EXPIRED_MEMBERSHIP'].includes(\n        status\n      )\n    ) {\n      // The user cannot create an app until they've reviewed, and agreed to the updated agreements\n      // or renewed their membership on ASC.\n      // Get the exact messages from ASC to show the user a useful message.\n      return { messages: (await getContractMessagesAsync(context)) ?? [], isFatal: true };\n    }\n  }\n  // The contract messages aren't documented so if a new one is present we cannot be sure if it's fatal or not.\n  // This will check for messages, if none exist, then the process will continue.\n  // Otherwise messages will be present and the process will stop.\n  // There is a small chance that this could result in a false positive if the messages are extraneous, so we'll also\n  // prompt the user to open an issue so we can address the new contract state if it ever appears.\n  // TODO: Maybe a silent analytic would be better\n  Log.error(\n    `\\nUnexpected Apple developer contract status \"${status}\". Please open an issue on https://github.com/expo/eas-cli`\n  );\n  Log.newLine();\n  return { messages: (await getContractMessagesAsync(context)) ?? [], isFatal: false };\n}\n\nconst rootUrl = 'https://appstoreconnect.apple.com';\n\nexport function formatContractMessage(message: ITCAgreements.ITCContractMessage): string {\n  return convertHTMLToASCII({\n    content:\n      '\\u203A ' +\n      [message.subject && `<b>${message.subject}</b>`, message.message]\n        .filter(Boolean)\n        .join('<br />'),\n    rootUrl,\n  });\n}\n\nexport async function assertContractMessagesAsync(context: RequestContext, spinner?: Ora) {\n  const { messages, isFatal } = await getRequiredContractMessagesAsync(context);\n\n  if (Array.isArray(messages) && messages.length) {\n    if (spinner) {\n      spinner.stop();\n    }\n    Log.newLine();\n    Log.log(chalk.yellow.bold('Messages from App Store Connect:'));\n    Log.newLine();\n    for (const message of messages) {\n      if (Log.isDebug) {\n        Log.log(JSON.stringify(message, null, 2));\n        Log.newLine();\n      }\n      Log.addNewLineIfNone();\n      Log.log(formatContractMessage(message));\n    }\n    Log.addNewLineIfNone();\n    // Only throw an error if we know that the status is fatal, otherwise attempt to finish the process.\n    if (isFatal) {\n      throw new CommandError('App Store Connect has agreement updates that must be resolved');\n    }\n  }\n}\n"],"mappings":"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"}