{"version":3,"file":"getUsageAsync.js","names":["getUsageAsync","projectRoot","_getUsageAsync","e","Log","warn","_getGenericUsage","allPlatforms","publishesResult","getPublishHistoryAsync","releaseChannel","count","length","publishes","queryResult","uniquePlatforms","uniqBy","publish","platform","details","Promise","all","map","publication","detailOptions","publishId","publicationId","getPublicationDetailAsync","uniqueRevisionIds","detail","revisionId","channel","publishedTime","sdkVersion","timeDifferenceString","_getTimeDifferenceString","Date","t0","t1","minutesInMs","hourInMs","dayInMs","diffMs","Math","abs","getTime","diffDays","round","diffHours","diffMinutes"],"sources":["../../../src/commands/publish/getUsageAsync.ts"],"sourcesContent":["import uniqBy from 'lodash/uniqBy';\n\nimport Log from '../../log';\nimport {\n  getPublicationDetailAsync,\n  getPublishHistoryAsync,\n  Publication,\n} from '../utils/PublishUtils';\n\nexport async function getUsageAsync(projectRoot: string): Promise<string> {\n  try {\n    return await _getUsageAsync(projectRoot);\n  } catch (e: any) {\n    Log.warn(e);\n    // couldn't print out warning for some reason\n    return _getGenericUsage();\n  }\n}\n\nasync function _getUsageAsync(projectRoot: string): Promise<string> {\n  const allPlatforms = ['ios', 'android'];\n  const publishesResult = await getPublishHistoryAsync(projectRoot, {\n    releaseChannel: 'default', // not specifying a channel will return most recent publishes but this is not neccesarily the most recent entry in a channel (user could have set an older publish to top of the channel)\n    count: allPlatforms.length,\n  });\n  const publishes = publishesResult.queryResult as Publication[];\n\n  // If the user published normally, there would be a publish for each platform with the same revisionId\n  const uniquePlatforms = uniqBy(publishes, publish => publish.platform);\n  if (uniquePlatforms.length !== allPlatforms.length) {\n    // User probably applied some custom `publish:set` or `publish:rollback` command\n    return _getGenericUsage();\n  }\n\n  const details = await Promise.all(\n    publishes.map(async publication => {\n      const detailOptions = {\n        publishId: publication.publicationId,\n      };\n      return await getPublicationDetailAsync(projectRoot, detailOptions);\n    })\n  );\n\n  const uniqueRevisionIds = uniqBy(details, detail => detail.revisionId);\n  if (uniqueRevisionIds.length !== 1) {\n    // User probably applied some custom `publish:set` or `publish:rollback` command\n    return _getGenericUsage();\n  }\n\n  const { channel } = publishes[0];\n  const { revisionId, publishedTime, sdkVersion } = details[0];\n  const timeDifferenceString = _getTimeDifferenceString(new Date(), new Date(publishedTime));\n\n  return (\n    `--release-channel and either --sdk-version or --runtime-version arguments are required. \\n` +\n    `For example, to roll back the revision [${revisionId}] on release channel [${channel}] (published ${timeDifferenceString}), \\n` +\n    `run: expo publish:rollback --release-channel ${channel} --sdk-version ${sdkVersion}`\n  );\n}\n\nfunction _getTimeDifferenceString(t0: Date, t1: Date): string {\n  const minutesInMs = 60 * 1000;\n  const hourInMs = 60 * minutesInMs;\n  const dayInMs = 24 * hourInMs; // hours*minutes*seconds*milliseconds\n  const diffMs = Math.abs(t1.getTime() - t0.getTime());\n\n  const diffDays = Math.round(diffMs / dayInMs);\n  if (diffDays > 0) {\n    return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;\n  }\n\n  const diffHours = Math.round(diffMs / hourInMs);\n  if (diffHours > 0) {\n    return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;\n  }\n\n  const diffMinutes = Math.round(diffMs / minutesInMs);\n  if (diffMinutes > 0) {\n    return `${diffMinutes} minute${diffMinutes === 1 ? '' : 's'} ago`;\n  }\n\n  return 'recently';\n}\n\nfunction _getGenericUsage(): string {\n  return (\n    `--release-channel and either --sdk-version or --runtime-version arguments are required. \\n` +\n    `For example, to roll back the latest publishes on the default channel for sdk 37.0.0, \\n` +\n    `run: expo publish:rollback --release-channel default --sdk-version 37.0.0 \\n` +\n    `To rollback a specific platform, use the --platform flag.`\n  );\n}\n"],"mappings":"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"}