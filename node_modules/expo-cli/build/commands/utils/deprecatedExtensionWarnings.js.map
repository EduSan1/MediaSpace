{"version":3,"file":"deprecatedExtensionWarnings.js","names":["queryExpoExtensionFilesAsync","projectRoot","ignore","results","wrapGlobWithTimeout","everyMatchAsync","absolute","cwd","Log","warn","assertProjectHasExpoExtensionFilesAsync","checkNodeModules","assertModulesHasExpoExtensionFilesAsync","time","matches","catch","timeEnd","length","promptMatchesAsync","getWorkspaceRoot","findWorkspaceRoot","error","message","includes","spinner","ora","start","root","filter","value","match","succeed","fail","logMatchedFiles","hasNodeModules","find","chalk","red","bold","reset","map","join","dim","program","nonInteractive","confirmAsync","initial","SilentError"],"sources":["../../../src/commands/utils/deprecatedExtensionWarnings.ts"],"sourcesContent":["import chalk from 'chalk';\nimport program from 'commander';\nimport findWorkspaceRoot from 'find-yarn-workspace-root';\n\nimport { SilentError } from '../../CommandError';\nimport Log from '../../log';\nimport { ora } from '../../utils/ora';\nimport { confirmAsync } from '../../utils/prompts';\nimport { everyMatchAsync, wrapGlobWithTimeout } from './glob';\n\nasync function queryExpoExtensionFilesAsync(\n  projectRoot: string,\n  ignore: string[]\n): Promise<string[]> {\n  const results = await wrapGlobWithTimeout(\n    () =>\n      everyMatchAsync('**/*.expo.@(js|jsx|ts|tsx)', {\n        absolute: true,\n        ignore,\n        cwd: projectRoot,\n      }),\n    5000\n  );\n\n  if (results === false) {\n    Log.warn('Failed to query all project files. Skipping `.expo.*` extension check...');\n    return [];\n  }\n  return results;\n}\n\nexport async function assertProjectHasExpoExtensionFilesAsync(\n  projectRoot: string,\n  checkNodeModules: boolean = false\n) {\n  if (checkNodeModules) {\n    await assertModulesHasExpoExtensionFilesAsync(projectRoot);\n  } else {\n    Log.time('assertProjectHasExpoExtensionFilesAsync');\n\n    const matches = await queryExpoExtensionFilesAsync(projectRoot, [\n      `**/@(Carthage|Pods|node_modules|ts-declarations|.expo)/**`,\n      '@(ios|android|web)/**',\n    ]).catch(() => [] as string[]);\n\n    Log.timeEnd('assertProjectHasExpoExtensionFilesAsync');\n    if (matches.length) {\n      await promptMatchesAsync(matches);\n    }\n  }\n}\n\n/** Wraps `findWorkspaceRoot` and guards against having an empty `package.json` file in an upper directory. */\nfunction getWorkspaceRoot(projectRoot: string): string | null {\n  try {\n    return findWorkspaceRoot(projectRoot);\n  } catch (error: any) {\n    if (error.message.includes('Unexpected end of JSON input')) {\n      return null;\n    }\n    throw error;\n  }\n}\n\nasync function assertModulesHasExpoExtensionFilesAsync(projectRoot: string) {\n  const spinner = ora('Checking project for deprecated features, this may take a moment.').start();\n  const root = getWorkspaceRoot(projectRoot) || projectRoot;\n\n  Log.time('assertModulesHasExpoExtensionFilesAsync');\n  let matches = await queryExpoExtensionFilesAsync(root, [\n    `**/@(Carthage|Pods|ts-declarations|.expo)/**`,\n    '@(ios|android|web)/**',\n  ]).catch(() => [] as string[]);\n  Log.timeEnd('assertModulesHasExpoExtensionFilesAsync');\n  matches = matches.filter(value => {\n    if (value.includes('node_modules')) {\n      // Remove duplicate files from packages compiled with bob\n      return !value.match(/node_modules\\/.*\\/lib\\/commonjs/g);\n    }\n    return true;\n  });\n\n  if (!matches.length) {\n    spinner.succeed('Validated project');\n    return;\n  } else {\n    spinner.fail('Found project files with deprecated features');\n  }\n\n  logMatchedFiles(matches);\n}\n\nfunction logMatchedFiles(matches: string[]) {\n  const hasNodeModules = matches.find(match => match.includes('node_modules/'));\n  Log.error(\n    chalk.red(\n      `Project is using deprecated ${chalk.bold`.expo.*`} file extensions.\\nPlease refactor the following files${\n        hasNodeModules ? ' and upgrade modules' : ''\n      } accordingly:\\n\\n`\n    ) +\n      chalk.reset(\n        matches.map(match => `- ${match}`).join('\\n') +\n          chalk.dim(\n            `\\n\\nDangerously disable this check with ${chalk.bold(\n              `EXPO_LEGACY_IMPORTS=1`\n            )}\\nLearn more: http://expo.fyi/expo-extension-migration\\n`\n          )\n      )\n  );\n}\n\nasync function promptMatchesAsync(matches: string[]) {\n  logMatchedFiles(matches);\n\n  // Skip in nonInteractive to give users a bypass\n  if (\n    program.nonInteractive ||\n    (await confirmAsync({ message: 'Would you like to continue anyways?', initial: true }))\n  ) {\n    return;\n  }\n\n  throw new SilentError();\n}\n"],"mappings":"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"}