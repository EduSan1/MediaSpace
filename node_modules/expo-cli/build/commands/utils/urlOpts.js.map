{"version":3,"file":"urlOpts.js","names":["addOptions","program","option","optsAsync","projectRoot","options","opts","ProjectSettings","readAsync","host","lan","localhost","tunnel","filter","i","length","CommandError","hostType","offline","ConnectionStatus","setIsOffline","scheme","devClient","getOptionalDevClientSchemeAsync","isDevClientPackageInstalled","setAsync","printQRCode","url","qrcodeTerminal","generate","small","code","Log","log","handleMobileOptsAsync","results","Promise","all","android","webOnly","Android","openWebProjectAsync","openProjectAsync","ios","Simulator","shouldPrompt","web","Webpack","openAsync","errors","reduce","prev","curr","success","concat","error","Boolean","isEscapedError","some","AbortCommandError"],"sources":["../../../src/commands/utils/urlOpts.ts"],"sourcesContent":["import type { Command } from 'commander';\nimport qrcodeTerminal from 'qrcode-terminal';\nimport {\n  Android,\n  ConnectionStatus,\n  isDevClientPackageInstalled,\n  ProjectSettings,\n  Simulator,\n  Webpack,\n} from 'xdl';\n\nimport CommandError, { AbortCommandError } from '../../CommandError';\nimport Log from '../../log';\nimport { getOptionalDevClientSchemeAsync } from '../run/utils/schemes';\n\n// NOTE: if you update this, you should also update assertValidOptions in UrlUtils.ts\nexport type URLOptions = {\n  devClient?: boolean;\n  android?: boolean;\n  ios?: boolean;\n  web?: boolean;\n  scheme?: string;\n  host?: 'lan' | 'tunnel' | 'localhost';\n  tunnel?: boolean;\n  lan?: boolean;\n  localhost?: boolean;\n};\n\nfunction addOptions(program: Command) {\n  program\n    .option(\n      '--dev-client',\n      'Experimental: Starts the bundler for use with the expo-development-client'\n    )\n    .option('--scheme <scheme>', 'Custom URI protocol to use with a development build')\n    .option('-a, --android', 'Opens your app in Expo Go on a connected Android device')\n    .option(\n      '-i, --ios',\n      'Opens your app in Expo Go in a currently running iOS simulator on your computer'\n    )\n    .option('-w, --web', 'Opens your app in a web browser')\n    .option(\n      '-m, --host [mode]',\n      'lan (default), tunnel, localhost. Type of host to use. \"tunnel\" allows you to view your link on other networks'\n    )\n    .option('--tunnel', 'Same as --host tunnel')\n    .option('--lan', 'Same as --host lan')\n    .option('--localhost', 'Same as --host localhost');\n}\n\nasync function optsAsync(projectRoot: string, options: any) {\n  const opts = await ProjectSettings.readAsync(projectRoot);\n\n  if ([options.host, options.lan, options.localhost, options.tunnel].filter(i => i).length > 1) {\n    throw new CommandError(\n      'BAD_ARGS',\n      'Specify at most one of --host, --tunnel, --lan, and --localhost'\n    );\n  }\n\n  opts.hostType = 'lan';\n\n  if (options.offline) {\n    // TODO: maybe let people know that we will force localhost with offline?\n    ConnectionStatus.setIsOffline(true);\n    opts.hostType = 'localhost';\n  }\n\n  if (options.host) {\n    opts.hostType = options.host;\n  } else if (options.tunnel) {\n    opts.hostType = 'tunnel';\n  } else if (options.lan) {\n    opts.hostType = 'lan';\n  } else if (options.localhost) {\n    opts.hostType = 'localhost';\n  }\n\n  if (typeof options.scheme === 'string') {\n    // Use the custom scheme\n    opts.scheme = options.scheme ?? null;\n  } else if (options.devClient) {\n    // Attempt to find the scheme or warn the user how to setup a custom scheme\n    opts.scheme = await getOptionalDevClientSchemeAsync(projectRoot);\n  } else if (!options.devClient && isDevClientPackageInstalled(projectRoot)) {\n    opts.scheme = await getOptionalDevClientSchemeAsync(projectRoot);\n  } else {\n    // Ensure this is reset when users don't use `--scheme`, `--dev-client` and don't have the `expo-dev-client` package installed.\n    opts.scheme = null;\n  }\n\n  await ProjectSettings.setAsync(projectRoot, opts);\n\n  return opts;\n}\n\nfunction printQRCode(url: string) {\n  qrcodeTerminal.generate(url, { small: true }, code => Log.log(code));\n}\n\nasync function handleMobileOptsAsync(\n  projectRoot: string,\n  options: Pick<URLOptions, 'devClient' | 'ios' | 'android' | 'web'> & { webOnly?: boolean }\n) {\n  const results = await Promise.all([\n    (async () => {\n      if (options.android) {\n        if (options.webOnly) {\n          return await Android.openWebProjectAsync({ projectRoot });\n        } else {\n          return await Android.openProjectAsync({\n            projectRoot,\n            devClient: options.devClient ?? false,\n          });\n        }\n      }\n      return null;\n    })(),\n    (async () => {\n      if (options.ios) {\n        if (options.webOnly) {\n          return await Simulator.openWebProjectAsync({ projectRoot, shouldPrompt: false });\n        } else {\n          return await Simulator.openProjectAsync({\n            projectRoot,\n            devClient: options.devClient ?? false,\n            shouldPrompt: false,\n          });\n        }\n      }\n      return null;\n    })(),\n    (async () => {\n      if (options.web) {\n        return await Webpack.openAsync(projectRoot);\n      }\n      return null;\n    })(),\n  ]);\n\n  const errors = results\n    .reduce<(string | Error)[]>((prev, curr) => {\n      if (curr && !curr.success) {\n        return prev.concat([curr.error]);\n      }\n      return prev;\n    }, [])\n    .filter(Boolean);\n\n  if (errors.length) {\n    // ctrl+c\n    const isEscapedError = errors.some(error => error === 'escaped');\n    if (isEscapedError) {\n      throw new AbortCommandError();\n    } else {\n      if (typeof errors[0] === 'string') {\n        // Throw the first error\n        throw new CommandError(errors[0]);\n      }\n      throw errors[0];\n    }\n  }\n\n  return !!options.android || !!options.ios;\n}\n\nexport default {\n  addOptions,\n  handleMobileOptsAsync,\n  printQRCode,\n  optsAsync,\n};\n"],"mappings":"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"}