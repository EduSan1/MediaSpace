{"version":3,"file":"FileSystemCache.js","names":["getBodyAndMetaKeys","key","FileSystemCache","constructor","options","get","metaKey","metaInfo","cacache","info","cacheDirectory","undefined","metaBuffer","byDigest","integrity","metaData","JSON","parse","bodyStreamIntegrity","empty","expiration","Date","now","bodyStream","Readable","from","Buffer","alloc","stream","remove","bodyKey","Promise","all","rm","entry","set","metaCopy","ttl","fulfill","reject","pipe","put","on","i","e","err","code","stringify","cachedData"],"sources":["../../../../src/commands/utils/fetch-cache/FileSystemCache.ts"],"sourcesContent":["import cacache from 'cacache';\nimport { Readable } from 'stream';\n\nfunction getBodyAndMetaKeys(key: string): [string, string] {\n  return [`${key}body`, `${key}meta`];\n}\n\nexport class FileSystemCache {\n  constructor(public options: { ttl?: boolean; cacheDirectory: string }) {}\n\n  async get(key: string) {\n    const [, metaKey] = getBodyAndMetaKeys(key);\n\n    const metaInfo = await cacache.get.info(this.options.cacheDirectory, metaKey);\n\n    if (!metaInfo) {\n      return undefined;\n    }\n\n    const metaBuffer = await cacache.get.byDigest(this.options.cacheDirectory, metaInfo.integrity);\n    const metaData = JSON.parse(metaBuffer);\n    const { bodyStreamIntegrity, empty, expiration } = metaData;\n\n    delete metaData.bodyStreamIntegrity;\n    delete metaData.empty;\n    delete metaData.expiration;\n\n    if (expiration && expiration < Date.now()) {\n      return undefined;\n    }\n\n    const bodyStream = empty\n      ? Readable.from(Buffer.alloc(0))\n      : cacache.get.stream.byDigest(this.options.cacheDirectory, bodyStreamIntegrity);\n\n    return {\n      bodyStream,\n      metaData,\n    };\n  }\n\n  remove(key: string) {\n    const [bodyKey, metaKey] = getBodyAndMetaKeys(key);\n\n    return Promise.all([\n      cacache.rm.entry(this.options.cacheDirectory, bodyKey),\n      cacache.rm.entry(this.options.cacheDirectory, metaKey),\n    ]);\n  }\n\n  async set(key: string, bodyStream: NodeJS.ReadStream, metaData: any) {\n    const [bodyKey, metaKey] = getBodyAndMetaKeys(key);\n    const metaCopy = { ...metaData };\n\n    if (typeof this.options.ttl === 'number') {\n      metaCopy.expiration = Date.now() + this.options.ttl;\n    }\n\n    try {\n      metaCopy.bodyStreamIntegrity = await new Promise((fulfill, reject) => {\n        bodyStream\n          .pipe(cacache.put.stream(this.options.cacheDirectory, bodyKey))\n          .on('integrity', i => fulfill(i))\n          .on('error', e => {\n            reject(e);\n          });\n      });\n    } catch (err: any) {\n      if (err.code !== 'ENODATA') {\n        throw err;\n      }\n\n      metaCopy.empty = true;\n    }\n\n    const metaBuffer = Buffer.from(JSON.stringify(metaCopy));\n    await cacache.put(this.options.cacheDirectory, metaKey, metaBuffer);\n    const cachedData = await this.get(key);\n\n    return cachedData;\n  }\n}\n"],"mappings":"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"}