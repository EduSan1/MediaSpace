{"version":3,"file":"ensureWebSetup.js","names":["WEB_FEATURE_FLAG","hasChecked","disabledReason","ensureWebSupportSetupAsync","projectRoot","skipCache","Log","log","chalk","dim","result","shouldSetupWebSupportAsync","failureReason","ensureWebDependenciesInstalledAsync","exp","isWebPlatformExcluded","rootConfig","isWebExcluded","Array","isArray","expo","platforms","length","includes","boolish","projectConfig","getConfig","skipSDKVersionRequirement","configName","getProjectConfigDescriptionWithPaths","bold","requiredPackages","file","pkg","skipPrompt","program","nonInteractive","missing","getMissingPackagesAsync","readableMissingPackages","map","p","join","isYarn","PackageManager","isUsingYarn","title","Prompts","pauseInteractions","confirm","confirmAsync","message","wrapForTerminal","cyan","initial","resumeInteractions","packages","version","installPackagesAsync","installCommand","createInstallCommand","disableMessage","solution","reset","CommandError","wrapAnsi","process","stdout","columns","packageManager","createForProject","yarn","silent","isDebug","packagesStr","newLine","installingPackageStep","logNewSection","addAsync","e","fail","succeed"],"sources":["../../../../src/commands/utils/web/ensureWebSetup.ts"],"sourcesContent":["import {\n  AppJSONConfig,\n  ExpoConfig,\n  getConfig,\n  getProjectConfigDescriptionWithPaths,\n  ProjectConfig,\n} from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport program from 'commander';\nimport { boolish } from 'getenv';\nimport wrapAnsi from 'wrap-ansi';\nimport { Prompts } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport Log from '../../../log';\nimport { logNewSection } from '../../../utils/ora';\nimport { confirmAsync } from '../../../utils/prompts';\nimport { getMissingPackagesAsync } from './getMissingPackages';\n\nconst WEB_FEATURE_FLAG = 'EXPO_NO_WEB_SETUP';\n\n// Only check once per run.\nlet hasChecked = false;\nlet disabledReason = '';\n\nexport async function ensureWebSupportSetupAsync(\n  projectRoot: string,\n  { skipCache = false }: { skipCache?: boolean } = {}\n): Promise<boolean> {\n  if (!skipCache && hasChecked) {\n    if (disabledReason) {\n      Log.log(chalk.dim(disabledReason));\n    }\n    return false;\n  }\n  hasChecked = true;\n\n  const result = await shouldSetupWebSupportAsync(projectRoot);\n\n  if ('failureReason' in result) {\n    disabledReason = result.failureReason;\n    return ensureWebSupportSetupAsync(projectRoot);\n  }\n\n  // Ensure web packages are installed\n  await ensureWebDependenciesInstalledAsync(projectRoot, { exp: result.exp });\n\n  return true;\n}\n\nexport function isWebPlatformExcluded(rootConfig: AppJSONConfig): boolean {\n  // Detect if the 'web' string is purposefully missing from the platforms array.\n  const isWebExcluded =\n    Array.isArray(rootConfig.expo?.platforms) &&\n    !!rootConfig.expo?.platforms.length &&\n    !rootConfig.expo?.platforms.includes('web');\n  return isWebExcluded;\n}\n\nexport async function shouldSetupWebSupportAsync(\n  projectRoot: string\n): Promise<{ failureReason: string } | ProjectConfig> {\n  if (boolish(WEB_FEATURE_FLAG, false)) {\n    return { failureReason: '\\u203A Skipping web setup: EXPO_NO_WEB_SETUP is enabled.' };\n  }\n\n  const projectConfig = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  // Detect if the 'web' string is purposefully missing from the platforms array.\n  if (isWebPlatformExcluded(projectConfig.rootConfig)) {\n    // Get exact config description with paths.\n    const configName = getProjectConfigDescriptionWithPaths(projectRoot, projectConfig);\n    return {\n      failureReason: `\\u203A Skipping web setup: ${chalk.bold`\"web\"`} is not included in the project ${configName} ${chalk.bold`\"platforms\"`} array.`,\n    };\n  }\n\n  return projectConfig;\n}\n\nconst requiredPackages = [\n  // use react-native-web/package.json to skip node module cache issues when the user installs\n  // the package and attempts to resolve the module in the same process.\n  { file: 'react-native-web/package.json', pkg: 'react-native-web' },\n  { file: 'react-dom/package.json', pkg: 'react-dom' },\n];\n\nasync function ensureWebDependenciesInstalledAsync(\n  projectRoot: string,\n  {\n    exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp,\n    // Don't prompt in CI\n    skipPrompt = program.nonInteractive,\n  }: {\n    exp?: ExpoConfig;\n    skipPrompt?: boolean;\n  } = {}\n): Promise<boolean> {\n  const { missing } = await getMissingPackagesAsync(projectRoot, { exp, requiredPackages });\n  if (!missing.length) {\n    return true;\n  }\n\n  // Prompt to install or bail out...\n  const readableMissingPackages = missing.map(p => p.pkg).join(', ');\n\n  const isYarn = PackageManager.isUsingYarn(projectRoot);\n\n  let title = `It looks like you're trying to use web support but don't have the required dependencies installed.`;\n\n  if (skipPrompt) {\n    title += '\\n\\n';\n  } else {\n    Prompts.pauseInteractions();\n    let confirm: boolean;\n    try {\n      confirm = await confirmAsync({\n        message: wrapForTerminal(\n          title + ` Would you like to install ${chalk.cyan(readableMissingPackages)}?`\n        ),\n        initial: true,\n      });\n    } finally {\n      Prompts.resumeInteractions();\n    }\n\n    if (confirm) {\n      // Format with version if available.\n      const packages = missing.map(({ pkg, version }) =>\n        version ? [pkg, version].join('@') : pkg\n      );\n      // Install packages with versions\n      await installPackagesAsync(projectRoot, {\n        isYarn,\n        packages,\n      });\n      // Try again but skip prompting twice, simply fail if the packages didn't install correctly.\n      return await ensureWebDependenciesInstalledAsync(projectRoot, {\n        skipPrompt: true,\n      });\n    }\n\n    // Reset the title so it doesn't print twice in interactive mode.\n    title = '';\n  }\n\n  const installCommand = createInstallCommand({ isYarn, packages: missing });\n\n  const disableMessage = `If you're not using web, please remove the ${chalk.bold(\n    '\"web\"'\n  )} string from the platforms array in the project Expo config.`;\n\n  const solution = `Please install ${chalk.bold(\n    readableMissingPackages\n  )} by running:\\n\\n  ${chalk.reset.bold(installCommand)}\\n\\n`;\n\n  // Reset the cached check so we can re-run the check if the user re-runs the command.\n  hasChecked = false;\n  // This prevents users from starting a misconfigured JS or TS project by default.\n  throw new CommandError(wrapForTerminal(title + solution + disableMessage + '\\n'));\n}\n\n// Wrap long messages to fit smaller terminals.\nfunction wrapForTerminal(message: string): string {\n  return wrapAnsi(message, process.stdout.columns || 80);\n}\n\nexport function createInstallCommand({\n  isYarn,\n  packages,\n}: {\n  isYarn: boolean;\n  packages: {\n    file: string;\n    pkg: string;\n    version?: string | undefined;\n  }[];\n}) {\n  return (\n    (isYarn ? 'yarn add' : 'npm install') +\n    ' ' +\n    packages\n      .map(({ pkg, version }) => {\n        if (version) {\n          return [pkg, version].join('@');\n        }\n        return pkg;\n      })\n      .join(' ')\n  );\n}\n\nasync function installPackagesAsync(\n  projectRoot: string,\n  { isYarn, packages }: { isYarn: boolean; packages: string[] }\n) {\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    yarn: isYarn,\n    log: Log.log,\n    silent: !Log.isDebug,\n  });\n\n  const packagesStr = chalk.bold(packages.join(', '));\n  Log.newLine();\n  const installingPackageStep = logNewSection(`Installing ${packagesStr}`);\n  try {\n    await packageManager.addAsync(...packages);\n  } catch (e: any) {\n    installingPackageStep.fail(`Failed to install ${packagesStr} with error: ${e.message}`);\n    throw e;\n  }\n  installingPackageStep.succeed(`Installed ${packagesStr}`);\n}\n"],"mappings":"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"}