{"version":3,"file":"autoAddConfigPluginsAsync.js","names":["packageHasConfigPlugin","projectRoot","packageName","info","resolveConfigPluginFunctionWithInfo","isPluginFile","plugin","getNamedPlugins","plugins","namedPlugins","normal","normalizeStaticPlugin","push","autoPlugins","getAutoPlugins","autoAddConfigPluginsAsync","exp","packages","Log","debug","currentPlugins","normalized","join","filter","pkg","includes","length","attemptAddingPluginsAsync"],"sources":["../../../src/commands/utils/autoAddConfigPluginsAsync.ts"],"sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport {\n  normalizeStaticPlugin,\n  resolveConfigPluginFunctionWithInfo,\n} from '@expo/config-plugins/build/utils/plugin-resolver';\nimport { getAutoPlugins } from '@expo/prebuild-config';\n\nimport Log from '../../log';\nimport { attemptAddingPluginsAsync } from './modifyConfigAsync';\n\n/**\n * Resolve if a package has a config plugin.\n * For sanity, we'll only support config plugins that use the `app.config.js` entry file,\n * this is because a package like `lodash` could be a \"valid\" config plugin and break the prebuild process.\n *\n * @param projectRoot\n * @param packageName\n * @returns\n */\nfunction packageHasConfigPlugin(projectRoot: string, packageName: string) {\n  try {\n    const info = resolveConfigPluginFunctionWithInfo(projectRoot, packageName);\n    if (info.isPluginFile) {\n      return info.plugin;\n    }\n  } catch {}\n  return false;\n}\n\nexport function getNamedPlugins(plugins: NonNullable<ExpoConfig['plugins']>): string[] {\n  const namedPlugins = [];\n  for (const plugin of plugins) {\n    try {\n      // @ts-ignore\n      const [normal] = normalizeStaticPlugin(plugin);\n      if (typeof normal === 'string') {\n        namedPlugins.push(normal);\n      }\n    } catch {\n      // ignore assertions\n    }\n  }\n  return namedPlugins;\n}\n\nconst autoPlugins = getAutoPlugins();\n\nexport async function autoAddConfigPluginsAsync(\n  projectRoot: string,\n  exp: Pick<ExpoConfig, 'plugins'>,\n  packages: string[]\n) {\n  Log.debug('Checking config plugins...');\n\n  const currentPlugins = exp.plugins || [];\n  const normalized = getNamedPlugins(currentPlugins);\n\n  Log.debug(`Existing plugins: ${normalized.join(', ')}`);\n\n  const plugins = packages.filter(pkg => {\n    if (normalized.includes(pkg)) {\n      // already included in plugins array\n      return false;\n    }\n    // Check if the package has a valid plugin. Must be a well-made plugin for it to work with this.\n    const plugin = packageHasConfigPlugin(projectRoot, pkg);\n\n    Log.debug(\n      `Package \"${pkg}\" has plugin: ${!!plugin}` + (plugin ? ` (args: ${plugin.length})` : '')\n    );\n\n    if (autoPlugins.includes(pkg)) {\n      Log.debug(`Package \"${pkg}\" is an auto plugin, skipping...`);\n      return false;\n    }\n\n    return !!plugin;\n  });\n\n  await attemptAddingPluginsAsync(projectRoot, exp, plugins);\n}\n"],"mappings":";;;;;;;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAIA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAASA,sBAAT,CAAgCC,WAAhC,EAAqDC,WAArD,EAA0E;EACxE,IAAI;IACF,MAAMC,IAAI,GAAG,IAAAC,qDAAA,EAAoCH,WAApC,EAAiDC,WAAjD,CAAb;;IACA,IAAIC,IAAI,CAACE,YAAT,EAAuB;MACrB,OAAOF,IAAI,CAACG,MAAZ;IACD;EACF,CALD,CAKE,MAAM,CAAE;;EACV,OAAO,KAAP;AACD;;AAEM,SAASC,eAAT,CAAyBC,OAAzB,EAAgF;EACrF,MAAMC,YAAY,GAAG,EAArB;;EACA,KAAK,MAAMH,MAAX,IAAqBE,OAArB,EAA8B;IAC5B,IAAI;MACF;MACA,MAAM,CAACE,MAAD,IAAW,IAAAC,uCAAA,EAAsBL,MAAtB,CAAjB;;MACA,IAAI,OAAOI,MAAP,KAAkB,QAAtB,EAAgC;QAC9BD,YAAY,CAACG,IAAb,CAAkBF,MAAlB;MACD;IACF,CAND,CAME,MAAM,CACN;IACD;EACF;;EACD,OAAOD,YAAP;AACD;;AAED,MAAMI,WAAW,GAAG,IAAAC,gCAAA,GAApB;;AAEO,eAAeC,yBAAf,CACLd,WADK,EAELe,GAFK,EAGLC,QAHK,EAIL;EACAC,cAAA,CAAIC,KAAJ,CAAU,4BAAV;;EAEA,MAAMC,cAAc,GAAGJ,GAAG,CAACR,OAAJ,IAAe,EAAtC;EACA,MAAMa,UAAU,GAAGd,eAAe,CAACa,cAAD,CAAlC;;EAEAF,cAAA,CAAIC,KAAJ,CAAW,qBAAoBE,UAAU,CAACC,IAAX,CAAgB,IAAhB,CAAsB,EAArD;;EAEA,MAAMd,OAAO,GAAGS,QAAQ,CAACM,MAAT,CAAgBC,GAAG,IAAI;IACrC,IAAIH,UAAU,CAACI,QAAX,CAAoBD,GAApB,CAAJ,EAA8B;MAC5B;MACA,OAAO,KAAP;IACD,CAJoC,CAKrC;;;IACA,MAAMlB,MAAM,GAAGN,sBAAsB,CAACC,WAAD,EAAcuB,GAAd,CAArC;;IAEAN,cAAA,CAAIC,KAAJ,CACG,YAAWK,GAAI,iBAAgB,CAAC,CAAClB,MAAO,EAAzC,IAA8CA,MAAM,GAAI,WAAUA,MAAM,CAACoB,MAAO,GAA5B,GAAiC,EAArF,CADF;;IAIA,IAAIb,WAAW,CAACY,QAAZ,CAAqBD,GAArB,CAAJ,EAA+B;MAC7BN,cAAA,CAAIC,KAAJ,CAAW,YAAWK,GAAI,kCAA1B;;MACA,OAAO,KAAP;IACD;;IAED,OAAO,CAAC,CAAClB,MAAT;EACD,CAlBe,CAAhB;EAoBA,MAAM,IAAAqB,8CAAA,EAA0B1B,WAA1B,EAAuCe,GAAvC,EAA4CR,OAA5C,CAAN;AACD"}