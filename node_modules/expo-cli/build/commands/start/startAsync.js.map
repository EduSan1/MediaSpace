{"version":3,"file":"startAsync.js","names":["actionAsync","projectRoot","options","warnAboutLocalCLI","localCmd","Log","log","chalk","gray","installExitHooks","devClient","hasExpoInstalled","resolveFrom","silent","ConfigError","exp","pkg","profileMethod","getConfig","skipSDKVersionRequirement","webOnly","web","ensureWebSupportSetupAsync","track","urlOpts","optsAsync","rootPath","path","resolve","Versions","gteSdkVersion","ensureTypeScriptSetupAsync","validateDependenciesVersionsAsync","isLegacyImportsEnabled","assertProjectHasExpoExtensionFilesAsync","startOptions","parseStartOptions","LoadingPageHandler","setOnDeepLink","isDevClient","platform","StatusEventEmitter","once","UnifiedAnalytics","logEvent","status","getDevClientProperties","Project","startAsync","url","UrlUtils","constructDeepLinkAsync","catch","error","code","sendTo","recipient","getRecipient","sendUrlAsync","warn","handleMobileOptsAsync","isTerminalUIEnabled","nonInteractive","isDetached","TerminalUI","newLine","printQRCode","underline","nested","dim","installCustomExitHook","flush"],"sources":["../../../src/commands/start/startAsync.ts"],"sourcesContent":["import { ConfigError, ExpoConfig, getConfig, isLegacyImportsEnabled } from '@expo/config';\nimport chalk from 'chalk';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\nimport { LoadingPageHandler, Project, UnifiedAnalytics, UrlUtils, Versions } from 'xdl';\n\nimport StatusEventEmitter from '../../analytics/StatusEventEmitter';\nimport getDevClientProperties from '../../analytics/getDevClientProperties';\nimport Log from '../../log';\nimport { warnAboutLocalCLI } from '../../utils/migration';\nimport { assertProjectHasExpoExtensionFilesAsync } from '../utils/deprecatedExtensionWarnings';\nimport { profileMethod } from '../utils/profileMethod';\nimport * as sendTo from '../utils/sendTo';\nimport { ensureTypeScriptSetupAsync } from '../utils/typescript/ensureTypeScriptSetup';\nimport urlOpts from '../utils/urlOpts';\nimport { validateDependenciesVersionsAsync } from '../utils/validateDependenciesVersions';\nimport { ensureWebSupportSetupAsync } from '../utils/web/ensureWebSetup';\nimport * as TerminalUI from './TerminalUI';\nimport { installCustomExitHook, installExitHooks } from './installExitHooks';\nimport { NormalizedOptions, parseStartOptions } from './parseStartOptions';\n\nexport async function actionAsync(projectRoot: string, options: NormalizedOptions): Promise<void> {\n  warnAboutLocalCLI(projectRoot, { localCmd: 'start' });\n\n  Log.log(chalk.gray(`Starting project at ${projectRoot}`));\n\n  // Add clean up hooks\n  installExitHooks(projectRoot);\n\n  // Only validate expo in Expo Go contexts\n  if (!options.devClient) {\n    // Find expo binary in project/workspace node_modules\n    const hasExpoInstalled = resolveFrom.silent(projectRoot, 'expo');\n    if (!hasExpoInstalled) {\n      throw new ConfigError(\n        `Unable to find expo in this project - have you run yarn / npm install yet?`,\n        'MODULE_NOT_FOUND'\n      );\n    }\n  }\n\n  const { exp, pkg } = profileMethod(getConfig)(projectRoot, {\n    skipSDKVersionRequirement: options.webOnly || options.devClient,\n  });\n\n  if (options.web || options.webOnly) {\n    await ensureWebSupportSetupAsync(projectRoot);\n  }\n\n  if (options.devClient) {\n    track(projectRoot, exp);\n  }\n\n  // Assert various random things\n  // TODO: split up this method\n  await profileMethod(urlOpts.optsAsync)(projectRoot, options);\n\n  // TODO: This is useless on mac, check if useless on win32\n  const rootPath = path.resolve(projectRoot);\n\n  if (Versions.gteSdkVersion(exp, '34.0.0')) {\n    await profileMethod(ensureTypeScriptSetupAsync)(projectRoot);\n  }\n\n  if (!options.webOnly) {\n    // TODO: only validate dependencies if starting in managed workflow\n    await profileMethod(validateDependenciesVersionsAsync)(projectRoot, exp, pkg);\n    // Warn about expo extensions.\n    if (!isLegacyImportsEnabled(exp)) {\n      // Adds a few seconds in basic projects so we should\n      // drop this in favor of the upgrade version as soon as possible.\n      await profileMethod(assertProjectHasExpoExtensionFilesAsync)(projectRoot);\n    }\n  }\n\n  const startOptions = profileMethod(parseStartOptions)(options, exp);\n  LoadingPageHandler.setOnDeepLink(\n    async (projectRoot: string, isDevClient: boolean, platform: string | null) => {\n      if (!isDevClient) {\n        return;\n      }\n\n      const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n      StatusEventEmitter.once('deviceLogReceive', () => {\n        // Send the 'ready' event once the app is running in a device.\n        UnifiedAnalytics.logEvent('dev client start command', {\n          status: 'ready',\n          platform,\n          ...getDevClientProperties(projectRoot, exp),\n        });\n      });\n\n      UnifiedAnalytics.logEvent('dev client start command', {\n        status: 'started',\n        platform,\n        ...getDevClientProperties(projectRoot, exp),\n      });\n    }\n  );\n  await profileMethod(Project.startAsync)(rootPath, { ...startOptions, exp });\n\n  // Send to option...\n  const url = await profileMethod(\n    UrlUtils.constructDeepLinkAsync,\n    'UrlUtils.constructDeepLinkAsync'\n  )(projectRoot).catch(error => {\n    // TODO: Maybe there's a better way to do this\n    if (!options.devClient || error.code !== 'NO_DEV_CLIENT_SCHEME') {\n      throw error;\n    }\n    return null;\n  });\n\n  if (options.sendTo) {\n    if (url) {\n      const recipient = await profileMethod(sendTo.getRecipient)(options.sendTo);\n      if (recipient) {\n        await sendTo.sendUrlAsync(url, recipient);\n      }\n    } else {\n      Log.warn('Cannot send URL because the linking URI cannot be resolved');\n    }\n  }\n\n  // Open project on devices.\n  await profileMethod(urlOpts.handleMobileOptsAsync)(projectRoot, options);\n\n  // Present the Terminal UI.\n  const isTerminalUIEnabled = !options.nonInteractive && !exp.isDetached;\n\n  if (isTerminalUIEnabled) {\n    await profileMethod(TerminalUI.startAsync, 'TerminalUI.startAsync')(projectRoot, startOptions);\n  } else if (url) {\n    if (!exp.isDetached) {\n      Log.newLine();\n      urlOpts.printQRCode(url);\n    }\n    Log.log(`Your native app is running at ${chalk.underline(url)}`);\n  }\n\n  // Final note about closing the server.\n  if (!options.webOnly) {\n    Log.nested(`Logs for your project will appear below. ${chalk.dim(`Press Ctrl+C to exit.`)}`);\n  } else {\n    Log.nested(\n      `\\nLogs for your project will appear in the browser console. ${chalk.dim(\n        `Press Ctrl+C to exit.`\n      )}`\n    );\n  }\n  if (options.devClient) {\n    UnifiedAnalytics.logEvent('dev client start command', {\n      status: 'ready',\n      ...getDevClientProperties(projectRoot, exp),\n    });\n  }\n}\n\nfunction track(projectRoot: string, exp: ExpoConfig) {\n  UnifiedAnalytics.logEvent('dev client start command', {\n    status: 'started',\n    ...getDevClientProperties(projectRoot, exp),\n  });\n  installCustomExitHook(() => {\n    UnifiedAnalytics.logEvent('dev client start command', {\n      status: 'finished',\n      ...getDevClientProperties(projectRoot, exp),\n    });\n    UnifiedAnalytics.flush();\n  });\n}\n"],"mappings":"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"}