{"version":3,"file":"parseStartOptions.js","names":["hasBooleanArg","rawArgs","argName","includes","getBooleanArg","setBooleanArg","fallback","warnUsingDeprecatedArgs","deprecatedArgs","arg","message","Log","warn","chalk","bold","normalizeOptionsAsync","projectRoot","options","parent","opts","parseRawArguments","webOnly","webpackPort","resolvePortAsync","defaultPort","port","fallbackPort","WebpackEnvironment","DEFAULT_PORT","AbortCommandError","metroPort","devClient","cacheOptionsAsync","nonInteractive","dev","minify","https","android","ios","web","localhost","lan","tunnel","ProjectSettings","setAsync","scheme","parseStartOptions","exp","startOpts","platforms","clear","reset","maxWorkers","forceManifestType","undefined","easUpdatesUrlRegex","updatesUrl","updates","url","isEasUpdatesUrl","test","isLegacyImportsEnabled","target","debug","Versions","lteSdkVersion","isRemoteReloadingEnabled","Webpack","isTargetingNative","isWebSocketsEnabled"],"sources":["../../../src/commands/start/parseStartOptions.ts"],"sourcesContent":["import { ExpoConfig, isLegacyImportsEnabled } from '@expo/config';\nimport chalk from 'chalk';\nimport { Project, ProjectSettings, Versions, Webpack } from 'xdl';\nimport * as WebpackEnvironment from 'xdl/build/webpack-utils/WebpackEnvironment';\n\nimport { AbortCommandError } from '../../CommandError';\nimport Log from '../../log';\nimport { resolvePortAsync } from '../run/utils/resolvePortAsync';\nimport { URLOptions } from '../utils/urlOpts';\n\nexport type NormalizedOptions = URLOptions & {\n  webOnly?: boolean;\n  dev?: boolean;\n  minify?: boolean;\n  https?: boolean;\n  nonInteractive?: boolean;\n  clear?: boolean;\n  maxWorkers?: number;\n  sendTo?: string;\n  host?: string;\n  lan?: boolean;\n  localhost?: boolean;\n  tunnel?: boolean;\n  metroPort?: number;\n  webpackPort?: number;\n  forceManifestType?: string;\n};\n\nexport type RawStartOptions = NormalizedOptions & {\n  port?: number;\n  parent?: { nonInteractive: boolean; rawArgs: string[] };\n};\n\nfunction hasBooleanArg(rawArgs: string[], argName: string): boolean {\n  return rawArgs.includes('--' + argName) || rawArgs.includes('--no-' + argName);\n}\n\nfunction getBooleanArg(rawArgs: string[], argName: string): boolean {\n  if (rawArgs.includes('--' + argName)) {\n    return true;\n  } else {\n    return false;\n  }\n}\n\nexport function setBooleanArg(\n  argName: string,\n  rawArgs: string[],\n  fallback?: boolean\n): boolean | undefined {\n  if (rawArgs.includes(`--${argName}`)) {\n    return true;\n  } else if (rawArgs.includes(`--no-${argName}`)) {\n    return false;\n  } else {\n    return fallback;\n  }\n}\n\n// TODO: Deprecate these features sometime around the versioned migration.\nfunction warnUsingDeprecatedArgs(rawArgs: string[]) {\n  const deprecatedArgs = [\n    ['--no-https', 'Https is disabled by default.'],\n    ['--no-minify', 'Minify is disabled by default.'],\n    ['--dev', 'Dev is enabled by default.'],\n  ];\n\n  for (const [arg, message] of deprecatedArgs) {\n    if (rawArgs.includes(arg)) {\n      Log.warn(`\\u203A The ${chalk.bold(arg)} flag is deprecated. ${message}`);\n    }\n  }\n}\n\n// The main purpose of this function is to take existing options object and\n// support boolean args with as defined in the hasBooleanArg and getBooleanArg\n// functions.\nexport async function normalizeOptionsAsync(\n  projectRoot: string,\n  options: RawStartOptions\n): Promise<NormalizedOptions> {\n  const rawArgs = options.parent?.rawArgs || [];\n  warnUsingDeprecatedArgs(rawArgs);\n  const opts = parseRawArguments(options, rawArgs);\n\n  if (options.webOnly) {\n    const webpackPort = await resolvePortAsync(projectRoot, {\n      defaultPort: options.port,\n      fallbackPort: WebpackEnvironment.DEFAULT_PORT,\n    });\n    if (!webpackPort) {\n      throw new AbortCommandError();\n    }\n    opts.webpackPort = webpackPort;\n  } else {\n    const metroPort = await resolvePortAsync(projectRoot, {\n      defaultPort: options.port,\n      fallbackPort: options.devClient ? 8081 : 19000,\n    });\n    if (!metroPort) {\n      throw new AbortCommandError();\n    }\n    opts.metroPort = metroPort;\n  }\n\n  // Side-effect\n  await cacheOptionsAsync(projectRoot, opts);\n\n  return opts;\n}\n\n// The main purpose of this function is to take existing options object and\n// support boolean args with as defined in the hasBooleanArg and getBooleanArg\n// functions.\nexport function parseRawArguments(options: RawStartOptions, rawArgs: string[]): NormalizedOptions {\n  const opts: NormalizedOptions = {\n    ...options, // This is necessary to ensure we don't drop any options\n    webOnly: !!options.webOnly, // This is only ever true in the start:web command\n    nonInteractive: options.parent?.nonInteractive,\n    // setBooleanArg is used to flip the default commander logic which automatically sets a value to `true` if the inverse option isn't provided.\n    // ex: `dev == true` if `--no-dev` is a possible flag, but `--no-dev` was not provided in the command.\n    dev: setBooleanArg('dev', rawArgs, true),\n    minify: setBooleanArg('minify', rawArgs, false),\n    https: setBooleanArg('https', rawArgs, false),\n  };\n\n  if (hasBooleanArg(rawArgs, 'android')) {\n    opts.android = getBooleanArg(rawArgs, 'android');\n  }\n\n  if (hasBooleanArg(rawArgs, 'ios')) {\n    opts.ios = getBooleanArg(rawArgs, 'ios');\n  }\n\n  if (hasBooleanArg(rawArgs, 'web')) {\n    opts.web = getBooleanArg(rawArgs, 'web');\n  }\n\n  if (hasBooleanArg(rawArgs, 'localhost')) {\n    opts.localhost = getBooleanArg(rawArgs, 'localhost');\n  }\n\n  if (hasBooleanArg(rawArgs, 'lan')) {\n    opts.lan = getBooleanArg(rawArgs, 'lan');\n  }\n\n  if (hasBooleanArg(rawArgs, 'tunnel')) {\n    opts.tunnel = getBooleanArg(rawArgs, 'tunnel');\n  }\n\n  return opts;\n}\n\nasync function cacheOptionsAsync(projectRoot: string, options: NormalizedOptions): Promise<void> {\n  await ProjectSettings.setAsync(projectRoot, {\n    devClient: options.devClient,\n    scheme: options.scheme,\n    dev: options.dev,\n    minify: options.minify,\n    https: options.https,\n  });\n}\n\nexport function parseStartOptions(\n  options: NormalizedOptions,\n  exp: ExpoConfig\n): Project.StartOptions {\n  const startOpts: Project.StartOptions = {\n    metroPort: options.metroPort,\n    webpackPort: options.webpackPort,\n    platforms: exp.platforms ?? ['ios', 'android', 'web'],\n  };\n\n  if (options.clear) {\n    startOpts.reset = true;\n  }\n\n  if (options.nonInteractive) {\n    startOpts.nonInteractive = true;\n  }\n\n  if (options.webOnly) {\n    startOpts.webOnly = true;\n  }\n\n  if (options.maxWorkers) {\n    startOpts.maxWorkers = options.maxWorkers;\n  }\n\n  if (options.devClient) {\n    startOpts.devClient = true;\n  }\n\n  if (options.forceManifestType) {\n    startOpts.forceManifestType =\n      options.forceManifestType === 'classic'\n        ? 'classic'\n        : options.forceManifestType === 'expo-updates'\n        ? 'expo-updates'\n        : undefined;\n  } else {\n    const easUpdatesUrlRegex = /^https:\\/\\/(staging-)?u\\.expo\\.dev/;\n    const updatesUrl = exp.updates?.url;\n    const isEasUpdatesUrl = updatesUrl && easUpdatesUrlRegex.test(updatesUrl);\n\n    startOpts.forceManifestType = isEasUpdatesUrl ? 'expo-updates' : 'classic';\n  }\n\n  if (isLegacyImportsEnabled(exp)) {\n    // For `expo start`, the default target is 'managed', for both managed *and* bare apps.\n    // See: https://docs.expo.dev/bare/using-expo-client\n    startOpts.target = options.devClient ? 'bare' : 'managed';\n    Log.debug('Using target: ', startOpts.target);\n  }\n\n  // The SDK 41 client has web socket support.\n  if (!Versions.lteSdkVersion(exp, '40.0.0')) {\n    startOpts.isRemoteReloadingEnabled = true;\n    if (!startOpts.webOnly || Webpack.isTargetingNative()) {\n      startOpts.isWebSocketsEnabled = true;\n    }\n  }\n\n  return startOpts;\n}\n"],"mappings":"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"}