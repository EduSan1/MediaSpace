{"version":3,"file":"startBuildAsync.js","names":["validateOptions","options","schema","Joi","object","keys","current","boolean","mode","string","platform","any","valid","expIds","array","type","releaseChannel","regex","bundleIdentifier","publicUrl","sdkVersion","strict","error","validate","XDLError","toString","getConfigAsync","projectRoot","exp","pkg","getConfig","configName","configFilename","configPrefix","ThirdParty","getManifest","getExpAsync","version","name","slug","toLowerCase","startBuildAsync","user","UserManager","ensureLoggedInAsync","validateManifest","Analytics","logEvent","developerTool","Config","api","ApiV2","clientForUser","putAsync","manifest","ios","android","package"],"sources":["../../../src/commands/build/startBuildAsync.ts"],"sourcesContent":["import { configFilename, getConfig } from '@expo/config';\nimport Joi from 'joi';\nimport slug from 'slugify';\nimport { Analytics, ApiV2, Config, ThirdParty, UserManager, XDLError } from 'xdl';\n\nexport type BuildCreatedResult = {\n  id: string;\n  ids: string[];\n  priority: 'normal' | 'high';\n  canPurchasePriorityBuilds: boolean;\n  numberOfRemainingPriorityBuilds: number;\n  hasUnlimitedPriorityBuilds: boolean;\n};\n\nexport type GetExpConfigOptions = {\n  current?: boolean;\n  mode?: string;\n  platform?: 'android' | 'ios' | 'all';\n  expIds?: string[];\n  type?: string;\n  releaseChannel?: string;\n  bundleIdentifier?: string;\n  publicUrl?: string;\n  sdkVersion?: string;\n};\n\nexport function validateOptions(options: any) {\n  const schema = Joi.object().keys({\n    current: Joi.boolean(),\n    mode: Joi.string(),\n    platform: Joi.any().valid('ios', 'android', 'all'),\n    expIds: Joi.array(),\n    type: Joi.any().valid('archive', 'simulator', 'client', 'app-bundle', 'apk'),\n    releaseChannel: Joi.string().regex(/[a-z\\d][a-z\\d._-]*/),\n    bundleIdentifier: Joi.string().regex(/^[a-zA-Z0-9-.]+$/),\n    publicUrl: Joi.string(),\n    sdkVersion: Joi.string().strict(),\n  });\n\n  const { error } = schema.validate(options);\n  if (error) {\n    throw new XDLError('INVALID_OPTIONS', error.toString());\n  }\n}\n\nasync function getConfigAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'platform'> = {}\n) {\n  if (!options.publicUrl) {\n    // get the manifest from the project directory\n    const { exp, pkg } = getConfig(projectRoot);\n    const configName = configFilename(projectRoot);\n    return {\n      exp,\n      pkg,\n      configName: configFilename(projectRoot),\n      configPrefix: configName === 'app.json' ? 'expo.' : '',\n    };\n  } else {\n    // get the externally hosted manifest\n    return {\n      exp: await ThirdParty.getManifest(options.publicUrl, options),\n      configName: options.publicUrl,\n      configPrefix: '',\n      pkg: {},\n    };\n  }\n}\n\nexport async function getExpAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'mode' | 'platform'>\n) {\n  const { exp, pkg, configName, configPrefix } = await getConfigAsync(projectRoot, options);\n\n  if (!exp || !pkg) {\n    throw new XDLError(\n      'NO_PACKAGE_JSON',\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && 'version' in pkg && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.name && 'name' in pkg && typeof pkg.name === 'string') {\n    exp.name = pkg.name;\n  }\n  if (!exp.slug && typeof exp.name === 'string') {\n    exp.slug = slug(exp.name.toLowerCase());\n  }\n  return { exp, configName, configPrefix };\n}\n\nexport async function startBuildAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildCreatedResult> {\n  const user = await UserManager.ensureLoggedInAsync();\n\n  validateOptions(options);\n  const { exp, configName, configPrefix } = await getExpAsync(projectRoot, options);\n  validateManifest(options, exp, configName, configPrefix);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    platform: options.platform,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  return await api.putAsync('build/start', { manifest: exp, options });\n}\n\nfunction validateManifest(options: any, exp: any, configName: string, configPrefix: string) {\n  if (options.platform === 'ios' || options.platform === 'all') {\n    if (!exp.ios || !exp.ios.bundleIdentifier) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a bundle identifier in order to build this experience for iOS. ` +\n          `Please specify one in ${configName} at \"${configPrefix}ios.bundleIdentifier\"`\n      );\n    }\n  }\n\n  if (options.platform === 'android' || options.platform === 'all') {\n    if (!exp.android || !exp.android.package) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a java package in order to build this experience for Android. ` +\n          `Please specify one in ${configName} at \"${configPrefix}android.package\"`\n      );\n    }\n  }\n}\n"],"mappings":"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"}