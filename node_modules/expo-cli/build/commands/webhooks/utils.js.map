{"version":3,"file":"utils.js","names":["SECRET_MIN_LENGTH","SECRET_MAX_LENGTH","validateSecret","secret","assert","length","generateSecret","randomSecret","crypto","randomBytes","toString","Log","log","chalk","underline","setupAsync","projectRoot","exp","getConfig","skipSDKVersionRequirement","slug","CommandError","ErrorCodes","MISSING_SLUG","findConfigFile","configName","user","UserManager","ensureLoggedInAsync","client","ApiV2","clientForUser","experienceName","owner","username","projects","getAsync","projectNotFoundError","project","error","code","PROJECT_NOT_FOUND"],"sources":["../../../src/commands/webhooks/utils.ts"],"sourcesContent":["import { findConfigFile, getConfig } from '@expo/config';\nimport assert from 'assert';\nimport chalk from 'chalk';\nimport crypto from 'crypto';\nimport { ApiV2, UserManager } from 'xdl';\n\nimport CommandError, { ErrorCodes } from '../../CommandError';\nimport Log from '../../log';\n\nconst SECRET_MIN_LENGTH = 16;\nconst SECRET_MAX_LENGTH = 1000;\n\nexport type WebhookEvent = 'build';\n\nexport function validateSecret({ secret }: { secret?: string }): string | null {\n  if (secret) {\n    assert(\n      secret.length >= SECRET_MIN_LENGTH && secret.length < SECRET_MAX_LENGTH,\n      `--secret: should be ${SECRET_MIN_LENGTH}-${SECRET_MAX_LENGTH} characters long`\n    );\n    return secret;\n  }\n  return null;\n}\n\nexport function generateSecret() {\n  // Create a 60 characters long secret from 30 random bytes.\n  const randomSecret = crypto.randomBytes(30).toString('hex');\n  Log.log(chalk.underline('Webhook signing secret:'));\n  Log.log(randomSecret);\n  return randomSecret;\n}\n\nexport async function setupAsync(projectRoot: string) {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const { slug } = exp;\n  if (!slug) {\n    throw new CommandError(\n      ErrorCodes.MISSING_SLUG,\n      `expo.slug is not defined in ${findConfigFile(projectRoot).configName}`\n    );\n  }\n  const user = await UserManager.ensureLoggedInAsync();\n  const client = ApiV2.clientForUser(user);\n  const experienceName = `@${exp.owner ?? user.username}/${exp.slug}`;\n  try {\n    const projects = await client.getAsync('projects', {\n      experienceName,\n    });\n    if (projects.length === 0) {\n      throw projectNotFoundError(experienceName);\n    }\n    const project = projects[0];\n    return { experienceName, project, client };\n  } catch (error: any) {\n    if (error.code === 'EXPERIENCE_NOT_FOUND') {\n      throw projectNotFoundError(experienceName);\n    } else {\n      throw error;\n    }\n  }\n}\n\nfunction projectNotFoundError(experienceName: string) {\n  return new CommandError(\n    ErrorCodes.PROJECT_NOT_FOUND,\n    `Project ${experienceName} not found. The project is created the first time you run \\`expo publish\\` or build the project (https://docs.expo.dev/distribution/building-standalone-apps/).`\n  );\n}\n"],"mappings":";;;;;;;;;AAAA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;;;;;AAEA,MAAMA,iBAAiB,GAAG,EAA1B;AACA,MAAMC,iBAAiB,GAAG,IAA1B;;AAIO,SAASC,cAAT,CAAwB;EAAEC;AAAF,CAAxB,EAAwE;EAC7E,IAAIA,MAAJ,EAAY;IACV,IAAAC,iBAAA,EACED,MAAM,CAACE,MAAP,IAAiBL,iBAAjB,IAAsCG,MAAM,CAACE,MAAP,GAAgBJ,iBADxD,EAEG,uBAAsBD,iBAAkB,IAAGC,iBAAkB,kBAFhE;IAIA,OAAOE,MAAP;EACD;;EACD,OAAO,IAAP;AACD;;AAEM,SAASG,cAAT,GAA0B;EAC/B;EACA,MAAMC,YAAY,GAAGC,iBAAA,CAAOC,WAAP,CAAmB,EAAnB,EAAuBC,QAAvB,CAAgC,KAAhC,CAArB;;EACAC,cAAA,CAAIC,GAAJ,CAAQC,gBAAA,CAAMC,SAAN,CAAgB,yBAAhB,CAAR;;EACAH,cAAA,CAAIC,GAAJ,CAAQL,YAAR;;EACA,OAAOA,YAAP;AACD;;AAEM,eAAeQ,UAAf,CAA0BC,WAA1B,EAA+C;EAAA;;EACpD,MAAM;IAAEC;EAAF,IAAU,IAAAC,mBAAA,EAAUF,WAAV,EAAuB;IAAEG,yBAAyB,EAAE;EAA7B,CAAvB,CAAhB;EACA,MAAM;IAAEC;EAAF,IAAWH,GAAjB;;EACA,IAAI,CAACG,IAAL,EAAW;IACT,MAAM,KAAIC,uBAAJ,EACJC,0BAAA,CAAWC,YADP,EAEH,+BAA8B,IAAAC,wBAAA,EAAeR,WAAf,EAA4BS,UAAW,EAFlE,CAAN;EAID;;EACD,MAAMC,IAAI,GAAG,MAAMC,kBAAA,CAAYC,mBAAZ,EAAnB;;EACA,MAAMC,MAAM,GAAGC,YAAA,CAAMC,aAAN,CAAoBL,IAApB,CAAf;;EACA,MAAMM,cAAc,GAAI,IAAD,cAAIf,GAAG,CAACgB,KAAR,mDAAiBP,IAAI,CAACQ,QAAS,IAAGjB,GAAG,CAACG,IAAK,EAAlE;;EACA,IAAI;IACF,MAAMe,QAAQ,GAAG,MAAMN,MAAM,CAACO,QAAP,CAAgB,UAAhB,EAA4B;MACjDJ;IADiD,CAA5B,CAAvB;;IAGA,IAAIG,QAAQ,CAAC9B,MAAT,KAAoB,CAAxB,EAA2B;MACzB,MAAMgC,oBAAoB,CAACL,cAAD,CAA1B;IACD;;IACD,MAAMM,OAAO,GAAGH,QAAQ,CAAC,CAAD,CAAxB;IACA,OAAO;MAAEH,cAAF;MAAkBM,OAAlB;MAA2BT;IAA3B,CAAP;EACD,CATD,CASE,OAAOU,KAAP,EAAmB;IACnB,IAAIA,KAAK,CAACC,IAAN,KAAe,sBAAnB,EAA2C;MACzC,MAAMH,oBAAoB,CAACL,cAAD,CAA1B;IACD,CAFD,MAEO;MACL,MAAMO,KAAN;IACD;EACF;AACF;;AAED,SAASF,oBAAT,CAA8BL,cAA9B,EAAsD;EACpD,OAAO,KAAIX,uBAAJ,EACLC,0BAAA,CAAWmB,iBADN,EAEJ,WAAUT,cAAe,iKAFrB,CAAP;AAID"}