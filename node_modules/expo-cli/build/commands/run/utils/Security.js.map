{"version":3,"file":"Security.js","names":["assertInstalledAsync","spawnAsync","CommandError","getCertificateForSigningIdAsync","id","pem","stdout","trim","forge","pki","certificateFromPem","findIdentitiesAsync","results","parsed","split","map","line","extractCodeSigningInfo","filter","Boolean","Set","value","match","resolveIdentitiesAsync","identities","values","extractSigningId","Promise","all","signingCertificateId","resolveCertificateSigningInfoAsync","certificate","codeSigningInfo","subject","getField","appleTeamName","appleTeamId"],"sources":["../../../../src/commands/run/utils/Security.ts"],"sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport forge from 'node-forge';\n\nimport CommandError from '../../../CommandError';\n\nexport type CertificateSigningInfo = {\n  /**\n   * @example 'AA00AABB0A'\n   */\n  signingCertificateId: string;\n  /**\n   * @example 'Apple Development: Evan Bacon (AA00AABB0A)'\n   */\n  codeSigningInfo?: string;\n  /**\n   * @example '650 Industries, Inc.'\n   */\n  appleTeamName?: string;\n  /**\n   * @example 'A1BCDEF234'\n   */\n  appleTeamId?: string;\n};\n\nexport async function assertInstalledAsync() {\n  try {\n    await spawnAsync('which', ['security']);\n  } catch {\n    throw new CommandError(\n      \"Cannot code sign project because the CLI `security` is not available on your computer.\\nPlease ensure it's installed and try again.\"\n    );\n  }\n}\n\nexport async function getCertificateForSigningIdAsync(id: string): Promise<forge.pki.Certificate> {\n  const pem = (await spawnAsync('security', ['find-certificate', '-c', id, '-p'])).stdout?.trim?.();\n  if (!pem) {\n    throw new CommandError(\n      `Failed to get PEM certificate for ID \"${id}\" using the \\`security\\` CLI`\n    );\n  }\n  return forge.pki.certificateFromPem(pem);\n}\n\nexport async function findIdentitiesAsync(): Promise<string[]> {\n  const results = (\n    await spawnAsync('security', ['find-identity', '-p', 'codesigning', '-v'])\n  ).stdout.trim?.();\n  // Returns a string like:\n  // 1) 12222234253761286351826735HGKDHAJGF45283 \"Apple Development: Evan Bacon (AA00AABB0A)\" (CSSMERR_TP_CERT_REVOKED)\n  // 2) 12312234253761286351826735HGKDHAJGF45283 \"Apple Development: bacon@expo.io (BB00AABB0A)\"\n  // 3) 12442234253761286351826735HGKDHAJGF45283 \"iPhone Distribution: Evan Bacon (CC00AABB0B)\" (CSSMERR_TP_CERT_REVOKED)\n  // 4) 15672234253761286351826735HGKDHAJGF45283 \"Apple Development: Evan Bacon (AA00AABB0A)\"\n  //  4 valid identities found\n\n  const parsed = results\n    .split('\\n')\n    .map(line => extractCodeSigningInfo(line))\n    .filter(Boolean) as string[];\n\n  // Remove duplicates\n  return [...new Set(parsed)];\n}\n\n/**\n * @param value '  2) 12312234253761286351826735HGKDHAJGF45283 \"Apple Development: bacon@expo.io (BB00AABB0A)\"'\n * @returns 'Apple Development: Evan Bacon (PH75MDXG4H)'\n */\nexport function extractCodeSigningInfo(value: string): string | null {\n  return value.match(/^\\s*\\d+\\).+\"(.+Develop(ment|er).+)\"$/)?.[1] ?? null;\n}\n\nexport async function resolveIdentitiesAsync(\n  identities: string[]\n): Promise<CertificateSigningInfo[]> {\n  const values = identities.map(extractSigningId).filter(Boolean) as string[];\n  return await Promise.all(\n    values.map(signingCertificateId => resolveCertificateSigningInfoAsync(signingCertificateId))\n  );\n}\n\nexport async function resolveCertificateSigningInfoAsync(\n  signingCertificateId: string\n): Promise<CertificateSigningInfo> {\n  const certificate = await getCertificateForSigningIdAsync(signingCertificateId);\n  return {\n    signingCertificateId,\n    codeSigningInfo: certificate.subject.getField('CN')?.value,\n    appleTeamName: certificate.subject.getField('O')?.value,\n    appleTeamId: certificate.subject.getField('OU')?.value,\n  };\n}\n\n/**\n * @param codeSigningInfo 'Apple Development: Evan Bacon (AA00AABB0A)'\n * @returns 'AA00AABB0A'\n */\nexport function extractSigningId(codeSigningInfo: string): string | null {\n  return codeSigningInfo.match(/.*\\(([a-zA-Z0-9]+)\\)/)?.[1] ?? null;\n}\n"],"mappings":";;;;;;;;;;;;;AAAA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;AAqBO,eAAeA,oBAAf,GAAsC;EAC3C,IAAI;IACF,MAAM,IAAAC,qBAAA,EAAW,OAAX,EAAoB,CAAC,UAAD,CAApB,CAAN;EACD,CAFD,CAEE,MAAM;IACN,MAAM,KAAIC,uBAAJ,EACJ,qIADI,CAAN;EAGD;AACF;;AAEM,eAAeC,+BAAf,CAA+CC,EAA/C,EAA2F;EAAA;;EAChG,MAAMC,GAAG,4BAAG,CAAC,MAAM,IAAAJ,qBAAA,EAAW,UAAX,EAAuB,CAAC,kBAAD,EAAqB,IAArB,EAA2BG,EAA3B,EAA+B,IAA/B,CAAvB,CAAP,EAAqEE,MAAxE,oFAAG,sBAA6EC,IAAhF,2DAAG,kDAAZ;;EACA,IAAI,CAACF,GAAL,EAAU;IACR,MAAM,KAAIH,uBAAJ,EACH,yCAAwCE,EAAG,8BADxC,CAAN;EAGD;;EACD,OAAOI,oBAAA,CAAMC,GAAN,CAAUC,kBAAV,CAA6BL,GAA7B,CAAP;AACD;;AAEM,eAAeM,mBAAf,GAAwD;EAAA;;EAC7D,MAAMC,OAAO,6BAAG,2BACd,MAAM,IAAAX,qBAAA,EAAW,UAAX,EAAuB,CAAC,eAAD,EAAkB,IAAlB,EAAwB,aAAxB,EAAuC,IAAvC,CAAvB,CADQ,EAEdK,MAFc,EAEPC,IAFI,2DAAG,mDAAhB,CAD6D,CAI7D;EACA;EACA;EACA;EACA;EACA;;EAEA,MAAMM,MAAM,GAAGD,OAAO,CACnBE,KADY,CACN,IADM,EAEZC,GAFY,CAERC,IAAI,IAAIC,sBAAsB,CAACD,IAAD,CAFtB,EAGZE,MAHY,CAGLC,OAHK,CAAf,CAX6D,CAgB7D;;EACA,OAAO,CAAC,GAAG,IAAIC,GAAJ,CAAQP,MAAR,CAAJ,CAAP;AACD;AAED;AACA;AACA;AACA;;;AACO,SAASI,sBAAT,CAAgCI,KAAhC,EAA8D;EAAA;;EACnE,wCAAOA,KAAK,CAACC,KAAN,CAAY,sCAAZ,CAAP,iDAAO,aAAsD,CAAtD,CAAP,yDAAmE,IAAnE;AACD;;AAEM,eAAeC,sBAAf,CACLC,UADK,EAE8B;EACnC,MAAMC,MAAM,GAAGD,UAAU,CAACT,GAAX,CAAeW,gBAAf,EAAiCR,MAAjC,CAAwCC,OAAxC,CAAf;EACA,OAAO,MAAMQ,OAAO,CAACC,GAAR,CACXH,MAAM,CAACV,GAAP,CAAWc,oBAAoB,IAAIC,kCAAkC,CAACD,oBAAD,CAArE,CADW,CAAb;AAGD;;AAEM,eAAeC,kCAAf,CACLD,oBADK,EAE4B;EAAA;;EACjC,MAAME,WAAW,GAAG,MAAM5B,+BAA+B,CAAC0B,oBAAD,CAAzD;EACA,OAAO;IACLA,oBADK;IAELG,eAAe,2BAAED,WAAW,CAACE,OAAZ,CAAoBC,QAApB,CAA6B,IAA7B,CAAF,0DAAE,sBAAoCb,KAFhD;IAGLc,aAAa,4BAAEJ,WAAW,CAACE,OAAZ,CAAoBC,QAApB,CAA6B,GAA7B,CAAF,2DAAE,uBAAmCb,KAH7C;IAILe,WAAW,4BAAEL,WAAW,CAACE,OAAZ,CAAoBC,QAApB,CAA6B,IAA7B,CAAF,2DAAE,uBAAoCb;EAJ5C,CAAP;AAMD;AAED;AACA;AACA;AACA;;;AACO,SAASK,gBAAT,CAA0BM,eAA1B,EAAkE;EAAA;;EACvE,0DAAOA,eAAe,CAACV,KAAhB,CAAsB,sBAAtB,CAAP,2DAAO,uBAAgD,CAAhD,CAAP,yEAA6D,IAA7D;AACD"}