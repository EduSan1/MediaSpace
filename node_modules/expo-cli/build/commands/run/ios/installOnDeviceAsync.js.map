{"version":3,"file":"installOnDeviceAsync.js","names":["getAppDeltaDirectory","bundleId","deltaFolder","path","join","os","tmpdir","fs","ensureDirSync","installOnDeviceAsync","props","AppleDevice","isEnabled","IOSDeploy","bundle","bundleIdentifier","appDeltaDirectory","udid","deviceName","indicator","runOnDevice","appPath","waitForApp","deltaPath","onProgress","status","isComplete","progress","ora","start","text","chalk","bold","succeed","err","fail","code","appName","basename","split","program","nonInteractive","Prompts","confirmAsync","message","initial","CommandError"],"sources":["../../../../src/commands/run/ios/installOnDeviceAsync.ts"],"sourcesContent":["import chalk from 'chalk';\nimport program from 'commander';\nimport fs from 'fs-extra';\nimport { Ora } from 'ora';\nimport os from 'os';\nimport path from 'path';\nimport { AppleDevice, Prompts } from 'xdl';\n\nimport CommandError from '../../../CommandError';\nimport { ora } from '../../../utils/ora';\nimport * as IOSDeploy from './IOSDeploy';\n\n/**\n * Get the app_delta folder for faster subsequent rebuilds on devices.\n *\n * @param bundleId\n * @returns\n */\nexport function getAppDeltaDirectory(bundleId: string): string {\n  // TODO: Maybe use .expo folder instead for debugging\n  // TODO: Reuse existing folder from xcode?\n  const deltaFolder = path.join(os.tmpdir(), 'ios', 'app-delta', bundleId);\n  fs.ensureDirSync(deltaFolder);\n  return deltaFolder;\n}\n\n// To debug: `export DEBUG=expo:xdl:*`\nexport async function installOnDeviceAsync(props: {\n  bundle: string;\n  bundleIdentifier: string;\n  appDeltaDirectory: string;\n  udid: string;\n  deviceName: string;\n}): Promise<void> {\n  if (!AppleDevice.isEnabled()) {\n    return await IOSDeploy.installOnDeviceAsync(props);\n  }\n\n  const { bundle, bundleIdentifier, appDeltaDirectory, udid, deviceName } = props;\n  let indicator: Ora | undefined;\n\n  try {\n    // TODO: Connect for logs\n    await AppleDevice.runOnDevice({\n      udid,\n      appPath: bundle,\n      bundleId: bundleIdentifier,\n      waitForApp: false,\n      deltaPath: appDeltaDirectory,\n      onProgress({\n        status,\n        isComplete,\n        progress,\n      }: {\n        status: string;\n        isComplete: boolean;\n        progress: number;\n      }) {\n        if (!indicator) {\n          indicator = ora(status).start();\n        }\n        indicator.text = `${chalk.bold(status)} ${progress}%`;\n        if (isComplete) {\n          indicator.succeed();\n        }\n      },\n    });\n  } catch (err: any) {\n    if (indicator) {\n      indicator.fail();\n    }\n    if (err.code === 'DeviceLocked') {\n      // Get the app name from the binary path.\n      const appName = path.basename(bundle).split('.')[0] ?? 'app';\n      if (\n        !program.nonInteractive &&\n        (await Prompts.confirmAsync({\n          message: `Cannot launch ${appName} because the device is locked. Unlock ${deviceName} to continue...`,\n          initial: true,\n        }))\n      ) {\n        return installOnDeviceAsync(props);\n      }\n      throw new CommandError(\n        `Cannot launch ${appName} on ${deviceName} because the device is locked.`\n      );\n    }\n    throw err;\n  }\n}\n"],"mappings":";;;;;;;;AAAA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,oBAAT,CAA8BC,QAA9B,EAAwD;EAC7D;EACA;EACA,MAAMC,WAAW,GAAGC,eAAA,CAAKC,IAAL,CAAUC,aAAA,CAAGC,MAAH,EAAV,EAAuB,KAAvB,EAA8B,WAA9B,EAA2CL,QAA3C,CAApB;;EACAM,kBAAA,CAAGC,aAAH,CAAiBN,WAAjB;;EACA,OAAOA,WAAP;AACD,C,CAED;;;AACO,eAAeO,oBAAf,CAAoCC,KAApC,EAMW;EAChB,IAAI,CAACC,kBAAA,CAAYC,SAAZ,EAAL,EAA8B;IAC5B,OAAO,MAAMC,SAAS,GAACJ,oBAAV,CAA+BC,KAA/B,CAAb;EACD;;EAED,MAAM;IAAEI,MAAF;IAAUC,gBAAV;IAA4BC,iBAA5B;IAA+CC,IAA/C;IAAqDC;EAArD,IAAoER,KAA1E;EACA,IAAIS,SAAJ;;EAEA,IAAI;IACF;IACA,MAAMR,kBAAA,CAAYS,WAAZ,CAAwB;MAC5BH,IAD4B;MAE5BI,OAAO,EAAEP,MAFmB;MAG5Bb,QAAQ,EAAEc,gBAHkB;MAI5BO,UAAU,EAAE,KAJgB;MAK5BC,SAAS,EAAEP,iBALiB;;MAM5BQ,UAAU,CAAC;QACTC,MADS;QAETC,UAFS;QAGTC;MAHS,CAAD,EAQP;QACD,IAAI,CAACR,SAAL,EAAgB;UACdA,SAAS,GAAG,IAAAS,UAAA,EAAIH,MAAJ,EAAYI,KAAZ,EAAZ;QACD;;QACDV,SAAS,CAACW,IAAV,GAAkB,GAAEC,gBAAA,CAAMC,IAAN,CAAWP,MAAX,CAAmB,IAAGE,QAAS,GAAnD;;QACA,IAAID,UAAJ,EAAgB;UACdP,SAAS,CAACc,OAAV;QACD;MACF;;IAtB2B,CAAxB,CAAN;EAwBD,CA1BD,CA0BE,OAAOC,GAAP,EAAiB;IACjB,IAAIf,SAAJ,EAAe;MACbA,SAAS,CAACgB,IAAV;IACD;;IACD,IAAID,GAAG,CAACE,IAAJ,KAAa,cAAjB,EAAiC;MAAA;;MAC/B;MACA,MAAMC,OAAO,4BAAGlC,eAAA,CAAKmC,QAAL,CAAcxB,MAAd,EAAsByB,KAAtB,CAA4B,GAA5B,EAAiC,CAAjC,CAAH,yEAA0C,KAAvD;;MACA,IACE,CAACC,oBAAA,CAAQC,cAAT,KACC,MAAMC,cAAA,CAAQC,YAAR,CAAqB;QAC1BC,OAAO,EAAG,iBAAgBP,OAAQ,yCAAwCnB,UAAW,iBAD3D;QAE1B2B,OAAO,EAAE;MAFiB,CAArB,CADP,CADF,EAME;QACA,OAAOpC,oBAAoB,CAACC,KAAD,CAA3B;MACD;;MACD,MAAM,KAAIoC,uBAAJ,EACH,iBAAgBT,OAAQ,OAAMnB,UAAW,gCADtC,CAAN;IAGD;;IACD,MAAMgB,GAAN;EACD;AACF"}