{"version":3,"file":"exportAppAsync.js","names":["ANONYMOUS_USERNAME","exportAppAsync","projectRoot","publicUrl","assetUrl","outputDir","options","experimentalBundle","exp","pkg","hooks","Project","getPublishExpConfigAsync","publishOptions","absoluteOutputDir","path","resolve","defaultTarget","getDefaultTarget","target","assetPathToWrite","bundlesPathToWrite","Promise","all","fs","ensureDir","Log","isDebug","newLine","log","bundles","createBundlesAsync","platforms","dev","isDev","useDevServer","Env","shouldUseDevServer","printBundleSizes","hashes","fileNames","writeBundlesAsync","assets","ProjectAssets","exportAssetsAsync","hostedUrl","assetPath","dumpAssetmap","writeAssetMapAsync","dumpSourcemap","removeOriginalSourceMappingUrl","sdkVersion","semver","lt","writeSourceMapsAsync","writeDebugHtmlAsync","writeMetadataJsonAsync","validPostExportHooks","prepareHooks","mutateExpoConfigWithManifestValues","username","UserManager","getCurrentUsernameAsync","manifests","writePlatformManifestsAsync","bundleInfo","createMultiPlatformBundleInfo","runHooks","info","EmbeddedAssets","configureAsync","hookOptions","url","hook","file","runHook","e","warn","stack","assetUrlOverride","publishedTime","Date","toISOString","commitTime","releaseId","uuidv4","hashIds","HashIds","uuidv1","revisionId","encode","now","developer","tool","id","slug"],"sources":["../../../src/commands/export/exportAppAsync.ts"],"sourcesContent":["import { ExpoAppManifest, getDefaultTarget, HookArguments } from '@expo/config';\nimport fs from 'fs-extra';\nimport HashIds from 'hashids';\nimport path from 'path';\nimport semver from 'semver';\nimport { v1 as uuidv1, v4 as uuidv4 } from 'uuid';\nimport { EmbeddedAssets, Env, printBundleSizes, Project, ProjectAssets, UserManager } from 'xdl';\n\nimport Log from '../../log';\nimport { BundlePlatform } from './createMetadataJson';\nimport {\n  createMultiPlatformBundleInfo,\n  MultiPlatformBundleInfo,\n  writeAssetMapAsync,\n  writeBundlesAsync,\n  writeDebugHtmlAsync,\n  writeMetadataJsonAsync,\n  writePlatformManifestsAsync,\n  writeSourceMapsAsync,\n} from './writeContents';\n\nexport const ANONYMOUS_USERNAME = 'anonymous';\n\n/**\n * If the `experimentalBundle` flag is true, the structure of the outputDir will be:\n *\n * ```\n * ├── assets\n * │   └── *\n * ├── bundles\n * │   ├── android-01ee6e3ab3e8c16a4d926c91808d5320.js\n * │   └── ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n * └── metadata.json\n * ```\n *\n * If the `experimentalBundle` flag is not true, then this function is for self hosting\n * and the outputDir will have the files created in the project directory the following way:\n *\n * ```\n * ├── android-index.json\n * ├── ios-index.json\n * ├── assets\n * │   └── 1eccbc4c41d49fd81840aef3eaabe862\n * └── bundles\n *       ├── android-01ee6e3ab3e8c16a4d926c91808d5320.js\n *       └── ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n * ```\n */\nexport async function exportAppAsync(\n  projectRoot: string,\n  publicUrl: string,\n  assetUrl: string,\n  outputDir: string,\n  options: {\n    platforms: BundlePlatform[];\n    isDev?: boolean;\n    dumpAssetmap?: boolean;\n    dumpSourcemap?: boolean;\n    publishOptions?: Project.PublishOptions;\n  },\n  experimentalBundle: boolean\n): Promise<void> {\n  const { exp, pkg, hooks } = await Project.getPublishExpConfigAsync(\n    projectRoot,\n    options.publishOptions\n  );\n\n  const absoluteOutputDir = path.resolve(projectRoot, outputDir);\n  const defaultTarget = getDefaultTarget(projectRoot, exp);\n  const target = options.publishOptions?.target ?? defaultTarget;\n\n  const assetPathToWrite = path.resolve(absoluteOutputDir, 'assets');\n  const bundlesPathToWrite = path.resolve(absoluteOutputDir, 'bundles');\n\n  await Promise.all([fs.ensureDir(assetPathToWrite), fs.ensureDir(bundlesPathToWrite)]);\n\n  if (Log.isDebug) {\n    Log.newLine();\n    Log.log('Export Assets:');\n    Log.log(`- Asset target: ${target}`);\n    Log.newLine();\n  }\n\n  // Run metro bundler and create the JS bundles/source maps.\n  const bundles = await Project.createBundlesAsync(projectRoot, options.publishOptions, {\n    platforms: options.platforms,\n    dev: options.isDev,\n    useDevServer: Env.shouldUseDevServer(exp),\n    // TODO: Disable source map generation if we aren't outputting them.\n  });\n\n  // Log bundle size info to the user\n  printBundleSizes(bundles);\n\n  // Write the JS bundles to disk, and get the bundle file names (this could change with async chunk loading support).\n  const { hashes, fileNames } = await writeBundlesAsync({ bundles, outputDir: bundlesPathToWrite });\n\n  Log.log('Finished saving JS Bundles');\n\n  const { assets } = await ProjectAssets.exportAssetsAsync({\n    projectRoot,\n    exp,\n    hostedUrl: publicUrl,\n    assetPath: 'assets',\n    outputDir: absoluteOutputDir,\n    bundles,\n    experimentalBundle,\n  });\n\n  if (options.dumpAssetmap) {\n    Log.log('Dumping asset map');\n    await writeAssetMapAsync({ outputDir: absoluteOutputDir, assets });\n  }\n\n  // build source maps\n  if (options.dumpSourcemap) {\n    // TODO: Maybe move this into the bundler settings.\n    const removeOriginalSourceMappingUrl =\n      target === 'managed' && !!exp.sdkVersion && semver.lt(exp.sdkVersion, '40.0.0');\n\n    await writeSourceMapsAsync({\n      bundles,\n      hashes,\n      outputDir: bundlesPathToWrite,\n      fileNames,\n      removeOriginalSourceMappingUrl,\n    });\n    // If we output source maps, then add a debug HTML file which the user can open in\n    // the web browser to inspect the output like web.\n    await writeDebugHtmlAsync({\n      outputDir: absoluteOutputDir,\n      fileNames,\n    });\n  }\n\n  // Skip the hooks and manifest creation if building for EAS.\n  if (experimentalBundle) {\n    // Generate a metadata.json and bail.\n    await writeMetadataJsonAsync({ outputDir, bundles, fileNames });\n    return;\n  }\n\n  // Load the \"post export\" hooks\n  const validPostExportHooks = Project.prepareHooks(hooks, 'postExport', projectRoot);\n\n  // Append server values to the Expo config.\n  mutateExpoConfigWithManifestValues(exp, {\n    assetUrl,\n    isDev: options.isDev,\n    username: await UserManager.getCurrentUsernameAsync(),\n  });\n\n  // TODO: Add a comment explaining what platform manifests are used for\n  const manifests = await writePlatformManifestsAsync({\n    outputDir: absoluteOutputDir,\n    publicUrl,\n    fileNames,\n    exp,\n    pkg,\n  });\n\n  // Create the shared bundle info object in somewhat of a legacy format.\n  const bundleInfo = createMultiPlatformBundleInfo({ bundles, manifests, publicUrl });\n\n  // Run post export hooks for users who want to do things like uploading source maps to sentry.\n  runHooks({ projectRoot, exp, hooks: validPostExportHooks, info: bundleInfo });\n\n  // configure embedded assets for expo-updates or ExpoKit\n  await EmbeddedAssets.configureAsync({\n    ...bundleInfo,\n    projectRoot,\n    exp,\n    pkg,\n    target,\n  });\n}\n\nfunction runHooks({\n  projectRoot,\n  exp,\n  hooks,\n  info,\n}: {\n  projectRoot: string;\n  exp: ExpoAppManifest;\n  info: MultiPlatformBundleInfo;\n  hooks: Project.LoadedHook[];\n}) {\n  const hookOptions: Omit<HookArguments, 'config'> = {\n    url: null,\n    ...info,\n    projectRoot,\n    exp,\n    log: Log.info,\n  };\n\n  for (const hook of hooks) {\n    Log.log(`Running postExport hook: ${hook.file}`);\n    try {\n      Project.runHook(hook, hookOptions);\n    } catch (e: any) {\n      Log.warn(`Warning: postExport hook '${hook.file}' failed: ${e.stack}`);\n    }\n  }\n}\n\n// TODO: Move to expo/config for public manifests\nfunction mutateExpoConfigWithManifestValues(\n  exp: ExpoAppManifest,\n  { assetUrl, isDev, username }: { assetUrl: string; isDev?: boolean; username?: string | null }\n) {\n  // Add assetUrl to manifest\n  exp.assetUrlOverride = assetUrl;\n\n  exp.publishedTime = new Date().toISOString();\n  exp.commitTime = new Date().toISOString();\n  exp.releaseId = uuidv4();\n\n  // generate revisionId and id the same way www does\n  const hashIds = new HashIds(uuidv1(), 10);\n  exp.revisionId = hashIds.encode(Date.now());\n\n  if (isDev) {\n    exp.developer = {\n      tool: 'exp',\n    };\n  }\n\n  if (!username) {\n    username = ANONYMOUS_USERNAME;\n  }\n\n  exp.id = `@${username}/${exp.slug}`;\n\n  return exp;\n}\n"],"mappings":"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"}