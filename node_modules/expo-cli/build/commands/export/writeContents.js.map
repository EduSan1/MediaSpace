{"version":3,"file":"writeContents.js","names":["writeAsync","folder","fileName","contents","ensureDir","fs","promises","writeFile","path","join","writeDebugHtmlAsync","outputDir","fileNames","Log","log","debugHtml","Object","values","map","createBundleFileName","platform","hash","createBundleHash","bundle","crypto","createHash","update","digest","writeBundlesAsync","bundles","hashes","bundleOutput","entries","hermesBytecodeBundle","code","writeSourceMapsAsync","removeOriginalSourceMappingUrl","Promise","all","sourceMap","hermesSourcemap","mapName","jsBundleFileName","jsPath","truncateLastLinesAsync","mappingComment","appendFile","comment","writeMetadataJsonAsync","metadata","createMetadataJson","JSON","stringify","writeAssetMapAsync","assets","fromEntries","asset","writePlatformManifestsAsync","publicUrl","exp","pkg","dependencies","keys","manifests","manifest","bundleUrl","urljoin","createMultiPlatformBundleInfo","key","on","reduce","prev","cur","configKey"],"sources":["../../../src/commands/export/writeContents.ts"],"sourcesContent":["import type { ExpoAppManifest, HookArguments, PackageJSONConfig } from '@expo/config';\nimport type { BundleOutput } from '@expo/dev-server';\nimport crypto from 'crypto';\nimport fs from 'fs';\nimport { ensureDir } from 'fs-extra';\nimport path from 'path';\nimport urljoin from 'url-join';\nimport { ProjectAssets } from 'xdl';\n\nimport Log from '../../log';\nimport { truncateLastLinesAsync } from '../utils/truncateLastLinesAsync';\nimport { createMetadataJson } from './createMetadataJson';\n\ntype PlatformExpoAppManifest = ExpoAppManifest & {\n  platform: string;\n  bundleUrl: string;\n  dependencies: string[];\n};\n\nasync function writeAsync(folder: string, fileName: string, contents: any) {\n  await ensureDir(folder);\n  await fs.promises.writeFile(path.join(folder, fileName), contents);\n}\n\nexport async function writeDebugHtmlAsync({\n  outputDir,\n  fileNames,\n}: {\n  outputDir: string;\n  fileNames: Record<string, string>;\n}) {\n  // Make a debug html so user can debug their bundles\n  Log.log('Preparing additional debugging files');\n  const debugHtml = `\n      ${Object.values(fileNames)\n        .map(fileName => `<script src=\"${path.join('bundles', fileName)}\"></script>`)\n        .join('\\n      ')}\n      Open up this file in Chrome. In the JavaScript developer console, navigate to the Source tab.\n      You can see a red colored folder containing the original source code from your bundle.\n      `;\n\n  await writeAsync(outputDir, 'debug.html', debugHtml);\n}\n\n/**\n * @param props.platform native platform for the bundle\n * @param props.hash crypto hash for the bundle contents\n * @returns filename for the JS bundle.\n */\nfunction createBundleFileName({ platform, hash }: { platform: string; hash: string }): string {\n  return `${platform}-${hash}.js`;\n}\n\n/**\n * @param bundle JS bundle as a string\n * @returns crypto hash for the provided bundle\n */\nfunction createBundleHash(bundle: string | Uint8Array): string {\n  return crypto.createHash('md5').update(bundle).digest('hex');\n}\n\nexport async function writeBundlesAsync({\n  bundles,\n  outputDir,\n}: {\n  bundles: Record<string, Pick<BundleOutput, 'hermesBytecodeBundle' | 'code'>>;\n  outputDir: string;\n}) {\n  const hashes: Record<string, string> = {};\n  const fileNames: Record<string, string> = {};\n\n  for (const [platform, bundleOutput] of Object.entries(bundles)) {\n    const bundle = bundleOutput.hermesBytecodeBundle ?? bundleOutput.code;\n    const hash = createBundleHash(bundle);\n    const fileName = createBundleFileName({ platform, hash });\n\n    hashes[platform] = hash;\n    fileNames[platform] = fileName;\n    await writeAsync(outputDir, fileName, bundle);\n  }\n\n  return { hashes, fileNames };\n}\n\nexport async function writeSourceMapsAsync({\n  bundles,\n  hashes,\n  fileNames,\n  outputDir,\n  removeOriginalSourceMappingUrl,\n}: {\n  bundles: Record<\n    string,\n    Pick<BundleOutput, 'hermesSourcemap' | 'map' | 'hermesBytecodeBundle' | 'code'>\n  >;\n  hashes?: Record<string, string>;\n  fileNames?: Record<string, string>;\n  outputDir: string;\n  removeOriginalSourceMappingUrl?: boolean;\n}) {\n  return await Promise.all(\n    Object.entries(bundles).map(async ([platform, bundle]) => {\n      const sourceMap = bundle.hermesSourcemap ?? bundle.map;\n      const hash =\n        hashes?.[platform] ?? createBundleHash(bundle.hermesBytecodeBundle ?? bundle.code);\n      const mapName = `${platform}-${hash}.map`;\n      await writeAsync(outputDir, mapName, sourceMap);\n\n      const jsBundleFileName = fileNames?.[platform] ?? createBundleFileName({ platform, hash });\n      const jsPath = path.join(outputDir, jsBundleFileName);\n\n      if (removeOriginalSourceMappingUrl) {\n        // Remove original mapping to incorrect sourcemap paths\n        // In SDK 40+ and bare projects, we no longer need to do this.\n        Log.log(`Configuring source maps for ${platform}`);\n        await truncateLastLinesAsync(jsPath, 1);\n      }\n\n      // Add correct mapping to sourcemap paths\n      const mappingComment = `\\n//# sourceMappingURL=${mapName}`;\n      await fs.promises.appendFile(jsPath, mappingComment);\n      return {\n        platform,\n        fileName: mapName,\n        hash,\n        map: sourceMap,\n        comment: mappingComment,\n      };\n    })\n  );\n}\n\nexport async function writeMetadataJsonAsync({\n  outputDir,\n  bundles,\n  fileNames,\n}: {\n  outputDir: string;\n  bundles: Record<string, Pick<BundleOutput, 'assets'>>;\n  fileNames: Record<string, string>;\n}) {\n  const metadata = createMetadataJson({\n    bundles,\n    fileNames,\n  });\n  await writeAsync(outputDir, 'metadata.json', JSON.stringify(metadata));\n}\n\nexport async function writeAssetMapAsync({\n  outputDir,\n  assets,\n}: {\n  outputDir: string;\n  assets: ProjectAssets.Asset[];\n}) {\n  // Convert the assets array to a k/v pair where the asset hash is the key and the asset is the value.\n  const contents = Object.fromEntries(assets.map(asset => [asset.hash, asset]));\n\n  await writeAsync(outputDir, 'assetmap.json', JSON.stringify(contents));\n\n  return contents;\n}\n\nexport async function writePlatformManifestsAsync({\n  outputDir,\n  publicUrl,\n  fileNames,\n  exp,\n  pkg,\n}: {\n  outputDir: string;\n  publicUrl: string;\n  fileNames: Record<string, string>;\n  exp: ExpoAppManifest;\n  pkg: Pick<PackageJSONConfig, 'dependencies'>;\n}): Promise<Record<string, PlatformExpoAppManifest>> {\n  const dependencies = Object.keys(pkg.dependencies ?? {});\n  const manifests: Record<string, PlatformExpoAppManifest> = {};\n  for (const platform of Object.keys(fileNames)) {\n    // save the platform manifest\n    const manifest: PlatformExpoAppManifest = {\n      ...exp,\n      platform,\n      bundleUrl: urljoin(publicUrl, 'bundles', fileNames[platform]),\n      dependencies,\n    };\n    manifests[platform] = manifest;\n    await writeAsync(outputDir, `${platform}-index.json`, JSON.stringify(manifest));\n  }\n  return manifests;\n}\n\n// TODO: Refactor this to support more/less platforms better.\nexport type MultiPlatformBundleInfo = Pick<\n  HookArguments,\n  | 'androidManifestUrl'\n  | 'androidBundle'\n  | 'androidManifest'\n  | 'androidSourceMap'\n  | 'iosManifestUrl'\n  | 'iosBundle'\n  | 'iosManifest'\n  | 'iosSourceMap'\n>;\n\nexport function createMultiPlatformBundleInfo({\n  publicUrl,\n  bundles,\n  manifests,\n}: {\n  publicUrl: string;\n  bundles: Record<\n    string,\n    Pick<BundleOutput, 'hermesBytecodeBundle' | 'code' | 'hermesSourcemap' | 'map'>\n  >;\n  manifests: Record<string, PlatformExpoAppManifest>;\n}): MultiPlatformBundleInfo {\n  const keys: { key: string; on: (platform: string) => any }[] = [\n    {\n      key: 'ManifestUrl',\n      on: (platform: string) => urljoin(publicUrl, `${platform}-index.json`),\n    },\n    {\n      key: 'Manifest',\n      on: platform => manifests[platform] ?? null,\n    },\n    {\n      key: 'Bundle',\n      on: platform => bundles[platform].hermesBytecodeBundle ?? bundles[platform].code,\n    },\n    {\n      key: 'SourceMap',\n      on: platform => bundles[platform].hermesSourcemap ?? bundles[platform].map,\n    },\n  ];\n\n  return keys.reduce((prev, cur) => {\n    for (const platform of Object.keys(bundles)) {\n      // Like `iosManifestUrl`, or `androidBundle`\n      const configKey = platform + cur.key;\n      // @ts-ignore: needs refactor in the future -- currently a refactor would break the public API for publish hooks.\n      prev[configKey] = cur.on(platform);\n    }\n    return prev;\n  }, {} as MultiPlatformBundleInfo);\n}\n"],"mappings":"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"}