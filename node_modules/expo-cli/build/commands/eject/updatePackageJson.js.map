{"version":3,"file":"updatePackageJson.js","names":["updatePackageJSONAsync","projectRoot","tempDir","pkg","skipDependencyUpdate","updatingPackageJsonStep","logNewSection","updatePackageJSONScripts","results","updatePackageJSONDependencies","removedPkgMain","updatePackageJSONEntryPoint","fs","writeFile","path","resolve","JSON","stringify","succeed","Log","log","chalk","bold","newLine","devDependencies","dependencies","getPackageJson","defaultDependencies","createDependenciesMap","defaultDevDependencies","combinedDependencies","requiredDependencies","filter","depKey","symlinkedPackages","dependenciesKey","isModuleSymlinked","moduleId","isSilent","push","includes","length","map","join","combinedDevDependencies","hasNewDependencies","hashForDependencyMap","hasNewDevDependencies","Object","assign","Error","outputMap","key","keys","value","scripts","start","android","ios","shouldDeleteMainField","main","isPkgMainExpoAppEntry","input","startsWith","normalizeDependencyMap","deps","dependency","sort","depsList","depsString","createFileHash","contents","crypto","createHash","update","digest"],"sources":["../../../src/commands/eject/updatePackageJson.ts"],"sourcesContent":["import { getPackageJson, PackageJSONConfig } from '@expo/config';\nimport chalk from 'chalk';\nimport crypto from 'crypto';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport Log from '../../log';\nimport { logNewSection } from '../../utils/ora';\nimport { isModuleSymlinked } from '../utils/isModuleSymlinked';\n\nexport type DependenciesMap = { [key: string]: string | number };\n\nexport type DependenciesModificationResults = {\n  hasNewDependencies: boolean;\n  hasNewDevDependencies: boolean;\n};\n\nexport async function updatePackageJSONAsync({\n  projectRoot,\n  tempDir,\n  pkg,\n  skipDependencyUpdate,\n}: {\n  projectRoot: string;\n  tempDir: string;\n  pkg: PackageJSONConfig;\n  skipDependencyUpdate?: string[];\n}): Promise<DependenciesModificationResults> {\n  // NOTE(brentvatne): Removing spaces between steps for now, add back when\n  // there is some additional context for steps\n  const updatingPackageJsonStep = logNewSection(\n    'Updating your package.json scripts, dependencies, and main file'\n  );\n\n  updatePackageJSONScripts({ pkg });\n\n  const results = updatePackageJSONDependencies({\n    projectRoot,\n    pkg,\n    tempDir,\n    skipDependencyUpdate,\n  });\n\n  const removedPkgMain = updatePackageJSONEntryPoint({ pkg });\n  await fs.writeFile(\n    path.resolve(projectRoot, 'package.json'),\n    // Add new line to match the format of running yarn.\n    // This prevents the `package.json` from changing when running `prebuild --no-install` multiple times.\n    JSON.stringify(pkg, null, 2) + '\\n'\n  );\n\n  updatingPackageJsonStep.succeed(\n    'Updated package.json and added index.js entry point for iOS and Android'\n  );\n  if (removedPkgMain) {\n    Log.log(\n      `\\u203A Removed ${chalk.bold(\n        `\"main\": \"${removedPkgMain}\"`\n      )} from package.json because we recommend using index.js as main instead`\n    );\n    Log.newLine();\n  }\n\n  return results;\n}\n\n/**\n * Update package.json dependencies by combining the dependencies in the project we are ejecting\n * with the dependencies in the template project. Does the same for devDependencies.\n *\n * - The template may have some dependencies beyond react/react-native/react-native-unimodules,\n *   for example RNGH and Reanimated. We should prefer the version that is already being used\n *   in the project for those, but swap the react/react-native/react-native-unimodules versions\n *   with the ones in the template.\n * - The same applies to expo-updates -- since some native project configuration may depend on the\n *   version, we should always use the version of expo-updates in the template.\n */\nexport function updatePackageJSONDependencies({\n  projectRoot,\n  tempDir,\n  pkg,\n  skipDependencyUpdate = [],\n}: {\n  projectRoot: string;\n  tempDir: string;\n  pkg: PackageJSONConfig;\n  skipDependencyUpdate?: string[];\n}): DependenciesModificationResults {\n  if (!pkg.devDependencies) {\n    pkg.devDependencies = {};\n  }\n  const { dependencies, devDependencies } = getPackageJson(tempDir);\n  const defaultDependencies = createDependenciesMap(dependencies);\n  const defaultDevDependencies = createDependenciesMap(devDependencies);\n\n  const combinedDependencies: DependenciesMap = createDependenciesMap({\n    ...defaultDependencies,\n    ...pkg.dependencies,\n  });\n\n  const requiredDependencies = [\n    'react',\n    'react-native-unimodules',\n    'react-native',\n    'expo-updates',\n  ].filter(depKey => !!defaultDependencies[depKey]);\n\n  const symlinkedPackages: string[] = [];\n\n  for (const dependenciesKey of requiredDependencies) {\n    if (\n      // If the local package.json defined the dependency that we want to overwrite...\n      pkg.dependencies?.[dependenciesKey]\n    ) {\n      if (\n        // Then ensure it isn't symlinked (i.e. the user has a custom version in their yarn workspace).\n        isModuleSymlinked({ projectRoot, moduleId: dependenciesKey, isSilent: true })\n      ) {\n        // If the package is in the project's package.json and it's symlinked, then skip overwriting it.\n        symlinkedPackages.push(dependenciesKey);\n        continue;\n      }\n      if (skipDependencyUpdate.includes(dependenciesKey)) {\n        continue;\n      }\n    }\n    combinedDependencies[dependenciesKey] = defaultDependencies[dependenciesKey];\n  }\n\n  if (symlinkedPackages.length) {\n    Log.log(\n      `\\u203A Using symlinked ${symlinkedPackages\n        .map(pkg => chalk.bold(pkg))\n        .join(', ')} instead of recommended version(s).`\n    );\n  }\n\n  const combinedDevDependencies: DependenciesMap = createDependenciesMap({\n    ...defaultDevDependencies,\n    ...pkg.devDependencies,\n  });\n\n  // Only change the dependencies if the normalized hash changes, this helps to reduce meaningless changes.\n  const hasNewDependencies =\n    hashForDependencyMap(pkg.dependencies) !== hashForDependencyMap(combinedDependencies);\n  const hasNewDevDependencies =\n    hashForDependencyMap(pkg.devDependencies) !== hashForDependencyMap(combinedDevDependencies);\n  // Save the dependencies\n  if (hasNewDependencies) {\n    // Use Object.assign to preserve the original order of dependencies, this makes it easier to see what changed in the git diff.\n    pkg.dependencies = Object.assign(pkg.dependencies, combinedDependencies);\n  }\n  if (hasNewDevDependencies) {\n    // Same as with dependencies\n    pkg.devDependencies = Object.assign(pkg.devDependencies, combinedDevDependencies);\n  }\n\n  return {\n    hasNewDependencies,\n    hasNewDevDependencies,\n  };\n}\n\n/**\n * Create an object of type DependenciesMap a dependencies object or throw if not valid.\n *\n * @param dependencies - ideally an object of type {[key]: string} - if not then this will error.\n */\nexport function createDependenciesMap(dependencies: any): DependenciesMap {\n  if (typeof dependencies !== 'object') {\n    throw new Error(`Dependency map is invalid, expected object but got ${typeof dependencies}`);\n  } else if (!dependencies) {\n    return {};\n  }\n\n  const outputMap: DependenciesMap = {};\n\n  for (const key of Object.keys(dependencies)) {\n    const value = dependencies[key];\n    if (typeof value === 'string') {\n      outputMap[key] = value;\n    } else {\n      throw new Error(\n        `Dependency for key \\`${key}\\` should be a \\`string\\`, instead got: \\`{ ${key}: ${JSON.stringify(\n          value\n        )} }\\``\n      );\n    }\n  }\n  return outputMap;\n}\n\n/**\n * Update package.json scripts - `npm start` should default to `react-native\n * start` rather than `expo start` after ejecting, for example.\n */\nfunction updatePackageJSONScripts({ pkg }: { pkg: PackageJSONConfig }) {\n  if (!pkg.scripts) {\n    pkg.scripts = {};\n  }\n  if (!pkg.scripts.start?.includes('--dev-client')) {\n    pkg.scripts.start = 'expo start --dev-client';\n  }\n  if (!pkg.scripts.android?.includes('run')) {\n    pkg.scripts.android = 'expo run:android';\n  }\n  if (!pkg.scripts.ios?.includes('run')) {\n    pkg.scripts.ios = 'expo run:ios';\n  }\n}\n\n/**\n * Add new app entry points\n */\nfunction updatePackageJSONEntryPoint({ pkg }: { pkg: PackageJSONConfig }): boolean {\n  let removedPkgMain = false;\n  // Check that the pkg.main doesn't match:\n  // - ./node_modules/expo/AppEntry\n  // - ./node_modules/expo/AppEntry.js\n  // - node_modules/expo/AppEntry.js\n  // - expo/AppEntry.js\n  // - expo/AppEntry\n  if (shouldDeleteMainField(pkg.main)) {\n    // Save the custom\n    removedPkgMain = pkg.main;\n    delete pkg.main;\n  }\n\n  return removedPkgMain;\n}\n\n/**\n * Returns true if the input string matches the default expo main field.\n *\n * - ./node_modules/expo/AppEntry\n * - ./node_modules/expo/AppEntry.js\n * - node_modules/expo/AppEntry.js\n * - expo/AppEntry.js\n * - expo/AppEntry\n *\n * @param input package.json main field\n */\nexport function isPkgMainExpoAppEntry(input?: string): boolean {\n  const main = input || '';\n  if (main.startsWith('./')) {\n    return main.includes('node_modules/expo/AppEntry');\n  }\n  return main.includes('expo/AppEntry');\n}\n\nfunction normalizeDependencyMap(deps: DependenciesMap): string[] {\n  return Object.keys(deps)\n    .map(dependency => `${dependency}@${deps[dependency]}`)\n    .sort();\n}\n\nexport function hashForDependencyMap(deps: DependenciesMap = {}): string {\n  const depsList = normalizeDependencyMap(deps);\n  const depsString = depsList.join('\\n');\n  return createFileHash(depsString);\n}\n\nexport function createFileHash(contents: string): string {\n  // this doesn't need to be secure, the shorter the better.\n  return crypto.createHash('sha1').update(contents).digest('hex');\n}\n\nexport function shouldDeleteMainField(main?: any): boolean {\n  if (!main || !isPkgMainExpoAppEntry(main)) {\n    return false;\n  }\n\n  return !main?.startsWith('index.');\n}\n"],"mappings":"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"}