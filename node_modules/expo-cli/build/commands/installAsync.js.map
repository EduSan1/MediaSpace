{"version":3,"file":"installAsync.js","names":["resolveExpoProjectRootAsync","info","findProjectRootAsync","process","cwd","projectRoot","error","code","Log","addNewLineIfNone","message","newLine","log","chalk","cyan","bold","SilentError","actionAsync","packages","options","warnAboutLocalCLI","localCmd","packageManager","PackageManager","createForProject","npm","yarn","exp","pkg","getConfig","skipSDKVersionRequirement","skipPlugins","dependencies","addAsync","sdkVersion","CommandError","name","toLowerCase","Versions","gteSdkVersion","resolveFrom","silent","installAsync","bundledNativeModules","getBundledNativeModulesAsync","versionsForSdk","getRemoteVersionsForSdk","nativeModulesCount","othersCount","unparsedParameterFound","parameters","forEach","packageName","startsWith","push","versionedPackages","filter","arg","includes","map","type","raw","npmPackageArg","messages","Boolean","join","addWithParametersAsync","autoAddConfigPluginsAsync","split","isPluginError","warn"],"sources":["../../src/commands/installAsync.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\nimport npmPackageArg from 'npm-package-arg';\nimport resolveFrom from 'resolve-from';\nimport { Versions } from 'xdl';\n\nimport CommandError, { SilentError } from '../CommandError';\nimport Log from '../log';\nimport { getRemoteVersionsForSdk } from '../utils/getRemoteVersionsForSdk';\nimport { warnAboutLocalCLI } from '../utils/migration';\nimport { findProjectRootAsync } from './utils/ProjectUtils';\nimport { autoAddConfigPluginsAsync } from './utils/autoAddConfigPluginsAsync';\nimport { getBundledNativeModulesAsync } from './utils/bundledNativeModules';\n\nasync function resolveExpoProjectRootAsync() {\n  try {\n    const info = await findProjectRootAsync(process.cwd());\n    return info.projectRoot;\n  } catch (error: any) {\n    if (error.code !== 'NO_PROJECT') {\n      // An unknown error occurred.\n      throw error;\n    }\n    // This happens when an app.config exists but a package.json is not present.\n    Log.addNewLineIfNone();\n    Log.error(error.message);\n    Log.newLine();\n    Log.log(chalk.cyan(`You can create a new project with ${chalk.bold(`expo init`)}`));\n    Log.newLine();\n    throw new SilentError(error);\n  }\n}\n\nexport async function actionAsync(\n  packages: string[],\n  options: PackageManager.CreateForProjectOptions\n) {\n  const projectRoot = await resolveExpoProjectRootAsync();\n  warnAboutLocalCLI(projectRoot, { localCmd: 'install' });\n\n  const packageManager = PackageManager.createForProject(projectRoot, {\n    npm: options.npm,\n    yarn: options.yarn,\n    log: Log.log,\n  });\n\n  let { exp, pkg } = getConfig(projectRoot, {\n    skipSDKVersionRequirement: true,\n    // Sometimes users will add a plugin to the config before installing the library,\n    // this wouldn't work unless we dangerously disable plugin serialization.\n    skipPlugins: true,\n  });\n\n  // If using `expo install` in a project without the expo package even listed\n  // in package.json, just fall through to npm/yarn.\n  //\n  if (!pkg.dependencies?.['expo']) {\n    return await packageManager.addAsync(...packages);\n  }\n\n  if (!exp.sdkVersion) {\n    Log.addNewLineIfNone();\n    throw new CommandError(\n      `The ${chalk.bold(`expo`)} package was found in your ${chalk.bold(\n        `package.json`\n      )} but we couldn't resolve the Expo SDK version. Run ${chalk.bold(\n        `${packageManager.name.toLowerCase()} install`\n      )} and then try this command again.\\n`\n    );\n  }\n\n  if (!Versions.gteSdkVersion(exp, '33.0.0')) {\n    const message = `${chalk.bold(\n      `expo install`\n    )} is only available for Expo SDK version 33 or higher.`;\n    Log.addNewLineIfNone();\n    Log.error(message);\n    Log.newLine();\n    Log.log(chalk.cyan(`Current version: ${chalk.bold(exp.sdkVersion)}`));\n    Log.newLine();\n    throw new SilentError(message);\n  }\n\n  // This shouldn't be invoked because `findProjectRootAsync` will throw if node_modules are missing.\n  // Every React project should have react installed...\n  if (!resolveFrom.silent(projectRoot, 'react')) {\n    Log.addNewLineIfNone();\n    Log.log(chalk.cyan(`node_modules not found, running ${packageManager.name} install command.`));\n    Log.newLine();\n    await packageManager.installAsync();\n  }\n\n  const bundledNativeModules = await getBundledNativeModulesAsync(projectRoot, exp.sdkVersion);\n  const versionsForSdk = await getRemoteVersionsForSdk(exp.sdkVersion);\n\n  let nativeModulesCount = 0;\n  let othersCount = 0;\n  let unparsedParameterFound = false;\n  const parameters: string[] = [];\n\n  // Detect unparsed parameters that are passed in\n  // Assume anything after the first one to be a parameter (to support cases like `-- --loglevel verbose`)\n  packages.forEach(packageName => {\n    if (packageName.startsWith('-')) {\n      unparsedParameterFound = true;\n    }\n\n    if (unparsedParameterFound) {\n      parameters.push(packageName);\n    }\n  });\n\n  const versionedPackages = packages\n    .filter(arg => !parameters.includes(arg))\n    .map(arg => {\n      const { name, type, raw } = npmPackageArg(arg);\n\n      if (['tag', 'version', 'range'].includes(type) && name && bundledNativeModules[name]) {\n        // Unimodule packages from npm registry are modified to use the bundled version.\n        nativeModulesCount++;\n        return `${name}@${bundledNativeModules[name]}`;\n      } else if (name && versionsForSdk[name]) {\n        // Some packages have the recommended version listed in https://exp.host/--/api/v2/versions.\n        othersCount++;\n        return `${name}@${versionsForSdk[name]}`;\n      } else {\n        // Other packages are passed through unmodified.\n        othersCount++;\n        return raw;\n      }\n    });\n\n  const messages = [\n    nativeModulesCount > 0 &&\n      `${nativeModulesCount} SDK ${exp.sdkVersion} compatible native ${\n        nativeModulesCount === 1 ? 'module' : 'modules'\n      }`,\n    othersCount > 0 && `${othersCount} other ${othersCount === 1 ? 'package' : 'packages'}`,\n  ].filter(Boolean);\n  Log.log(`Installing ${messages.join(' and ')} using ${packageManager.name}.`);\n\n  await packageManager.addWithParametersAsync(versionedPackages, parameters);\n\n  try {\n    exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n\n    // Only auto add plugins if the plugins array is defined or if the project is using SDK +42.\n    await autoAddConfigPluginsAsync(\n      projectRoot,\n      exp,\n      versionedPackages.map(pkg => pkg.split('@')[0]).filter(Boolean)\n    );\n  } catch (error: any) {\n    if (error.isPluginError) {\n      Log.warn(`Skipping config plugin check: ` + error.message);\n      return;\n    }\n    throw error;\n  }\n}\n"],"mappings":"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"}