{"version":3,"file":"context.js","names":["Context","nonInteractive","_nonInteractive","user","_user","hasProjectContext","_hasProjectContext","projectDir","_projectDir","projectOwner","UserManager","getProjectOwner","manifest","_manifest","Error","api","_apiClient","android","_androidApiClient","ios","_iosApiClient","appleCtx","_appleCtx","value","hasAppleCtx","ensureAppleCtx","authenticateAsync","_appleCtxOptions","logOwnerAndProject","isProxyUser","owner","username","Log","log","slug","init","options","allowAnonymous","appleId","appleIdPassword","teamId","getCurrentUserAsync","undefined","ensureLoggedInAsync","ApiV2","clientForUser","IosApi","AndroidApi","exp","getConfig","skipSDKVersionRequirement"],"sources":["../../src/credentials/context.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { ApiV2, RobotUser, User, UserManager } from 'xdl';\n\nimport { AppleCtx, authenticateAsync } from '../appleApi';\nimport Log from '../log';\nimport AndroidApi from './api/AndroidApi';\nimport IosApi from './api/IosApi';\n\nexport interface IView {\n  open(ctx: Context): Promise<IView | null>;\n}\n\ninterface AppleCtxOptions {\n  appleId?: string;\n  appleIdPassword?: string;\n  teamId?: string;\n}\n\ninterface CtxOptions extends AppleCtxOptions {\n  allowAnonymous?: boolean;\n  nonInteractive?: boolean;\n}\n\nexport class Context {\n  _hasProjectContext: boolean = false;\n  _projectDir?: string;\n  _user?: User | RobotUser;\n  _manifest?: ExpoConfig;\n  _apiClient?: ApiV2;\n  _iosApiClient?: IosApi;\n  _androidApiClient?: AndroidApi;\n  _appleCtxOptions?: AppleCtxOptions;\n  _appleCtx?: AppleCtx;\n  _nonInteractive?: boolean;\n\n  get nonInteractive(): boolean {\n    return this._nonInteractive === true;\n  }\n\n  get user(): User | RobotUser {\n    return this._user as User | RobotUser;\n  }\n  get hasProjectContext(): boolean {\n    return this._hasProjectContext;\n  }\n  get projectDir(): string {\n    return this._projectDir as string;\n  }\n  get projectOwner(): string {\n    return UserManager.getProjectOwner(this.user, this.manifest);\n  }\n  get manifest(): ExpoConfig {\n    if (!this._manifest) {\n      throw new Error('Manifest (app.json) not initialized.');\n    }\n    return this._manifest;\n  }\n  get api(): ApiV2 {\n    return this._apiClient as ApiV2;\n  }\n  get android(): AndroidApi {\n    return this._androidApiClient as AndroidApi;\n  }\n  get ios(): IosApi {\n    return this._iosApiClient as IosApi;\n  }\n  get appleCtx(): AppleCtx {\n    if (!this._appleCtx) {\n      throw new Error('Apple context not initialized.');\n    }\n    return this._appleCtx;\n  }\n  set manifest(value: ExpoConfig) {\n    this._manifest = value;\n  }\n\n  hasAppleCtx(): boolean {\n    return !!this._appleCtx;\n  }\n\n  async ensureAppleCtx() {\n    if (!this._appleCtx) {\n      this._appleCtx = await authenticateAsync(this._appleCtxOptions);\n    }\n  }\n\n  logOwnerAndProject() {\n    // Figure out if User A is configuring credentials as admin for User B's project\n    const isProxyUser = this.manifest.owner && this.manifest.owner !== this.user.username;\n    Log.log(\n      `Accessing credentials ${isProxyUser ? 'on behalf of' : 'for'} ${\n        this.projectOwner\n      } in project ${this.manifest.slug}`\n    );\n  }\n\n  async init(projectDir: string, options: CtxOptions = {}) {\n    const { allowAnonymous, appleId, appleIdPassword, teamId, nonInteractive } = options;\n    this._user = (await UserManager.getCurrentUserAsync()) || undefined;\n\n    // User isn't signed it, but needs to be signed in\n    if (!this._user && !allowAnonymous) {\n      this._user = (await UserManager.ensureLoggedInAsync()) as User;\n    }\n\n    this._projectDir = projectDir;\n    this._apiClient = ApiV2.clientForUser(this.user);\n    this._iosApiClient = new IosApi(this.api);\n    this._androidApiClient = new AndroidApi(this.api);\n    this._appleCtxOptions = { appleId, appleIdPassword, teamId };\n    this._nonInteractive = nonInteractive;\n\n    // try to access project context\n    try {\n      const { exp } = getConfig(projectDir, { skipSDKVersionRequirement: true });\n      this._manifest = exp;\n      this._hasProjectContext = true;\n      this.logOwnerAndProject();\n    } catch {\n      // ignore error\n      // startcredentials manager without project context\n    }\n  }\n}\n"],"mappings":"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"}