{"version":3,"file":"AppleDevice.js","names":["EXPO_USE_APPLE_DEVICE","boolish","debug","Debug","isEnabled","getConnectedDevices","usbmuxClient","UsbmuxdClient","connectUsbmuxdSocket","usbmuxDevices","getDevices","socket","end","Promise","all","map","d","connect","device","LockdowndClient","getAllValues","runOnDevice","udid","appPath","bundleId","waitForApp","deltaPath","onProgress","clientManager","ClientManager","create","mountDeveloperDiskImage","packageName","path","basename","destPackagePath","join","uploadApp","installer","getInstallationProxyClient","installApp","ApplicationsType","CFBundleIdentifier","CloseOnInvalidate","InvalidateOnDetach","IsUserInitiated","PreferWifi","PackageType","ShadowParentKey","appInfo","lookupApp","wait","debugServerClient","launchApp","detach","onBeforeExit","halt","result","continue","kill","imageMounter","getMobileImageMounterClient","lookupImage","ImageSignature","version","getLockdowndClient","getValue","developerDiskImagePath","getDeveloperDiskImagePath","developerDiskImageSig","readFileSync","uploadImage","mountImage","srcPath","destinationPath","afcClient","getAFCClient","getFileInfo","err","AFCError","status","AFC_STATUS","OBJECT_NOT_FOUND","makeDirectory","uploadDirectory","tries","getDebugserverClient","setMaxPacketSize","setWorkingDir","Container","Path","CFBundleExecutable","checkLaunchSuccess","res","sendCommand","console","warn","Error"],"sources":["../../src/apple/AppleDevice.ts"],"sourcesContent":["import Debug from 'debug';\nimport { readFileSync } from 'fs';\nimport { boolish } from 'getenv';\nimport * as path from 'path';\n\nimport {\n  AFC_STATUS,\n  AFCError,\n  ClientManager,\n  LockdowndClient,\n  OnInstallProgressCallback,\n  UsbmuxdClient,\n} from './native-run/ios/lib';\nimport type { DeviceValues, IPLookupResult } from './native-run/ios/lib';\nimport { getDeveloperDiskImagePath } from './native-run/ios/utils/xcode';\nimport { onBeforeExit, wait } from './native-run/utils/process';\n\nconst EXPO_USE_APPLE_DEVICE = boolish('EXPO_USE_APPLE_DEVICE', false);\n\nconst debug = Debug('expo:xdl:ios:utils:device');\n\nexport function isEnabled() {\n  return EXPO_USE_APPLE_DEVICE;\n}\n\nexport async function getConnectedDevices(): Promise<DeviceValues[]> {\n  const usbmuxClient = new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket());\n  const usbmuxDevices = await usbmuxClient.getDevices();\n  usbmuxClient.socket.end();\n\n  return Promise.all(\n    usbmuxDevices.map(\n      async (d: any): Promise<DeviceValues> => {\n        const socket = await new UsbmuxdClient(UsbmuxdClient.connectUsbmuxdSocket()).connect(\n          d,\n          62078\n        );\n        const device = await new LockdowndClient(socket).getAllValues();\n        socket.end();\n        return device;\n      }\n    )\n  );\n}\n\nexport async function runOnDevice({\n  udid,\n  appPath,\n  bundleId,\n  waitForApp,\n  deltaPath,\n  onProgress,\n}: {\n  udid: string;\n  appPath: string;\n  bundleId: string;\n  waitForApp: boolean;\n  deltaPath: string;\n  onProgress: OnInstallProgressCallback;\n}) {\n  const clientManager = await ClientManager.create(udid);\n\n  try {\n    await mountDeveloperDiskImage(clientManager);\n\n    const packageName = path.basename(appPath);\n    const destPackagePath = path.join('PublicStaging', packageName);\n\n    await uploadApp(clientManager, appPath, destPackagePath);\n\n    const installer = await clientManager.getInstallationProxyClient();\n    await installer.installApp(\n      destPackagePath,\n      bundleId,\n      {\n        // https://github.com/ios-control/ios-deploy/blob/0f2ffb1e564aa67a2dfca7cdf13de47ce489d835/src/ios-deploy/ios-deploy.m#L2491-L2508\n        ApplicationsType: 'Any',\n\n        CFBundleIdentifier: bundleId,\n        CloseOnInvalidate: '1',\n        InvalidateOnDetach: '1',\n        IsUserInitiated: '1',\n        // Disable checking for wifi devices, this is nominally faster.\n        PreferWifi: '0',\n        // Only info I could find on these:\n        // https://github.com/wwxxyx/Quectel_BG96/blob/310876f90fc1093a59e45e381160eddcc31697d0/Apple_Homekit/homekit_certification_tools/ATS%206/ATS%206/ATS.app/Contents/Frameworks/CaptureKit.framework/Versions/A/Resources/MobileDevice/MobileInstallation.h#L112-L121\n        PackageType: 'Developer',\n        ShadowParentKey: deltaPath,\n        // SkipUninstall: '1'\n      },\n      onProgress\n    );\n\n    const { [bundleId]: appInfo } = await installer.lookupApp([bundleId]);\n    // launch fails with EBusy or ENotFound if you try to launch immediately after install\n    await wait(200);\n    const debugServerClient = await launchApp(clientManager, { appInfo, detach: !waitForApp });\n    if (waitForApp) {\n      onBeforeExit(async () => {\n        // causes continue() to return\n        debugServerClient.halt();\n        // give continue() time to return response\n        await wait(64);\n      });\n\n      debug(`Waiting for app to close...\\n`);\n      const result = await debugServerClient.continue();\n      // TODO: I have no idea what this packet means yet (successful close?)\n      // if not a close (ie, most likely due to halt from onBeforeExit), then kill the app\n      if (result !== 'W00') {\n        await debugServerClient.kill();\n      }\n    }\n  } finally {\n    clientManager.end();\n  }\n}\n\nasync function mountDeveloperDiskImage(clientManager: ClientManager) {\n  const imageMounter = await clientManager.getMobileImageMounterClient();\n  // Check if already mounted. If not, mount.\n  if (!(await imageMounter.lookupImage()).ImageSignature) {\n    // verify DeveloperDiskImage exists (TODO: how does this work on Windows/Linux?)\n    // TODO: if windows/linux, download?\n    const version = await (await clientManager.getLockdowndClient()).getValue('ProductVersion');\n    const developerDiskImagePath = await getDeveloperDiskImagePath(version);\n    const developerDiskImageSig = readFileSync(`${developerDiskImagePath}.signature`);\n    await imageMounter.uploadImage(developerDiskImagePath, developerDiskImageSig);\n    await imageMounter.mountImage(developerDiskImagePath, developerDiskImageSig);\n  }\n}\n\nasync function uploadApp(clientManager: ClientManager, srcPath: string, destinationPath: string) {\n  const afcClient = await clientManager.getAFCClient();\n  try {\n    await afcClient.getFileInfo('PublicStaging');\n  } catch (err: any) {\n    if (err instanceof AFCError && err.status === AFC_STATUS.OBJECT_NOT_FOUND) {\n      await afcClient.makeDirectory('PublicStaging');\n    } else {\n      throw err;\n    }\n  }\n  await afcClient.uploadDirectory(srcPath, destinationPath);\n}\n\nasync function launchApp(\n  clientManager: ClientManager,\n  { appInfo, detach }: { appInfo: IPLookupResult[string]; detach?: boolean }\n) {\n  let tries = 0;\n  while (tries < 3) {\n    const debugServerClient = await clientManager.getDebugserverClient();\n    await debugServerClient.setMaxPacketSize(1024);\n    await debugServerClient.setWorkingDir(appInfo.Container);\n    await debugServerClient.launchApp(appInfo.Path, appInfo.CFBundleExecutable);\n\n    const result = await debugServerClient.checkLaunchSuccess();\n    if (result === 'OK') {\n      if (detach) {\n        // https://github.com/libimobiledevice/libimobiledevice/blob/25059d4c7d75e03aab516af2929d7c6e6d4c17de/tools/idevicedebug.c#L455-L464\n        const res = await debugServerClient.sendCommand('D', []);\n        debug('Disconnect from debug server request:', res);\n        if (res !== 'OK') {\n          console.warn(\n            'Something went wrong while attempting to disconnect from iOS debug server, you may need to reopen the app manually.'\n          );\n        }\n      }\n\n      return debugServerClient;\n    } else if (result === 'EBusy' || result === 'ENotFound') {\n      debug('Device busy or app not found, trying to launch again in .5s...');\n      tries++;\n      debugServerClient.socket.end();\n      await wait(500);\n    } else {\n      throw new Error(`There was an error launching app: ${result}`);\n    }\n  }\n  throw new Error('Unable to launch app, number of tries exceeded');\n}\n"],"mappings":"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"}