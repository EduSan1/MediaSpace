{"version":3,"file":"process.js","names":["debug","Debug","once","fn","called","r","wrapper","args","exec","util","promisify","cp","execFile","wait","setTimeout","exitQueue","onBeforeExit","push","BEFORE_EXIT_SIGNALS","beforeExitHandlerWrapper","signal","length","i","entries","e","process","exitCode","exit","on"],"sources":["../../../../src/apple/native-run/utils/process.ts"],"sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport * as cp from 'child_process';\nimport Debug from 'debug';\nimport * as util from 'util';\n\nconst debug = Debug('expo:xdl:utils:process');\n\nexport function once<T extends (...args: any[]) => any>(fn: T): T {\n  let called = false;\n  let r: any;\n\n  const wrapper: any = (...args: any[]): any => {\n    if (!called) {\n      called = true;\n      r = fn(...args);\n    }\n\n    return r;\n  };\n\n  return wrapper;\n}\nexport const exec = util.promisify(cp.exec);\nexport const execFile = util.promisify(cp.execFile);\nexport const wait = util.promisify(setTimeout);\n\nexport type ExitQueueFn = () => Promise<void>;\n\nconst exitQueue: ExitQueueFn[] = [];\n\nexport function onBeforeExit(fn: ExitQueueFn): void {\n  exitQueue.push(fn);\n}\n\nconst BEFORE_EXIT_SIGNALS: NodeJS.Signals[] = ['SIGINT', 'SIGTERM', 'SIGHUP', 'SIGBREAK'];\n\nconst beforeExitHandlerWrapper = (signal: NodeJS.Signals) =>\n  once(async () => {\n    debug('onBeforeExit handler: %s received', signal);\n    debug('onBeforeExit handler: running %s queued functions', exitQueue.length);\n\n    for (const [i, fn] of exitQueue.entries()) {\n      try {\n        await fn();\n      } catch (e: any) {\n        debug('Error from function %d in exit queue: %O', i, e);\n      }\n    }\n\n    debug('onBeforeExit handler: exiting (exit code %s)', process.exitCode ? process.exitCode : 0);\n\n    process.exit();\n  });\n\nfor (const signal of BEFORE_EXIT_SIGNALS) {\n  process.on(signal, beforeExitHandlerWrapper(signal));\n}\n"],"mappings":";;;;;;;;;;AAQA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;;;;;AAVA;AACA;AACA;AACA;AACA;AACA;AACA;AAMA,MAAMA,KAAK,GAAG,IAAAC,gBAAA,EAAM,wBAAN,CAAd;;AAEO,SAASC,IAAT,CAAiDC,EAAjD,EAA2D;EAChE,IAAIC,MAAM,GAAG,KAAb;EACA,IAAIC,CAAJ;;EAEA,MAAMC,OAAY,GAAG,CAAC,GAAGC,IAAJ,KAAyB;IAC5C,IAAI,CAACH,MAAL,EAAa;MACXA,MAAM,GAAG,IAAT;MACAC,CAAC,GAAGF,EAAE,CAAC,GAAGI,IAAJ,CAAN;IACD;;IAED,OAAOF,CAAP;EACD,CAPD;;EASA,OAAOC,OAAP;AACD;;AACM,MAAME,IAAI,GAAGC,IAAI,GAACC,SAAL,CAAeC,EAAE,GAACH,IAAlB,CAAb;;AACA,MAAMI,QAAQ,GAAGH,IAAI,GAACC,SAAL,CAAeC,EAAE,GAACC,QAAlB,CAAjB;;AACA,MAAMC,IAAI,GAAGJ,IAAI,GAACC,SAAL,CAAeI,UAAf,CAAb;;AAIP,MAAMC,SAAwB,GAAG,EAAjC;;AAEO,SAASC,YAAT,CAAsBb,EAAtB,EAA6C;EAClDY,SAAS,CAACE,IAAV,CAAed,EAAf;AACD;;AAED,MAAMe,mBAAqC,GAAG,CAAC,QAAD,EAAW,SAAX,EAAsB,QAAtB,EAAgC,UAAhC,CAA9C;;AAEA,MAAMC,wBAAwB,GAAIC,MAAD,IAC/BlB,IAAI,CAAC,YAAY;EACfF,KAAK,CAAC,mCAAD,EAAsCoB,MAAtC,CAAL;EACApB,KAAK,CAAC,mDAAD,EAAsDe,SAAS,CAACM,MAAhE,CAAL;;EAEA,KAAK,MAAM,CAACC,CAAD,EAAInB,EAAJ,CAAX,IAAsBY,SAAS,CAACQ,OAAV,EAAtB,EAA2C;IACzC,IAAI;MACF,MAAMpB,EAAE,EAAR;IACD,CAFD,CAEE,OAAOqB,CAAP,EAAe;MACfxB,KAAK,CAAC,0CAAD,EAA6CsB,CAA7C,EAAgDE,CAAhD,CAAL;IACD;EACF;;EAEDxB,KAAK,CAAC,8CAAD,EAAiDyB,OAAO,CAACC,QAAR,GAAmBD,OAAO,CAACC,QAA3B,GAAsC,CAAvF,CAAL;EAEAD,OAAO,CAACE,IAAR;AACD,CAfG,CADN;;AAkBA,KAAK,MAAMP,MAAX,IAAqBF,mBAArB,EAA0C;EACxCO,OAAO,CAACG,EAAR,CAAWR,MAAX,EAAmBD,wBAAwB,CAACC,MAAD,CAA3C;AACD"}