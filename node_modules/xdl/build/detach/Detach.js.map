{"version":3,"file":"Detach.js","names":["SERVICE_CONTEXT_PROJECT_NAME","ensureBuildConstantsExistsIOSAsync","configFilePath","doesBuildConstantsExist","fs","existsSync","path","join","IosPlist","createBlankAsync","logger","info","_getIosExpoKitVersionThrowErrorAsync","iosProjectDirectory","expoKitVersion","podfileLockPath","podfileLock","readFile","expoKitVersionRegex","match","exec","Error","e","readNullableConfigJsonAsync","projectDir","getConfig","prepareDetachedBuildIosAsync","args","config","exp","name","prepareDetachedUserContextIosAsync","prepareDetachedServiceContextIosAsync","expoRootDir","workspaceSourcePath","buildFlags","StandaloneBuildFlags","createIos","context","StandaloneContext","createServiceContext","supportingDirectory","IosWorkspace","getPaths","prodApiKeys","_readDefaultApiKeysAsync","data","expoSourcePath","skipSDKVersionRequirement","modifyAsync","constantsConfig","contextType","STANDALONE_CONTEXT_TYPE","EXPO_RUNTIME_VERSION","API_SERVER_ENDPOINT","process","env","ENVIRONMENT","DEFAULT_API_KEYS","sdkVersion","TEMPORARY_SDK_VERSION","jsonFilePath","keys","allKeys","JsonFile","readAsync","validKeys","key","hasOwnProperty","includes","createUserContext","podsDirectory","ExponentTools","isDirectory","rnPodDirectory","rnFilesToDelete","globSync","absolute","cwd","i","length","unlink","skipXcodeConfig","devUrl","UrlUtils","constructManifestUrlAsync","defaultApiKeys","developmentUrl","prepareDetachedBuildAsync","platform","expoBuildConstantsMatches","expoBuildConstants","regexFileAsync","bundleAssetsAsync","options","bundledManifestPath","EmbeddedAssets","getEmbeddedManifestPath","warn","manifest","JSON","parse","ex","message","Object","AssetBundle","bundleAsync","bundledAssets","dest","getExportUrl","bundleUrl","DEFAULT_CDN_HOST","bundleUrlParts","split","slice"],"sources":["../../src/detach/Detach.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport JsonFile from '@expo/json-file';\nimport fs from 'fs-extra';\nimport { sync as globSync } from 'glob';\nimport path from 'path';\n\nimport {\n  AssetBundle,\n  EmbeddedAssets,\n  ExponentTools,\n  IosPlist,\n  IosWorkspace,\n  LoggerDetach as logger,\n  StandaloneBuildFlags,\n  StandaloneContext,\n  UrlUtils,\n} from '../internal';\n\nconst SERVICE_CONTEXT_PROJECT_NAME = 'exponent-view-template';\n\nasync function ensureBuildConstantsExistsIOSAsync(configFilePath: string) {\n  // EXBuildConstants is included in newer ExpoKit projects.\n  // create it if it doesn't exist.\n  const doesBuildConstantsExist = fs.existsSync(\n    path.join(configFilePath, 'EXBuildConstants.plist')\n  );\n  if (!doesBuildConstantsExist) {\n    await IosPlist.createBlankAsync(configFilePath, 'EXBuildConstants');\n    logger.info('Created `EXBuildConstants.plist` because it did not exist yet');\n  }\n}\n\nasync function _getIosExpoKitVersionThrowErrorAsync(iosProjectDirectory: string) {\n  let expoKitVersion = '';\n  const podfileLockPath = path.join(iosProjectDirectory, 'Podfile.lock');\n  try {\n    const podfileLock = await fs.readFile(podfileLockPath, 'utf8');\n    const expoKitVersionRegex = /ExpoKit\\/Core\\W?\\(([0-9.]+)\\)/gi;\n    const match = expoKitVersionRegex.exec(podfileLock);\n    if (!match) {\n      throw new Error('ExpoKit/Core not found');\n    }\n    expoKitVersion = match[1];\n  } catch (e: any) {\n    throw new Error(\n      `Unable to read ExpoKit version from Podfile.lock. Make sure your project depends on ExpoKit. (${e})`\n    );\n  }\n  return expoKitVersion;\n}\n\nasync function readNullableConfigJsonAsync(projectDir: string) {\n  try {\n    return getConfig(projectDir);\n  } catch {\n    return null;\n  }\n}\n\nasync function prepareDetachedBuildIosAsync(projectDir: string, args: any) {\n  const config = await readNullableConfigJsonAsync(projectDir);\n  if (config && config.exp.name !== SERVICE_CONTEXT_PROJECT_NAME) {\n    return prepareDetachedUserContextIosAsync(projectDir, config.exp, args);\n  } else {\n    return prepareDetachedServiceContextIosAsync(projectDir, args);\n  }\n}\n\nasync function prepareDetachedServiceContextIosAsync(projectDir: string, args: any) {\n  // service context\n  // TODO: very brittle hack: the paths here are hard coded to match the single workspace\n  // path generated inside IosShellApp. When we support more than one path, this needs to\n  // be smarter.\n  const expoRootDir = path.join(projectDir, '..', '..');\n  const workspaceSourcePath = path.join(projectDir, 'ios');\n  const buildFlags = StandaloneBuildFlags.createIos('Release', { workspaceSourcePath });\n  // @ts-ignore missing 9th argument\n  const context = StandaloneContext.createServiceContext(\n    expoRootDir,\n    null,\n    null,\n    null,\n    /* testEnvironment */ 'none',\n    buildFlags,\n    null,\n    null\n  );\n  const { iosProjectDirectory, supportingDirectory } = IosWorkspace.getPaths(context);\n  const expoKitVersion = await _getIosExpoKitVersionThrowErrorAsync(iosProjectDirectory);\n\n  // use prod api keys if available\n  const prodApiKeys = await _readDefaultApiKeysAsync(\n    path.join(context.data.expoSourcePath, '__internal__', 'keys.json')\n  );\n\n  const { exp } = getConfig(expoRootDir, { skipSDKVersionRequirement: true });\n\n  await IosPlist.modifyAsync(supportingDirectory, 'EXBuildConstants', constantsConfig => {\n    // verify that we are actually in a service context and not a misconfigured project\n    const contextType = constantsConfig.STANDALONE_CONTEXT_TYPE;\n    if (contextType !== 'service') {\n      throw new Error(\n        'Unable to configure a project which has no app.json and also no STANDALONE_CONTEXT_TYPE.'\n      );\n    }\n    constantsConfig.EXPO_RUNTIME_VERSION = expoKitVersion;\n    constantsConfig.API_SERVER_ENDPOINT =\n      process.env.ENVIRONMENT === 'staging'\n        ? 'https://staging.exp.host/--/api/v2/'\n        : 'https://exp.host/--/api/v2/';\n    if (prodApiKeys) {\n      constantsConfig.DEFAULT_API_KEYS = prodApiKeys;\n    }\n    if (exp && exp.sdkVersion) {\n      constantsConfig.TEMPORARY_SDK_VERSION = exp.sdkVersion;\n    }\n    return constantsConfig;\n  });\n}\n\nasync function _readDefaultApiKeysAsync(jsonFilePath: string) {\n  if (fs.existsSync(jsonFilePath)) {\n    const keys: any = {};\n    const allKeys = await new JsonFile(jsonFilePath).readAsync();\n    const validKeys = ['AMPLITUDE_KEY', 'GOOGLE_MAPS_IOS_API_KEY'];\n    for (const key in allKeys) {\n      if (allKeys.hasOwnProperty(key) && validKeys.includes(key)) {\n        keys[key] = allKeys[key];\n      }\n    }\n    return keys;\n  }\n  return null;\n}\n\nasync function prepareDetachedUserContextIosAsync(projectDir: string, exp: ExpoConfig, args: any) {\n  const context = StandaloneContext.createUserContext(projectDir, exp);\n  const { iosProjectDirectory, supportingDirectory } = IosWorkspace.getPaths(context);\n\n  logger.info(`Preparing iOS build at ${iosProjectDirectory}...`);\n  // These files cause @providesModule naming collisions\n  // but are not available until after `pod install` has run.\n  const podsDirectory = path.join(iosProjectDirectory, 'Pods');\n  if (!ExponentTools.isDirectory(podsDirectory)) {\n    throw new Error(`Can't find directory ${podsDirectory}, make sure you've run pod install.`);\n  }\n  const rnPodDirectory = path.join(podsDirectory, 'React');\n  if (ExponentTools.isDirectory(rnPodDirectory)) {\n    const rnFilesToDelete = globSync('**/*.@(js|json)', {\n      absolute: true,\n      cwd: rnPodDirectory,\n    });\n    if (rnFilesToDelete) {\n      for (let i = 0; i < rnFilesToDelete.length; i++) {\n        await fs.unlink(rnFilesToDelete[i]);\n      }\n    }\n  }\n\n  // insert expo development url into iOS config\n  if (!args.skipXcodeConfig) {\n    // populate EXPO_RUNTIME_VERSION from ExpoKit pod version\n    const expoKitVersion = await _getIosExpoKitVersionThrowErrorAsync(iosProjectDirectory);\n\n    // populate development url\n    const devUrl = await UrlUtils.constructManifestUrlAsync(projectDir);\n\n    // populate default api keys\n    const defaultApiKeys = await _readDefaultApiKeysAsync(\n      path.join(podsDirectory, 'ExpoKit', 'template-files', 'keys.json')\n    );\n\n    await ensureBuildConstantsExistsIOSAsync(supportingDirectory);\n    await IosPlist.modifyAsync(supportingDirectory, 'EXBuildConstants', constantsConfig => {\n      constantsConfig.developmentUrl = devUrl;\n      constantsConfig.EXPO_RUNTIME_VERSION = expoKitVersion;\n      if (defaultApiKeys) {\n        constantsConfig.DEFAULT_API_KEYS = defaultApiKeys;\n      }\n      if (exp.sdkVersion) {\n        constantsConfig.TEMPORARY_SDK_VERSION = exp.sdkVersion;\n      }\n      return constantsConfig;\n    });\n  }\n}\n\nexport async function prepareDetachedBuildAsync(projectDir: string, args: any) {\n  if (args.platform === 'ios') {\n    await prepareDetachedBuildIosAsync(projectDir, args);\n  } else {\n    const expoBuildConstantsMatches = globSync('android/**/DetachBuildConstants.java', {\n      absolute: true,\n      cwd: projectDir,\n    });\n    if (expoBuildConstantsMatches && expoBuildConstantsMatches.length) {\n      const expoBuildConstants = expoBuildConstantsMatches[0];\n      const devUrl = await UrlUtils.constructManifestUrlAsync(projectDir);\n      await ExponentTools.regexFileAsync(\n        /DEVELOPMENT_URL = \"[^\"]*\";/,\n        `DEVELOPMENT_URL = \"${devUrl}\";`,\n        expoBuildConstants\n      );\n    }\n  }\n}\n\n// args.dest: string,\n// This is the path where assets will be copied to. It should be\n// `$CONFIGURATION_BUILD_DIR/$UNLOCALIZED_RESOURCES_FOLDER_PATH` on iOS\n// (see `exponent-view-template.xcodeproj/project.pbxproj` for an example)\n// and `$buildDir/intermediates/assets/$targetPath` on Android (see\n// `android/app/expo.gradle` for an example).\nexport async function bundleAssetsAsync(projectDir: string, args: any) {\n  const options = await readNullableConfigJsonAsync(projectDir);\n  if (!options || options.exp.name === SERVICE_CONTEXT_PROJECT_NAME) {\n    // Don't run assets bundling for the service context.\n    return;\n  }\n  const { exp } = options;\n  const bundledManifestPath = EmbeddedAssets.getEmbeddedManifestPath(\n    args.platform,\n    projectDir,\n    exp as any\n  );\n  if (!bundledManifestPath) {\n    logger.warn(\n      `Skipped assets bundling because the '${args.platform}.publishManifestPath' key is not specified in the app manifest.`\n    );\n    return;\n  }\n\n  let manifest;\n  try {\n    manifest = JSON.parse(await fs.readFile(bundledManifestPath, 'utf8'));\n  } catch (ex: any) {\n    throw new Error(\n      `Error reading the manifest file. Make sure the path '${bundledManifestPath}' is correct.\\n\\nError: ${ex.message}`\n    );\n  }\n  if (!manifest || !Object.keys(manifest).length) {\n    throw new Error(`The manifest at '${bundledManifestPath}' was empty or invalid.`);\n  }\n\n  await AssetBundle.bundleAsync(null, manifest.bundledAssets, args.dest, getExportUrl(manifest));\n}\n\n/**\n * This function extracts the exported public URL that is set in the manifest\n * when the developer runs `expo export --public-url x`. We use this to ensure\n * that we fetch the resources from the appropriate place when doing builds\n * against self-hosted apps.\n */\nfunction getExportUrl(manifest: any) {\n  const { bundleUrl } = manifest;\n  if (bundleUrl.includes(AssetBundle.DEFAULT_CDN_HOST)) {\n    return null;\n  }\n\n  try {\n    const bundleUrlParts = bundleUrl.split('/');\n    return bundleUrlParts.slice(0, bundleUrlParts.length - 2).join('/');\n  } catch {\n    throw Error(\n      `Expected bundleUrl to be of the format https://domain/bundles/bundle-hash-id, ${bundleUrl} does not follow this format.`\n    );\n  }\n}\n"],"mappings":"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"}