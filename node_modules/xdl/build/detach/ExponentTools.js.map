{"version":3,"file":"ExponentTools.js","names":["saveUrlToPathAsync","url","path","timeout","response","axios","get","responseType","Promise","resolve","reject","stream","fs","createWriteStream","on","data","pipe","getManifestAsync","headers","options","buildPhaseLogger","logger","LoggerDetach","withFields","buildPhase","_retryPromise","replace","err","error","Error","info","JSON","stringify","fn","retries","spawnAsyncThrowError","command","args","stdio","cwd","process","pipeToLogger","promise","spawnAsyncQuiet","child","streams","stdout","stderr","pipeOutputToLogger","loggerFields","spawnAsync","e","message","isDirectory","dir","statSync","getResolvedLocalesAsync","projectRoot","exp","locales","undefined","lang","localePath","Object","entries","s","readFile","parse","XDLError","regexFileAsync","regex","filename","file","fileString","toString","writeFile","deleteLinesInFileAsync","startRegex","endRegex","lines","split","filteredLines","inDeleteRange","i","length","match","push","join"],"sources":["../../src/detach/ExponentTools.ts"],"sourcesContent":["import { ExpoConfig } from '@expo/config';\nimport spawnAsyncQuiet, { SpawnOptions, SpawnResult } from '@expo/spawn-async';\nimport axios from 'axios';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport { Readable } from 'stream';\n\nimport { LoggerDetach, pipeOutputToLogger, XDLError } from '../internal';\n\nasync function saveUrlToPathAsync(url: string, path: string, timeout = 20000) {\n  const response = await axios.get(url, { responseType: 'stream', timeout });\n\n  return new Promise(function (resolve, reject) {\n    const stream = fs.createWriteStream(path);\n    stream.on('close', resolve);\n    stream.on('error', reject);\n    response.data.on('error', reject).pipe(stream);\n  });\n}\n\nasync function getManifestAsync(url: string, headers: any, options: any = {}) {\n  const buildPhaseLogger =\n    options.logger || LoggerDetach.withFields({ buildPhase: 'reading manifest' });\n\n  let response;\n  try {\n    response = await _retryPromise(() => axios.get(url.replace('exp://', 'http://'), { headers }));\n  } catch (err: any) {\n    buildPhaseLogger.error(err);\n    throw new Error('Failed to fetch manifest from www');\n  }\n\n  buildPhaseLogger.info('Using manifest:', JSON.stringify(response.data, null, 2));\n  return response.data;\n}\n\nasync function _retryPromise<T>(fn: (...args: any[]) => T, retries = 5): Promise<T> {\n  try {\n    return await fn();\n  } catch (err: any) {\n    if (retries-- > 0) {\n      return await _retryPromise(fn, retries);\n    } else {\n      throw err;\n    }\n  }\n}\n\nexport type AsyncSpawnOptions = SpawnOptions & {\n  loggerFields?: any;\n  pipeToLogger?: boolean | { stdout?: boolean; stderr?: boolean };\n  stdoutOnly?: boolean;\n  loggerLineTransformer?: (line: any) => any;\n};\n\nasync function spawnAsyncThrowError(\n  command: string,\n  args: string[],\n  options: AsyncSpawnOptions = {\n    stdio: 'inherit',\n    cwd: process.cwd(),\n  }\n): Promise<SpawnResult> {\n  const { pipeToLogger } = options;\n  if (pipeToLogger) {\n    options.stdio = 'pipe';\n    options.cwd = options.cwd || process.cwd();\n  }\n  const promise = spawnAsyncQuiet(command, args, options);\n  if (pipeToLogger && promise.child) {\n    const streams: { stdout?: Readable | null; stderr?: Readable | null } = {};\n    if (pipeToLogger === true || pipeToLogger.stdout) {\n      streams.stdout = promise.child.stdout;\n    }\n    if (pipeToLogger === true || pipeToLogger.stderr) {\n      streams.stderr = promise.child.stderr;\n    }\n    pipeOutputToLogger(streams, options.loggerFields, options);\n  }\n  return promise;\n}\n\nasync function spawnAsync(\n  command: string,\n  args: string[],\n  options: SpawnOptions\n): Promise<SpawnResult | void> {\n  try {\n    return await spawnAsyncThrowError(command, args, options);\n  } catch (e: any) {\n    LoggerDetach.error(e.message);\n  }\n}\n\nfunction isDirectory(dir: string) {\n  try {\n    if (fs.statSync(dir).isDirectory()) {\n      return true;\n    }\n\n    return false;\n  } catch {\n    return false;\n  }\n}\n\ntype LocaleMap = { [lang: string]: any };\n\nasync function getResolvedLocalesAsync(projectRoot: string, exp: ExpoConfig): Promise<LocaleMap> {\n  const locales: LocaleMap = {};\n  if (exp.locales !== undefined) {\n    for (const [lang, localePath] of Object.entries(exp.locales)) {\n      const s = await fs.readFile(path.resolve(projectRoot, localePath as string), 'utf8');\n      try {\n        locales[lang] = JSON.parse(s);\n      } catch (e: any) {\n        throw new XDLError('INVALID_JSON', JSON.stringify(e));\n      }\n    }\n  }\n  return locales;\n}\n\nasync function regexFileAsync(\n  regex: RegExp | string,\n  replace: string,\n  filename: string\n): Promise<void> {\n  const file = await fs.readFile(filename);\n  const fileString = file.toString();\n  await fs.writeFile(filename, fileString.replace(regex, replace));\n}\n\n// Matches sed /d behavior\nasync function deleteLinesInFileAsync(\n  startRegex: RegExp | string,\n  endRegex: RegExp | string,\n  filename: string\n): Promise<void> {\n  const file = await fs.readFile(filename);\n  const fileString = file.toString();\n  const lines = fileString.split(/\\r?\\n/);\n  const filteredLines = [];\n  let inDeleteRange = false;\n  for (let i = 0; i < lines.length; i++) {\n    if (lines[i].match(startRegex)) {\n      inDeleteRange = true;\n    }\n\n    if (!inDeleteRange) {\n      filteredLines.push(lines[i]);\n    }\n\n    if (inDeleteRange && lines[i].match(endRegex)) {\n      inDeleteRange = false;\n    }\n  }\n  await fs.writeFile(filename, filteredLines.join('\\n'));\n}\n\nexport {\n  isDirectory,\n  saveUrlToPathAsync,\n  getManifestAsync,\n  spawnAsyncThrowError,\n  spawnAsync,\n  getResolvedLocalesAsync,\n  regexFileAsync,\n  deleteLinesInFileAsync,\n};\n"],"mappings":"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"}