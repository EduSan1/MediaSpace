{"version":3,"file":"Logger.js","names":["LogLevel","Logger","constructor","bunyanGetter","extraFields","loggerObj","bunyan","createLogger","name","loggerGetter","configure","withFields","getter","trace","all","logLine","debug","info","warn","error","fatal","level","args","argsToLog","extraFieldsFromArgsExist","isPlainObject","extraFieldsFromArgs","shift","isEmpty","unshift","LoggerDetach","pipeOutputToLogger","stdout","stderr","stdoutOnly","loggerLineTransformer","on","chunk","logMultiline","source","data","lines","String","split","forEach","line","lineToPrint"],"sources":["../../src/detach/Logger.ts"],"sourcesContent":["import bunyan from '@expo/bunyan';\nimport isEmpty from 'lodash/isEmpty';\nimport isPlainObject from 'lodash/isPlainObject';\nimport { Readable } from 'stream';\n\nexport enum LogLevel {\n  trace = 'trace',\n  debug = 'debug',\n  info = 'info',\n  warn = 'warn',\n  error = 'error',\n  fatal = 'fatal',\n}\n\ntype BunyanGetter = () => bunyan;\n\nexport class Logger {\n  loggerObj: bunyan;\n  loggerGetter?: BunyanGetter;\n  extraFields: any;\n\n  constructor(bunyanGetter?: BunyanGetter, extraFields?: any) {\n    this.loggerObj = bunyan.createLogger({ name: 'xdl-detach' });\n    this.loggerGetter = bunyanGetter;\n    this.extraFields = extraFields;\n  }\n\n  configure(loggerObj: bunyan) {\n    this.loggerObj = loggerObj;\n  }\n\n  withFields(extraFields: any) {\n    const getter = this.loggerGetter || (() => this.loggerObj);\n    return new Logger(getter, { ...this.extraFields, ...extraFields });\n  }\n\n  trace(...all: any[]) {\n    this.logLine(LogLevel.trace, ...all);\n  }\n  debug(...all: any[]) {\n    this.logLine(LogLevel.debug, ...all);\n  }\n  info(...all: any[]) {\n    this.logLine(LogLevel.info, ...all);\n  }\n  warn(...all: any[]) {\n    this.logLine(LogLevel.warn, ...all);\n  }\n  error(...all: any[]) {\n    this.logLine(LogLevel.error, ...all);\n  }\n  fatal(...all: any[]) {\n    this.logLine(LogLevel.fatal, ...all);\n  }\n\n  logLine(level: LogLevel, ...args: any[]) {\n    const argsToLog = [...args];\n    const extraFieldsFromArgsExist = isPlainObject(args[0]);\n    const extraFieldsFromArgs = extraFieldsFromArgsExist ? args[0] : {};\n    if (extraFieldsFromArgsExist) {\n      argsToLog.shift();\n    }\n    const extraFields = { ...extraFieldsFromArgs, ...this.extraFields };\n    if (!isEmpty(extraFields)) {\n      argsToLog.unshift(extraFields);\n    }\n\n    if (this.loggerGetter) {\n      const loggerObj = this.loggerGetter();\n      loggerObj[level](...argsToLog);\n    } else {\n      this.loggerObj[level](...argsToLog);\n    }\n  }\n}\n\nconst LoggerDetach = new Logger();\nexport default LoggerDetach;\n\nexport function pipeOutputToLogger(\n  { stdout, stderr }: { stdout?: Readable | null; stderr?: Readable | null } = {\n    stdout: null,\n    stderr: null,\n  },\n  extraFields = {},\n  {\n    stdoutOnly = false,\n    loggerLineTransformer,\n  }: { stdoutOnly?: boolean; loggerLineTransformer?: (line: any) => any } = {}\n) {\n  if (stdout) {\n    stdout.on('data', chunk =>\n      logMultiline(chunk, { ...extraFields, source: 'stdout' }, loggerLineTransformer)\n    );\n  }\n  if (stderr) {\n    const source = stdoutOnly ? 'stdout' : 'stderr';\n    stderr.on('data', chunk =>\n      logMultiline(chunk, { ...extraFields, source }, loggerLineTransformer)\n    );\n  }\n}\n\nfunction logMultiline(data: any, extraFields: any, loggerLineTransformer?: (line: any) => any) {\n  if (!data) {\n    return;\n  }\n  const lines = String(data).split('\\n');\n  lines.forEach(line => {\n    const lineToPrint = loggerLineTransformer ? loggerLineTransformer(line) : line;\n    if (lineToPrint) {\n      const args = [lineToPrint];\n      if (!isEmpty(extraFields)) {\n        args.unshift(extraFields);\n      }\n      LoggerDetach.info(...args);\n    }\n  });\n}\n"],"mappings":"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"}