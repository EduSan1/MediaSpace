{"version":3,"file":"AssetBundle.js","names":["EXPO_DOMAINS","DEFAULT_CDN_HOST","ASSETS_DIR_DEFAULT_URL","bundleAsync","context","assets","dest","exportUrl","fs","ensureDir","urlResolver","createAssetsUrlResolver","pMap","asset","downloadAssetAsync","concurrency","extensionIndex","lastIndexOf","prefixLength","length","hash","substring","console","log","pRetry","ExponentTools","saveUrlToPathAsync","path","join","retries","assetsDirUrl","published","url","assetUrlOverride","config","publishedUrl","hostname","parse","Error","maybeExpoDomain","split","slice","includes","resolve","urlJoin"],"sources":["../../src/detach/AssetBundle.ts"],"sourcesContent":["import fs from 'fs-extra';\nimport pMap from 'p-map';\nimport pRetry from 'p-retry';\nimport path from 'path';\nimport url from 'url';\nimport urlJoin from 'url-join';\n\nimport { AnyStandaloneContext, ExponentTools } from '../internal';\n\nconst EXPO_DOMAINS = ['expo.io', 'exp.host', 'expo.test', 'localhost'];\nexport const DEFAULT_CDN_HOST = 'https://classic-assets.eascdn.net';\nexport const ASSETS_DIR_DEFAULT_URL = `${DEFAULT_CDN_HOST}/~assets`;\n\ntype UrlResolver = (hash: string) => string;\n\nexport async function bundleAsync(\n  context: any,\n  assets: string[],\n  dest: string,\n  exportUrl?: string | null\n) {\n  if (!assets) {\n    return;\n  }\n\n  await fs.ensureDir(dest);\n\n  const urlResolver = createAssetsUrlResolver(context, exportUrl);\n  await pMap(assets, asset => downloadAssetAsync(urlResolver, dest, asset), { concurrency: 5 });\n}\n\nasync function downloadAssetAsync(urlResolver: UrlResolver, dest: string, asset: string) {\n  const extensionIndex = asset.lastIndexOf('.');\n  const prefixLength = 'asset_'.length;\n  const hash =\n    extensionIndex >= 0\n      ? asset.substring(prefixLength, extensionIndex)\n      : asset.substring(prefixLength);\n  console.log(urlResolver(hash));\n  await pRetry(() => ExponentTools.saveUrlToPathAsync(urlResolver(hash), path.join(dest, asset)), {\n    retries: 3,\n  });\n}\n\nfunction createAssetsUrlResolver(\n  context: AnyStandaloneContext,\n  exportUrl?: string | null\n): UrlResolver {\n  let assetsDirUrl = exportUrl ? `${exportUrl}/assets` : ASSETS_DIR_DEFAULT_URL;\n\n  if (context && context.published && context.published.url) {\n    const { assetUrlOverride = './assets' } = context.config;\n    const publishedUrl = context.published.url;\n    const { hostname } = url.parse(publishedUrl);\n    if (hostname == null) {\n      throw new Error(\n        `Could not resolve asset URLs relative to \"${publishedUrl}\". Published URL must be an absolute URL.`\n      );\n    }\n    const maybeExpoDomain = hostname.split('.').slice(-2).join('.');\n    if (!EXPO_DOMAINS.includes(maybeExpoDomain)) {\n      assetsDirUrl = url.resolve(publishedUrl, assetUrlOverride);\n    }\n  }\n\n  return hash => urlJoin(assetsDirUrl, hash);\n}\n"],"mappings":"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"}