{"version":3,"file":"LoadingPageHandler.js","names":["LoadingEndpoint","DeepLinkEndpoint","onDeepLink","setOnDeepLink","listener","getPlatform","query","userAgent","match","getRuntimeVersion","exp","platform","getRuntimeVersionNullable","noCacheMiddleware","res","setHeader","loadingEndpointHandler","projectRoot","req","content","readFile","resolve","__dirname","toString","getConfig","skipSDKVersionRequirement","scheme","ProjectSettings","readAsync","appName","getNameFromConfig","parse","url","headers","runtimeVersion","replace","getSDKVersion","end","deeplinkEndpointHandler","isDevClient","projectUrl","UrlUtils","constructDevClientUrlAsync","constructManifestUrlAsync","statusCode","getLoadingPageHandler","next","pathname","exception","JSON","stringify","error"],"sources":["../../src/start/LoadingPageHandler.ts"],"sourcesContent":["import { ExpoConfig, getConfig, getNameFromConfig } from '@expo/config';\nimport { getRuntimeVersionNullable, getSDKVersion } from '@expo/config-plugins/build/utils/Updates';\nimport express from 'express';\nimport { readFile } from 'fs-extra';\nimport http from 'http';\nimport { resolve } from 'path';\nimport { parse } from 'url';\n\nimport { ProjectSettings, UrlUtils } from './../internal';\n\nexport const LoadingEndpoint = '/_expo/loading';\nexport const DeepLinkEndpoint = '/_expo/link';\n\ntype OnDeepLinkListener = (\n  projectRoot: string,\n  isDevClient: boolean,\n  platform: string | null\n) => Promise<void>;\n\nlet onDeepLink: OnDeepLinkListener = async () => {};\n\nexport function setOnDeepLink(listener: OnDeepLinkListener) {\n  onDeepLink = listener;\n}\n\nfunction getPlatform(\n  query: { [x: string]: string | string[] | null },\n  userAgent: string | null = null\n): 'android' | 'ios' | null {\n  if (query['platform'] === 'android' || query['platform'] === 'ios') {\n    return query['platform'];\n  }\n\n  if (userAgent?.match(/Android/i)) {\n    return 'android';\n  }\n\n  if (userAgent?.match(/iPhone|iPad/i)) {\n    return 'ios';\n  }\n\n  return null;\n}\n\nfunction getRuntimeVersion(exp: ExpoConfig, platform: 'android' | 'ios' | null) {\n  if (!platform) {\n    return null;\n  }\n\n  return getRuntimeVersionNullable(exp, platform);\n}\n\nexport function noCacheMiddleware(\n  res: express.Response | http.ServerResponse\n): express.Response | http.ServerResponse {\n  res.setHeader('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n  res.setHeader('Expires', '-1');\n  res.setHeader('Pragma', 'no-cache');\n  return res;\n}\n\nasync function loadingEndpointHandler(\n  projectRoot: string,\n  req: express.Request | http.IncomingMessage,\n  res: express.Response | http.ServerResponse\n) {\n  res.setHeader('Content-Type', 'text/html');\n\n  let content = (\n    await readFile(resolve(__dirname, './../../static/loading-page/index.html'))\n  ).toString('utf-8');\n\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const { scheme } = await ProjectSettings.readAsync(projectRoot);\n  const { appName } = getNameFromConfig(exp);\n  const { query } = parse(req.url!, true);\n  const platform = getPlatform(query, req.headers['user-agent']);\n  const runtimeVersion = getRuntimeVersion(exp, platform);\n\n  content = content.replace(/{{\\s*AppName\\s*}}/, appName ?? 'App');\n\n  content = content.replace(\n    /{{\\s*ProjectVersionType\\s*}}/,\n    runtimeVersion ? 'Runtime version' : 'SDK version'\n  );\n\n  content = content.replace(\n    /{{\\s*ProjectVersion\\s*}}/,\n    runtimeVersion ? runtimeVersion : getSDKVersion(exp) ?? 'Undetected'\n  );\n\n  content = content.replace(/{{\\s*Path\\s*}}/, projectRoot);\n  content = content.replace(/{{\\s*Scheme\\s*}}/, scheme ?? 'Unknown');\n\n  res.end(content);\n}\n\nasync function deeplinkEndpointHandler(\n  projectRoot: string,\n  req: express.Request | http.IncomingMessage,\n  res: express.Response | http.ServerResponse\n) {\n  const { query } = parse(req.url!, true);\n  const isDevClient = query['choice'] === 'expo-dev-client';\n  const projectUrl = isDevClient\n    ? await UrlUtils.constructDevClientUrlAsync(projectRoot)\n    : await UrlUtils.constructManifestUrlAsync(projectRoot);\n\n  res.setHeader('Location', projectUrl);\n\n  onDeepLink(projectRoot, isDevClient, getPlatform(query, req.headers['user-agent']));\n\n  res.setHeader('Cache-Control', 'private, no-cache, no-store, must-revalidate');\n  res.setHeader('Expires', '-1');\n  res.setHeader('Pragma', 'no-cache');\n\n  res.statusCode = 307;\n  res.end();\n}\n\nexport function getLoadingPageHandler(projectRoot: string) {\n  return async (\n    req: express.Request | http.IncomingMessage,\n    res: express.Response | http.ServerResponse,\n    next: (err?: Error) => void\n  ) => {\n    if (!req.url) {\n      next();\n      return;\n    }\n\n    try {\n      const url = parse(req.url).pathname || req.url;\n      switch (url) {\n        case LoadingEndpoint:\n          await loadingEndpointHandler(projectRoot, req, noCacheMiddleware(res));\n          break;\n        case DeepLinkEndpoint:\n          await deeplinkEndpointHandler(projectRoot, req, noCacheMiddleware(res));\n          break;\n        default:\n          next();\n      }\n    } catch (exception) {\n      res.statusCode = 520;\n      if (typeof exception == 'object' && exception != null) {\n        res.end(\n          JSON.stringify({\n            error: exception.toString(),\n          })\n        );\n      } else {\n        res.end(`Unexpected error: ${exception}`);\n      }\n    }\n  };\n}\n"],"mappings":"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"}