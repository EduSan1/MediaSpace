{"version":3,"file":"startLegacyExpoServerAsync.js","names":["_isIgnorableBugReportingExtraData","body","length","_isAppRegistryStartupMessage","test","_handleDeviceLogs","projectRoot","deviceId","deviceName","logs","i","log","level","args","map","obj","JSON","stringify","toString","logLevel","ProjectUtils","getLogger","tag","groupDepth","shouldHide","includesStack","startExpoServerAsync","assertValidProjectRoot","stopExpoServerAsync","app","express","use","json","limit","urlencoded","extended","ConnectionStatus","isOffline","Doctor","validateWithoutNetworkAsync","validateWithNetworkAsync","FATAL","Error","manifestHandler","ManifestHandler","getManifestHandler","loadingHandler","LoadingPageHandler","getLoadingPageHandler","get","LoadingEndpoint","DeepLinkEndpoint","post","req","res","e","logError","stack","send","server","close","expRc","readExpRcAsync","expoServerPort","manifestPort","getFreePortAsync","ProjectSettings","setPackagerInfoAsync","listen","info","address","host","port","logDebug","packagerInfo","readPackagerInfoAsync","axios","request","method","url"],"sources":["../../src/start/startLegacyExpoServerAsync.ts"],"sourcesContent":["import { readExpRcAsync } from '@expo/config';\nimport axios from 'axios';\nimport express from 'express';\nimport { AddressInfo } from 'net';\n\nimport {\n  assertValidProjectRoot,\n  ConnectionStatus,\n  Doctor,\n  getFreePortAsync,\n  LoadingPageHandler,\n  ManifestHandler,\n  ProjectSettings,\n  ProjectUtils,\n} from '../internal';\n\ntype ConsoleLogLevel = 'info' | 'warn' | 'error' | 'debug';\n\nfunction _isIgnorableBugReportingExtraData(body: any[]) {\n  return body.length === 2 && body[0] === 'BugReporting extraData:';\n}\n\nfunction _isAppRegistryStartupMessage(body: any[]) {\n  return (\n    body.length === 1 &&\n    (/^Running application \"main\" with appParams:/.test(body[0]) ||\n      /^Running \"main\" with \\{/.test(body[0]))\n  );\n}\n\nfunction _handleDeviceLogs(projectRoot: string, deviceId: string, deviceName: string, logs: any) {\n  for (let i = 0; i < logs.length; i++) {\n    const log = logs[i];\n    let body = typeof log.body === 'string' ? [log.body] : log.body;\n    let { level } = log;\n\n    if (_isIgnorableBugReportingExtraData(body)) {\n      level = 'debug';\n    }\n    if (_isAppRegistryStartupMessage(body)) {\n      body = [`Running application on ${deviceName}.`];\n    }\n\n    const args = body.map((obj: any) => {\n      if (typeof obj === 'undefined') {\n        return 'undefined';\n      }\n      if (obj === 'null') {\n        return 'null';\n      }\n      if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {\n        return obj;\n      }\n      try {\n        return JSON.stringify(obj);\n      } catch {\n        return obj.toString();\n      }\n    });\n    const logLevel =\n      level === 'info' || level === 'warn' || level === 'error' || level === 'debug'\n        ? (level as ConsoleLogLevel)\n        : 'info';\n    ProjectUtils.getLogger(projectRoot)[logLevel](\n      {\n        tag: 'device',\n        deviceId,\n        deviceName,\n        groupDepth: log.groupDepth,\n        shouldHide: log.shouldHide,\n        includesStack: log.includesStack,\n      },\n      ...args\n    );\n  }\n}\n\nexport async function startExpoServerAsync(projectRoot: string): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  await stopExpoServerAsync(projectRoot);\n  const app = express();\n  app.use(\n    express.json({\n      limit: '10mb',\n    })\n  );\n  app.use(\n    express.urlencoded({\n      limit: '10mb',\n      extended: true,\n    })\n  );\n  if (\n    (ConnectionStatus.isOffline()\n      ? await Doctor.validateWithoutNetworkAsync(projectRoot)\n      : await Doctor.validateWithNetworkAsync(projectRoot)) === Doctor.FATAL\n  ) {\n    throw new Error(`Couldn't start project. Please fix the errors and restart the project.`);\n  }\n  // Serve the manifest.\n  const manifestHandler = ManifestHandler.getManifestHandler(projectRoot);\n  const loadingHandler = LoadingPageHandler.getLoadingPageHandler(projectRoot);\n  app.get('/', manifestHandler);\n  app.get('/manifest', manifestHandler);\n  app.get('/index.exp', manifestHandler);\n  app.get(LoadingPageHandler.LoadingEndpoint, loadingHandler);\n  app.get(LoadingPageHandler.DeepLinkEndpoint, loadingHandler);\n  app.post('/logs', async (req, res) => {\n    try {\n      const deviceId = req.get('Device-Id');\n      const deviceName = req.get('Device-Name');\n      if (deviceId && deviceName && req.body) {\n        _handleDeviceLogs(projectRoot, deviceId, deviceName, req.body);\n      }\n    } catch (e: any) {\n      ProjectUtils.logError(projectRoot, 'expo', `Error getting device logs: ${e} ${e.stack}`);\n    }\n    res.send('Success');\n  });\n  app.post('/shutdown', async (req, res) => {\n    server.close();\n    res.send('Success');\n  });\n  const expRc = await readExpRcAsync(projectRoot);\n  const expoServerPort = expRc.manifestPort ? expRc.manifestPort : await getFreePortAsync(19000);\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort,\n  });\n  let server = app.listen(expoServerPort, () => {\n    const info = server.address() as AddressInfo;\n    const host = info.address;\n    const port = info.port;\n    ProjectUtils.logDebug(projectRoot, 'expo', `Local server listening at http://${host}:${port}`);\n  });\n}\n\nexport async function stopExpoServerAsync(projectRoot: string): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  const packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (packagerInfo && packagerInfo.expoServerPort) {\n    try {\n      await axios.request({\n        method: 'post',\n        url: `http://127.0.0.1:${packagerInfo.expoServerPort}/shutdown`,\n      });\n    } catch {}\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: null,\n  });\n}\n"],"mappings":"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"}