{"version":3,"file":"PackagerLogsStream.js","names":["PackagerLogsStream","constructor","projectRoot","getCurrentOpenProjectId","updateLogs","onStartBuildBundle","onProgressBuildBundle","onFinishBuildBundle","getSnippetForError","chunk","msg","bundleDetails","bundleDetailsCache","buildID","type","String","_metroEventType","_handleNewBundleTransformStarted","_bundleBuildChunkID","_handleUpdateBundleTransformProgress","_updateLogs","logs","_logsToAdd","length","nextLogs","concat","match","replace","_projectRoot","_getCurrentOpenProjectId","_onStartBuildBundle","_onProgressBuildBundle","_onFinishBuildBundle","_getSnippetForError","_attachLoggerStream","projectId","ProjectUtils","attachLoggerStream","stream","write","_handleChunk","bind","tag","_maybeParseMsgJSON","_cleanUpNodeErrors","_handleMetroEvent","_enqueueAppendLogChunk","originalChunk","includes","getenv","boolish","_handleBundleTransformEvent","code","error","port","_formatModuleResolutionError","_formatBundlingError","level","Logger","ERROR","warning","WARN","reason","_formatWorkerChunk","JSON","stringify","getPlatformTagForBuildDetails","platform","formatted","ios","android","web","chalk","bold","id","_bundleBuildStart","Date","progressChunk","percentProgress","bundleComplete","duration","getTime","percentage","transformedFileCount","totalFileCount","roundedPercentProgress","Math","floor","progress","start","end","forEach","log","message","exec","originModulePath","moduleName","relativePath","path","relative","DOCS_PAGE_URL","NODE_STDLIB_MODULES","Array","isArray","errors","description","red","snippet","isAmbiguousError","name","isComprehensiveTransformError","filename","stack","gray","origin","shouldHide","push","_enqueueFlushLogsToAdd","parsedMsg","parse"],"sources":["../../src/logs/PackagerLogsStream.ts"],"sourcesContent":["import { JSONObject } from '@expo/json-file';\nimport chalk from 'chalk';\nimport getenv from 'getenv';\nimport path from 'path';\n\nimport { Logger, ProjectUtils } from '../internal';\n\ntype BuildEventType =\n  | 'METRO_INITIALIZE_STARTED'\n  | 'BUILD_STARTED'\n  | 'BUILD_PROGRESS'\n  | 'BUILD_FAILED'\n  | 'BUILD_DONE';\ntype MetroLogRecord = {\n  tag: 'metro';\n  id: string;\n  shouldHide: boolean;\n  msg: ReportableEvent | string;\n  level: number;\n  _metroEventType?: BuildEventType;\n};\ntype ExpoLogRecord = {\n  tag: 'expo';\n  id: string;\n  shouldHide: boolean;\n  msg: any;\n  level: number;\n};\ntype DeviceLogRecord = {\n  tag: 'device';\n  id: string;\n  shouldHide: boolean;\n  msg: any;\n  level: number;\n  deviceId: string;\n  deviceName: string;\n};\nexport type LogRecord = (MetroLogRecord | ExpoLogRecord | DeviceLogRecord) & ProjectUtils.LogFields;\n\nexport type LogUpdater = (logState: LogRecord[]) => LogRecord[];\n\ntype ErrorObject = {\n  name?: string;\n  stack?: string;\n  message?: string;\n  code?: string;\n} & JSONObject;\n\ntype MetroError =\n  | ({\n      originModulePath: string;\n      message: string;\n      errors: { description: string; filename: string; lineNumber: number }[];\n    } & ErrorObject)\n  | ({\n      type: 'TransformError';\n      snippet: string;\n      lineNumber: number;\n      column: number;\n      filename: string;\n      errors: { description: string; filename: string; lineNumber: number }[];\n    } & ErrorObject)\n  | ErrorObject;\n\n// Metro reporter types\n// https://github.com/facebook/metro/blob/2a327fb19dd62169ab3ae9069011d8a599cfcf3e/packages/metro/src/lib/reporting.js\ntype GlobalCacheDisabledReason = 'too_many_errors' | 'too_many_misses';\ntype BundleDetails = {\n  entryFile: string;\n  platform: string;\n  dev: boolean;\n  minify: boolean;\n  bundleType: string;\n};\ntype ReportableEvent =\n  | {\n      port: number | undefined;\n      projectRoots: readonly string[];\n      type: 'initialize_started';\n    }\n  | {\n      type: 'initialize_done';\n    }\n  | {\n      type: 'client_log';\n      data: any;\n    }\n  | {\n      type: 'initialize_failed';\n      port: number;\n      error: MetroError;\n    }\n  | {\n      buildID: string;\n      type: 'bundle_build_done';\n    }\n  | {\n      buildID: string;\n      type: 'bundle_build_failed';\n    }\n  | {\n      buildID: string;\n      bundleDetails: BundleDetails;\n      type: 'bundle_build_started';\n    }\n  | {\n      error: MetroError;\n      type: 'bundling_error';\n    }\n  | {\n      // Currently only sent from Webpack\n      warning: string;\n      type: 'bundling_warning';\n    }\n  | {\n      type: 'dep_graph_loading';\n    }\n  | {\n      type: 'dep_graph_loaded';\n    }\n  | {\n      buildID: string;\n      type: 'bundle_transform_progressed';\n      transformedFileCount: number;\n      totalFileCount: number;\n\n      // A special property added for webpack support\n      percentage?: number;\n    }\n  | {\n      type: 'global_cache_error';\n      error: MetroError;\n    }\n  | {\n      type: 'global_cache_disabled';\n      reason: GlobalCacheDisabledReason;\n    }\n  | {\n      type: 'transform_cache_reset';\n    }\n  | {\n      type: 'worker_stdout_chunk';\n      chunk: string;\n    }\n  | {\n      type: 'worker_stderr_chunk';\n      chunk: string;\n    }\n  | {\n      type: 'transformer_load_started';\n    }\n  | {\n      type: 'transformer_load_done';\n    }\n  | {\n      type: 'hmr_client_error';\n      error: MetroError;\n    };\n\ntype StartBuildBundleCallback = (props: {\n  chunk: LogRecord;\n  bundleDetails: BundleDetails | null;\n}) => void;\ntype ProgressBuildBundleCallback = (props: {\n  progress: number;\n  start: Date | null;\n  chunk: any;\n  bundleDetails: BundleDetails | null;\n}) => void;\ntype FinishBuildBundleCallback = (props: {\n  error: string | null;\n  start: Date;\n  end: Date;\n  chunk: MetroLogRecord;\n  bundleDetails: BundleDetails | null;\n}) => void;\n\nexport default class PackagerLogsStream {\n  _projectRoot: string;\n  _getCurrentOpenProjectId: () => any;\n  _updateLogs: (updater: LogUpdater) => void;\n  _logsToAdd: LogRecord[] = [];\n  _bundleBuildChunkID: string | null = null;\n  _onStartBuildBundle?: StartBuildBundleCallback;\n  _onProgressBuildBundle?: ProgressBuildBundleCallback;\n  _onFinishBuildBundle?: FinishBuildBundleCallback;\n  _bundleBuildStart: Date | null = null;\n  _getSnippetForError?: (error: MetroError) => string | null;\n\n  constructor({\n    projectRoot,\n    getCurrentOpenProjectId,\n    updateLogs,\n    onStartBuildBundle,\n    onProgressBuildBundle,\n    onFinishBuildBundle,\n    getSnippetForError,\n  }: {\n    projectRoot: string;\n    getCurrentOpenProjectId?: () => any;\n    updateLogs: (updater: LogUpdater) => void;\n    onStartBuildBundle?: StartBuildBundleCallback;\n    onProgressBuildBundle?: ProgressBuildBundleCallback;\n    onFinishBuildBundle?: FinishBuildBundleCallback;\n    getSnippetForError?: (error: MetroError) => string | null;\n  }) {\n    this._projectRoot = projectRoot;\n    this._getCurrentOpenProjectId = getCurrentOpenProjectId || (() => 1);\n    this._updateLogs = updateLogs;\n\n    // Optional properties in case the consumer wants to handle updates on\n    // its own, eg: for a progress bar\n    this._onStartBuildBundle = onStartBuildBundle;\n    this._onProgressBuildBundle = onProgressBuildBundle;\n    this._onFinishBuildBundle = onFinishBuildBundle;\n\n    // Optional function for creating custom code frame snippet\n    // (e.g. with terminal colors) from a syntax error.\n    this._getSnippetForError = getSnippetForError;\n\n    this._attachLoggerStream();\n  }\n\n  projectId?: number;\n\n  _attachLoggerStream() {\n    this.projectId = this._getCurrentOpenProjectId();\n\n    ProjectUtils.attachLoggerStream(this._projectRoot, {\n      stream: {\n        write: this._handleChunk.bind(this),\n      },\n      type: 'raw',\n    });\n  }\n\n  _handleChunk(chunk: LogRecord) {\n    if (chunk.tag !== 'metro' && chunk.tag !== 'expo') {\n      return;\n    } else if (this._getCurrentOpenProjectId() !== this.projectId) {\n      // TODO: We should be confident that we are properly unsubscribing\n      // from the stream rather than doing a defensive check like this.\n      return;\n    }\n\n    chunk = this._maybeParseMsgJSON(chunk);\n    chunk = this._cleanUpNodeErrors(chunk);\n    if (chunk.tag === 'metro') {\n      this._handleMetroEvent(chunk);\n    } else if (typeof chunk.msg === 'string' && chunk.msg.match(/\\w/) && chunk.msg[0] !== '{') {\n      this._enqueueAppendLogChunk(chunk);\n    }\n  }\n\n  _handleMetroEvent(originalChunk: MetroLogRecord) {\n    const chunk = { ...originalChunk };\n    const { msg } = chunk;\n\n    if (typeof msg === 'string') {\n      if ((msg as string).includes('HTTP/1.1') && !getenv.boolish('EXPO_DEBUG', false)) {\n        // Do nothing with this message - we want to filter out network requests logged by Metro.\n      } else {\n        // If Metro crashes for some reason, it may log an error message as a plain string to stderr.\n        this._enqueueAppendLogChunk(chunk);\n      }\n      return;\n    }\n\n    switch (msg.type) {\n      // Bundle transform events\n      case 'bundle_build_started':\n      case 'bundle_transform_progressed':\n      case 'bundle_build_failed':\n      case 'bundle_build_done':\n        this._handleBundleTransformEvent(chunk);\n        return;\n\n      case 'initialize_started':\n        chunk._metroEventType = 'METRO_INITIALIZE_STARTED';\n        chunk.msg = 'Starting Metro Bundler';\n        break;\n      case 'initialize_done':\n        chunk.msg = `Started Metro Bundler`;\n        break;\n      case 'initialize_failed': {\n        // SDK <=22\n        const code = msg.error.code;\n        chunk.msg =\n          code === 'EADDRINUSE'\n            ? `Metro Bundler can't listen on port ${msg.port}. The port is in use.`\n            : `Metro Bundler failed to start. (code: ${code})`;\n        break;\n      }\n      case 'bundling_error':\n        chunk.msg =\n          this._formatModuleResolutionError(msg.error) ||\n          this._formatBundlingError(msg.error) ||\n          msg;\n        chunk.level = Logger.ERROR;\n        break;\n      case 'bundling_warning':\n        chunk.msg = msg.warning;\n        chunk.level = Logger.WARN;\n        break;\n      case 'transform_cache_reset':\n        chunk.msg =\n          'Your JavaScript transform cache is empty, rebuilding (this may take a minute).';\n        break;\n      case 'hmr_client_error':\n        chunk.msg = `A WebSocket client got a connection error. Please reload your device to get HMR working again.`;\n        break;\n      case 'global_cache_disabled':\n        if (msg.reason === 'too_many_errors') {\n          chunk.msg =\n            'The global cache is now disabled because it has been failing too many times.';\n        } else if (msg.reason === 'too_many_misses') {\n          chunk.msg = `The global cache is now disabled because it has been missing too many consecutive keys.`;\n        } else {\n          chunk.msg = `The global cache is now disabled. Reason: ${msg.reason}`;\n        }\n        break;\n      case 'worker_stdout_chunk':\n        chunk.msg = this._formatWorkerChunk('stdout', msg.chunk);\n        break;\n      case 'worker_stderr_chunk':\n        chunk.msg = this._formatWorkerChunk('stderr', msg.chunk);\n        break;\n      // Ignored events.\n      case 'client_log':\n      case 'dep_graph_loading':\n      case 'dep_graph_loaded':\n      case 'global_cache_error':\n      case 'transformer_load_started':\n      case 'transformer_load_done':\n        return;\n      default:\n        chunk.msg = `Unrecognized event: ${JSON.stringify(msg)}`;\n        break;\n    }\n    this._enqueueAppendLogChunk(chunk);\n  }\n\n  // A cache of { [buildID]: BundleDetails } which can be used to\n  // add more contextual logs. BundleDetails is currently only sent with `bundle_build_started`\n  // so we need to cache the details in order to print the platform info with other event types.\n  bundleDetailsCache: Record<string, BundleDetails> = {};\n\n  // Any event related to bundle building is handled here\n  _handleBundleTransformEvent = (chunk: MetroLogRecord) => {\n    const msg = chunk.msg as ReportableEvent;\n\n    const bundleDetails = 'buildID' in msg ? this.bundleDetailsCache[msg.buildID] || null : null;\n\n    if (msg.type === 'bundle_build_started') {\n      // Cache bundle details for later.\n      this.bundleDetailsCache[String(msg.buildID)] = msg.bundleDetails;\n      chunk._metroEventType = 'BUILD_STARTED';\n      this._handleNewBundleTransformStarted(chunk, msg.bundleDetails);\n    } else if (msg.type === 'bundle_transform_progressed' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_PROGRESS';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    } else if (msg.type === 'bundle_build_failed' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_FAILED';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    } else if (msg.type === 'bundle_build_done' && this._bundleBuildChunkID) {\n      chunk._metroEventType = 'BUILD_DONE';\n      this._handleUpdateBundleTransformProgress(chunk, bundleDetails);\n    }\n  };\n\n  static getPlatformTagForBuildDetails(bundleDetails?: BundleDetails | null) {\n    const platform = bundleDetails?.platform ?? null;\n    if (platform) {\n      const formatted = { ios: 'iOS', android: 'Android', web: 'Web' }[platform] || platform;\n      return `${chalk.bold(formatted)} `;\n    }\n\n    return '';\n  }\n\n  private _handleNewBundleTransformStarted(\n    chunk: MetroLogRecord,\n    bundleDetails: BundleDetails | null\n  ) {\n    if (this._bundleBuildChunkID) {\n      return;\n    }\n\n    this._bundleBuildChunkID = chunk.id;\n    this._bundleBuildStart = new Date();\n\n    chunk.msg = 'Building JavaScript bundle';\n\n    if (this._onStartBuildBundle) {\n      this._onStartBuildBundle({ chunk, bundleDetails });\n    } else {\n      this._enqueueAppendLogChunk(chunk);\n    }\n  }\n\n  private _handleUpdateBundleTransformProgress(\n    progressChunk: MetroLogRecord,\n    bundleDetails: BundleDetails | null\n  ) {\n    const msg = progressChunk.msg as ReportableEvent;\n\n    let percentProgress;\n    let bundleComplete = false;\n    if (msg.type === 'bundle_build_done') {\n      percentProgress = 100;\n      bundleComplete = true;\n      if (this._bundleBuildStart) {\n        const duration = new Date().getTime() - this._bundleBuildStart.getTime();\n        progressChunk.msg = `Building JavaScript bundle: finished in ${duration}ms.`;\n      } else {\n        progressChunk.msg = `Building JavaScript bundle: finished.`;\n      }\n    } else if (msg.type === 'bundle_build_failed') {\n      percentProgress = -1;\n      bundleComplete = true;\n      progressChunk.msg = `Building JavaScript bundle: error`;\n      progressChunk.level = Logger.ERROR;\n    } else if (msg.type === 'bundle_transform_progressed') {\n      if (msg.percentage) {\n        percentProgress = msg.percentage * 100;\n      } else {\n        percentProgress = (msg.transformedFileCount / msg.totalFileCount) * 100;\n        // percentProgress = Math.floor((msg.transformedFileCount / msg.totalFileCount) * 100);\n      }\n      const roundedPercentProgress = Math.floor(100 * percentProgress) / 100;\n      progressChunk.msg = `Building JavaScript bundle: ${roundedPercentProgress}%`;\n    } else {\n      return;\n    }\n\n    if (this._bundleBuildChunkID) {\n      progressChunk.id = this._bundleBuildChunkID;\n    }\n\n    if (this._onProgressBuildBundle) {\n      this._onProgressBuildBundle({\n        progress: percentProgress,\n        start: this._bundleBuildStart,\n        chunk: progressChunk,\n        bundleDetails,\n      });\n\n      if (bundleComplete) {\n        if (this._onFinishBuildBundle && this._bundleBuildStart) {\n          const error = msg.type === 'bundle_build_failed' ? 'Build failed' : null;\n          this._onFinishBuildBundle({\n            error,\n            start: this._bundleBuildStart,\n            end: new Date(),\n            chunk: progressChunk,\n            bundleDetails,\n          });\n        }\n        this._bundleBuildStart = null;\n        this._bundleBuildChunkID = null;\n      }\n    } else {\n      this._updateLogs(logs => {\n        if (!logs || !logs.length) {\n          return [];\n        }\n\n        logs.forEach(log => {\n          if (log.id === this._bundleBuildChunkID) {\n            log.msg = progressChunk.msg;\n          }\n        });\n\n        if (bundleComplete) {\n          this._bundleBuildChunkID = null;\n        }\n\n        return [...logs];\n      });\n    }\n  }\n\n  _formatModuleResolutionError(error: MetroError): string | null {\n    if (!error.message) {\n      return null;\n    }\n    const match = /^Unable to resolve module `(.+?)`/.exec(error.message);\n    const originModulePath = error.originModulePath as string | null;\n    if (!match || !originModulePath) {\n      return null;\n    }\n    const moduleName = match[1];\n    const relativePath = path.relative(this._projectRoot, originModulePath);\n\n    const DOCS_PAGE_URL =\n      'https://docs.expo.dev/workflow/using-libraries/#using-third-party-libraries';\n\n    if (NODE_STDLIB_MODULES.includes(moduleName)) {\n      if (originModulePath.includes('node_modules')) {\n        return `The package at \"${relativePath}\" attempted to import the Node standard library module \"${moduleName}\". It failed because the native React runtime does not include the Node standard library. Read more at ${DOCS_PAGE_URL}`;\n      } else {\n        return `You attempted attempted to import the Node standard library module \"${moduleName}\" from \"${relativePath}\". It failed because the native React runtime does not include the Node standard library. Read more at ${DOCS_PAGE_URL}`;\n      }\n    }\n    return `Unable to resolve \"${moduleName}\" from \"${relativePath}\"`;\n  }\n\n  _formatBundlingError(error: MetroError): string | null {\n    let message = error.message;\n    if (!message && Array.isArray(error.errors) && error.errors.length) {\n      message = (error.errors[0] as any).description;\n    }\n    if (!message) {\n      return null;\n    }\n\n    message = chalk.red(message);\n\n    const snippet = (this._getSnippetForError && this._getSnippetForError(error)) || error.snippet;\n    if (snippet) {\n      message += `\\n${snippet}`;\n    }\n\n    // Import errors are already pretty useful and don't need extra info added to them.\n    const isAmbiguousError = !error.name || ['SyntaxError'].includes(error.name);\n    // When you have a basic syntax error in application code it will tell you the file\n    // and usually also provide a well informed error.\n    const isComprehensiveTransformError = error.type === 'TransformError' && error.filename;\n\n    // console.log(require('util').inspect(error, { depth: 4 }));\n    if (error.stack && isAmbiguousError && !isComprehensiveTransformError) {\n      message += `\\n${chalk.gray(error.stack)}`;\n    }\n    return message;\n  }\n\n  _formatWorkerChunk(origin: 'stdout' | 'stderr', chunk: string) {\n    return chunk;\n    // const lines = chunk.split('\\n');\n    // if (lines.length >= 1 && lines[lines.length - 1] === '') {\n    //   lines.splice(lines.length - 1, 1);\n    // }\n    // return lines.map(line => `transform[${origin}]: ${line}`).join('\\n');\n  }\n\n  _enqueueAppendLogChunk(chunk: LogRecord) {\n    if (!chunk.shouldHide) {\n      this._logsToAdd.push(chunk);\n      this._enqueueFlushLogsToAdd();\n    }\n  }\n\n  _enqueueFlushLogsToAdd = () => {\n    this._updateLogs(logs => {\n      if (this._logsToAdd.length === 0) {\n        return logs;\n      }\n\n      const nextLogs = logs.concat(this._logsToAdd);\n      this._logsToAdd = [];\n      return nextLogs;\n    });\n  };\n\n  _maybeParseMsgJSON(chunk: LogRecord) {\n    try {\n      const parsedMsg = JSON.parse(chunk.msg);\n      chunk.msg = parsedMsg;\n    } catch {\n      // non-JSON message\n    }\n\n    return chunk;\n  }\n\n  _cleanUpNodeErrors = (chunk: LogRecord) => {\n    if (typeof chunk.msg !== 'string') {\n      return chunk;\n    }\n\n    if (chunk.msg.match(/\\(node:.\\d*\\)/)) {\n      // Example: (node:13817) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): SyntaxError: SyntaxError /Users/brent/universe/apps/new-project-template/main.js: Unexpected token (10:6)\n      // The first part of this is totally useless, so let's remove it.\n      if (chunk.msg.match(/UnhandledPromiseRejectionWarning/)) {\n        chunk.msg = chunk.msg.replace(/\\(node:.*\\(rejection .*\\):/, '');\n        if (chunk.msg.match(/SyntaxError: SyntaxError/)) {\n          chunk.msg = chunk.msg.replace('SyntaxError: ', '');\n        }\n      } else if (chunk.msg.match(/DeprecationWarning/)) {\n        chunk.msg = '';\n      }\n    }\n\n    return chunk;\n  };\n}\n\nconst NODE_STDLIB_MODULES = [\n  'assert',\n  'async_hooks',\n  'buffer',\n  'child_process',\n  'cluster',\n  'crypto',\n  'dgram',\n  'dns',\n  'domain',\n  'events',\n  'fs',\n  'http',\n  'https',\n  'net',\n  'os',\n  'path',\n  'punycode',\n  'querystring',\n  'readline',\n  'repl',\n  'stream',\n  'string_decoder',\n  'tls',\n  'tty',\n  'url',\n  'util',\n  'v8',\n  'vm',\n  'zlib',\n];\n"],"mappings":"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"}