{"version":3,"file":"downloadAppAsync.js","names":["TIMER_DURATION","TIMEOUT","_downloadAsync","url","outputPath","progressFunction","retryFunction","promptShown","currentProgress","cancel","token","axios","CancelToken","source","warningTimer","setTimeout","tmpPath","config","timeout","responseType","cancelToken","response","Promise","resolve","totalDownloadSize","data","headers","downloadProgress","on","chunk","length","roundedProgress","Math","floor","clearTimeout","pipe","fs","createWriteStream","rename","downloadAppAsync","extract","dotExpoHomeDirectory","UserSettings","path","join","Extract","extractAsync","removeSync"],"sources":["../../src/utils/downloadAppAsync.ts"],"sourcesContent":["import axios, { AxiosRequestConfig, Canceler } from 'axios';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { Extract, UserSettings } from '../internal';\n\nconst TIMER_DURATION = 30000;\nconst TIMEOUT = 3600000;\n\ntype ProgressCallback = (progressPercentage: number) => void;\ntype RetryCallback = (cancel: Canceler) => void;\n\nasync function _downloadAsync(\n  url: string,\n  outputPath: string,\n  progressFunction?: ProgressCallback,\n  retryFunction?: RetryCallback\n) {\n  let promptShown = false;\n  let currentProgress = 0;\n\n  const { cancel, token } = axios.CancelToken.source();\n\n  let warningTimer = setTimeout(() => {\n    if (retryFunction) {\n      retryFunction(cancel);\n    }\n    promptShown = true;\n  }, TIMER_DURATION);\n\n  const tmpPath = `${outputPath}.download`;\n  const config: AxiosRequestConfig = {\n    timeout: TIMEOUT,\n    responseType: 'stream',\n    cancelToken: token,\n  };\n  const response = await axios(url, config);\n  await new Promise<void>(resolve => {\n    const totalDownloadSize = response.data.headers['content-length'];\n    let downloadProgress = 0;\n    response.data\n      .on('data', (chunk: Buffer) => {\n        downloadProgress += chunk.length;\n        const roundedProgress = Math.floor((downloadProgress / totalDownloadSize) * 100);\n        if (currentProgress !== roundedProgress) {\n          currentProgress = roundedProgress;\n          clearTimeout(warningTimer);\n          if (!promptShown) {\n            warningTimer = setTimeout(() => {\n              if (retryFunction) {\n                retryFunction(cancel);\n              }\n              promptShown = true;\n            }, TIMER_DURATION);\n          }\n          if (progressFunction) {\n            progressFunction(roundedProgress);\n          }\n        }\n      })\n      .on('end', () => {\n        clearTimeout(warningTimer);\n        if (progressFunction && currentProgress !== 100) {\n          progressFunction(100);\n        }\n        resolve();\n      })\n      .pipe(fs.createWriteStream(tmpPath));\n  });\n  await fs.rename(tmpPath, outputPath);\n}\n\nexport async function downloadAppAsync(\n  url: string,\n  outputPath: string,\n  { extract = false } = {},\n  progressFunction?: ProgressCallback,\n  retryFunction?: RetryCallback\n): Promise<void> {\n  if (extract) {\n    const dotExpoHomeDirectory = UserSettings.dotExpoHomeDirectory();\n    const tmpPath = path.join(dotExpoHomeDirectory, 'tmp-download-file');\n    await _downloadAsync(url, tmpPath, progressFunction);\n    await Extract.extractAsync(tmpPath, outputPath);\n    fs.removeSync(tmpPath);\n  } else {\n    await _downloadAsync(url, outputPath, progressFunction, retryFunction);\n  }\n}\n"],"mappings":"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"}