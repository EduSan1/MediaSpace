{"version":3,"file":"Watchman.js","names":["WAIT_FOR_WATCHMAN_VERSION_MS","isPlatformSupported","process","platform","addToPathAsync","Binaries","unblockAndGetVersionAsync","projectRoot","result","_unblockAndVersionAsync","watchmanVersion","JSON","parse","stdout","trim","version","pTimeout","_versionAsync","_unblockAsync","env","TMPDIR","USER","fs","removeSync","path","join","spawnAsync"],"sources":["../src/Watchman.ts"],"sourcesContent":["import spawnAsync, { SpawnResult } from '@expo/spawn-async';\nimport fs from 'fs-extra';\nimport pTimeout from 'p-timeout';\nimport path from 'path';\n\nimport { Binaries } from './internal';\n\nconst WAIT_FOR_WATCHMAN_VERSION_MS = 3000;\n\nexport function isPlatformSupported(): boolean {\n  return process.platform === 'darwin';\n}\n\nexport async function addToPathAsync(): Promise<void> {\n  if (!isPlatformSupported()) {\n    return;\n  }\n\n  await Binaries.addToPathAsync('watchman');\n}\n\nexport async function unblockAndGetVersionAsync(projectRoot?: string): Promise<string | null> {\n  if (!isPlatformSupported()) {\n    return null;\n  }\n\n  try {\n    // `watchman version` returns:\n    // {\n    //  \"version\": \"4.7.0\"\n    // }\n    const result = await _unblockAndVersionAsync(projectRoot);\n    const watchmanVersion = JSON.parse(result.stdout.trim()).version;\n    return watchmanVersion;\n  } catch {\n    // TODO: Maybe check to make sure this is ENOENT (which means watchman isn't installed)\n    // We might want to report other errors\n    return null;\n  }\n}\n\nasync function _unblockAndVersionAsync(projectRoot?: string): Promise<SpawnResult> {\n  try {\n    return await pTimeout(_versionAsync(), WAIT_FOR_WATCHMAN_VERSION_MS);\n  } catch {\n    await _unblockAsync(projectRoot);\n    return await pTimeout(\n      _versionAsync(),\n      WAIT_FOR_WATCHMAN_VERSION_MS,\n      '`watchman version` failed even after `launchctl unload`'\n    );\n  }\n}\n\nasync function _unblockAsync(projectRoot?: string): Promise<void> {\n  if (process.env.TMPDIR && process.env.USER) {\n    // XDL's copy of watchman:\n    fs.removeSync(path.join(process.env.TMPDIR, `${process.env.USER}-state`));\n    // homebrew's watchman:\n    fs.removeSync(`/usr/local/var/run/watchman/${process.env.USER}-state`);\n  }\n  if (process.platform === 'darwin') {\n    await spawnAsync('launchctl', [\n      'unload',\n      '-F',\n      '~/Library/LaunchAgents/com.github.facebook.watchman.plist',\n    ]);\n  }\n  if (projectRoot) {\n    await spawnAsync('watchman', ['watch-del', projectRoot]);\n    await spawnAsync('watchman', ['watch-project', projectRoot]);\n  }\n}\n\nasync function _versionAsync(): Promise<SpawnResult> {\n  return await spawnAsync('watchman', ['version']);\n}\n"],"mappings":";;;;;;;;;AAAA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AACA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAEA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;AAEA,MAAMA,4BAA4B,GAAG,IAArC;;AAEO,SAASC,mBAAT,GAAwC;EAC7C,OAAOC,OAAO,CAACC,QAAR,KAAqB,QAA5B;AACD;;AAEM,eAAeC,cAAf,GAA+C;EACpD,IAAI,CAACH,mBAAmB,EAAxB,EAA4B;IAC1B;EACD;;EAED,MAAMI,oBAAA,CAASD,cAAT,CAAwB,UAAxB,CAAN;AACD;;AAEM,eAAeE,yBAAf,CAAyCC,WAAzC,EAAuF;EAC5F,IAAI,CAACN,mBAAmB,EAAxB,EAA4B;IAC1B,OAAO,IAAP;EACD;;EAED,IAAI;IACF;IACA;IACA;IACA;IACA,MAAMO,MAAM,GAAG,MAAMC,uBAAuB,CAACF,WAAD,CAA5C;IACA,MAAMG,eAAe,GAAGC,IAAI,CAACC,KAAL,CAAWJ,MAAM,CAACK,MAAP,CAAcC,IAAd,EAAX,EAAiCC,OAAzD;IACA,OAAOL,eAAP;EACD,CARD,CAQE,MAAM;IACN;IACA;IACA,OAAO,IAAP;EACD;AACF;;AAED,eAAeD,uBAAf,CAAuCF,WAAvC,EAAmF;EACjF,IAAI;IACF,OAAO,MAAM,IAAAS,mBAAA,EAASC,aAAa,EAAtB,EAA0BjB,4BAA1B,CAAb;EACD,CAFD,CAEE,MAAM;IACN,MAAMkB,aAAa,CAACX,WAAD,CAAnB;IACA,OAAO,MAAM,IAAAS,mBAAA,EACXC,aAAa,EADF,EAEXjB,4BAFW,EAGX,yDAHW,CAAb;EAKD;AACF;;AAED,eAAekB,aAAf,CAA6BX,WAA7B,EAAkE;EAChE,IAAIL,OAAO,CAACiB,GAAR,CAAYC,MAAZ,IAAsBlB,OAAO,CAACiB,GAAR,CAAYE,IAAtC,EAA4C;IAC1C;IACAC,kBAAA,CAAGC,UAAH,CAAcC,eAAA,CAAKC,IAAL,CAAUvB,OAAO,CAACiB,GAAR,CAAYC,MAAtB,EAA+B,GAAElB,OAAO,CAACiB,GAAR,CAAYE,IAAK,QAAlD,CAAd,EAF0C,CAG1C;;;IACAC,kBAAA,CAAGC,UAAH,CAAe,+BAA8BrB,OAAO,CAACiB,GAAR,CAAYE,IAAK,QAA9D;EACD;;EACD,IAAInB,OAAO,CAACC,QAAR,KAAqB,QAAzB,EAAmC;IACjC,MAAM,IAAAuB,qBAAA,EAAW,WAAX,EAAwB,CAC5B,QAD4B,EAE5B,IAF4B,EAG5B,2DAH4B,CAAxB,CAAN;EAKD;;EACD,IAAInB,WAAJ,EAAiB;IACf,MAAM,IAAAmB,qBAAA,EAAW,UAAX,EAAuB,CAAC,WAAD,EAAcnB,WAAd,CAAvB,CAAN;IACA,MAAM,IAAAmB,qBAAA,EAAW,UAAX,EAAuB,CAAC,eAAD,EAAkBnB,WAAlB,CAAvB,CAAN;EACD;AACF;;AAED,eAAeU,aAAf,GAAqD;EACnD,OAAO,MAAM,IAAAS,qBAAA,EAAW,UAAX,EAAuB,CAAC,SAAD,CAAvB,CAAb;AACD"}