{"version":3,"file":"ExpSchema.js","names":["_xdlSchemaJson","_schemaCaches","validatorFromProjectRoot","projectRoot","exp","getConfig","sdkVersion","Error","schema","getSchemaAsync","validator","Schemer","validateAsync","validateAll","json","_getSchemaJSONAsync","schemaDerefSync","getAssetSchemasAsync","assetSchemas","visit","node","fieldPath","meta","asset","push","properties","Object","keys","forEach","property","length","boolish","process","env","EXPONENT_UNIVERSE_DIR","JSON","parse","fs","readFileSync","path","join","toString","getConfigurationSchemaAsync","e","code","hasOwnProperty","FsCache","Cacher","ApiV2","getAsync","__dirname"],"sources":["../../src/project/ExpSchema.ts"],"sourcesContent":["import { getConfig } from '@expo/config';\nimport { JSONObject } from '@expo/json-file';\nimport Schemer from '@expo/schemer';\nimport fs from 'fs';\nimport { boolish } from 'getenv';\nimport schemaDerefSync from 'json-schema-deref-sync';\nimport path from 'path';\n\nimport { ApiV2, FsCache } from '../internal';\n\nexport type Schema = any;\nexport type AssetSchema = {\n  // schema: Schema;\n  fieldPath: string;\n};\n\nconst _xdlSchemaJson: { [sdkVersion: string]: Schema } = {};\nconst _schemaCaches: { [version: string]: FsCache.Cacher<JSONObject> } = {};\n\nexport async function validatorFromProjectRoot(projectRoot: string): Promise<Schemer> {\n  const { exp } = getConfig(projectRoot);\n  if (!exp.sdkVersion) throw new Error(`Couldn't read local manifest`);\n  const schema = await getSchemaAsync(exp.sdkVersion);\n  const validator = new Schemer(schema);\n  return validator;\n}\n\nexport async function validateAsync(projectRoot: string) {\n  const { exp } = getConfig(projectRoot);\n  if (!exp.sdkVersion) throw new Error(`Couldn't read local manifest`);\n  const schema = await getSchemaAsync(exp.sdkVersion);\n  const validator = new Schemer(schema);\n  await validator.validateAll(exp);\n}\n\nexport async function getSchemaAsync(sdkVersion: string): Promise<Schema> {\n  const json = await _getSchemaJSONAsync(sdkVersion);\n  const schema = schemaDerefSync(json.schema);\n  return schema;\n}\n\n/**\n * Array of schema nodes that refer to assets along with their field path (eg. 'notification.icon')\n *\n * @param sdkVersion\n */\nexport async function getAssetSchemasAsync(sdkVersion: string | undefined): Promise<string[]> {\n  // If no SDK version is available then fall back to unversioned\n  const schema = await getSchemaAsync(sdkVersion ?? 'UNVERSIONED');\n  const assetSchemas: string[] = [];\n  const visit = (node: Schema, fieldPath: string) => {\n    if (node.meta && node.meta.asset) {\n      assetSchemas.push(fieldPath);\n    }\n    const properties = node.properties;\n    if (properties) {\n      Object.keys(properties).forEach(property =>\n        visit(properties[property], `${fieldPath}${fieldPath.length > 0 ? '.' : ''}${property}`)\n      );\n    }\n  };\n  visit(schema, '');\n\n  return assetSchemas;\n}\n\nasync function _getSchemaJSONAsync(sdkVersion: string): Promise<{ schema: Schema }> {\n  if (boolish('LOCAL_XDL_SCHEMA', false)) {\n    if (process.env.EXPONENT_UNIVERSE_DIR) {\n      return JSON.parse(\n        fs\n          .readFileSync(\n            path.join(\n              process.env.EXPONENT_UNIVERSE_DIR,\n              'server',\n              'www',\n              'xdl-schemas',\n              'UNVERSIONED-schema.json'\n            )\n          )\n          .toString()\n      );\n    } else {\n      throw new Error(`LOCAL_XDL_SCHEMA is set but EXPONENT_UNIVERSE_DIR is not.`);\n    }\n  }\n\n  if (!_xdlSchemaJson[sdkVersion]) {\n    try {\n      _xdlSchemaJson[sdkVersion] = await getConfigurationSchemaAsync(sdkVersion);\n    } catch (e: any) {\n      if (e.code && e.code === 'INVALID_JSON') {\n        throw new Error(`Couldn't read schema from server`);\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  return _xdlSchemaJson[sdkVersion];\n}\n\nasync function getConfigurationSchemaAsync(sdkVersion: string): Promise<JSONObject> {\n  if (!_schemaCaches.hasOwnProperty(sdkVersion)) {\n    _schemaCaches[sdkVersion] = new FsCache.Cacher(\n      async () => {\n        return await new ApiV2().getAsync(`project/configuration/schema/${sdkVersion}`);\n      },\n      `schema-${sdkVersion}.json`,\n      0,\n      path.join(__dirname, `../caches/schema-${sdkVersion}.json`)\n    );\n  }\n\n  return await _schemaCaches[sdkVersion].getAsync();\n}\n"],"mappings":"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"}