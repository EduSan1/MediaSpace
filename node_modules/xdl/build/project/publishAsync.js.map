{"version":3,"file":"publishAsync.js","names":["publishAsync","projectRoot","options","target","getDefaultTarget","user","UserManager","ensureLoggedInAsync","Env","isDebug","console","log","Analytics","logEvent","developerTool","Config","validationStatus","Doctor","validateWithNetworkAsync","ERROR","FATAL","XDLError","exp","pkg","hooks","getPublishExpConfigAsync","validPostPublishHooks","prepareHooks","bundles","createBundlesAsync","platforms","useDevServer","shouldUseDevServer","printBundleSizes","ProjectAssets","publishAssetsAsync","androidBundle","android","hermesBytecodeBundle","code","iosBundle","ios","hasHooks","length","androidSourceMap","hermesSourcemap","map","iosSourceMap","response","_uploadArtifactsAsync","e","serverError","Error","androidManifest","iosManifest","fullManifestUrl","url","replace","publishManifestPath","EmbeddedAssets","shouldEmbedAssetsForExpoUpdates","sdkOrRuntimeVersion","runtimeVersion","sdkVersion","Promise","all","ExponentTools","getManifestAsync","releaseChannel","Accept","hookOptions","iosManifestUrl","androidManifestUrl","msg","logger","global","info","quiet","hook","file","runHook","warn","stack","configureAsync","isKernel","_handleKernelPublishedAsync","projectPageUrl","createProjectPageURL","formData","FormData","append","JSON","stringify","api","ApiV2","clientForUser","uploadFormDataAsync","owner","kind","username","kernelBundleUrl","scheme","host","port","slug","kernel","androidManifestPath","manifest","bundleUrl","fs","writeFile","path","resolve","iosManifestPath","formattedProjectUrl"],"sources":["../../src/project/publishAsync.ts"],"sourcesContent":["import {\n  ExpoAppManifest,\n  ExpoConfig,\n  getDefaultTarget,\n  HookArguments,\n  PackageJSONConfig,\n} from '@expo/config';\nimport FormData from 'form-data';\nimport fs from 'fs-extra';\nimport path from 'path';\n\nimport { RobotUser } from '../User';\nimport {\n  Analytics,\n  ApiV2,\n  Config,\n  createBundlesAsync,\n  Doctor,\n  EmbeddedAssets,\n  Env,\n  ExponentTools,\n  getPublishExpConfigAsync,\n  LoadedHook,\n  Logger as logger,\n  prepareHooks,\n  printBundleSizes,\n  ProjectAssets,\n  PublishOptions,\n  runHook,\n  User,\n  UserManager,\n  XDLError,\n} from '../internal';\n\nexport interface PublishedProjectResult {\n  /**\n   * Project manifest URL\n   */\n  url: string;\n  /**\n   * Project page URL\n   */\n  projectPageUrl: string;\n  /**\n   * TODO: What is this?\n   */\n  ids: string[];\n  /**\n   * TODO: What is this? Where does it come from?\n   */\n  err?: string;\n}\n\nexport async function publishAsync(\n  projectRoot: string,\n  options: PublishOptions = {}\n): Promise<PublishedProjectResult> {\n  options.target = options.target ?? getDefaultTarget(projectRoot);\n  const target = options.target;\n  const user = await UserManager.ensureLoggedInAsync();\n\n  if (Env.isDebug()) {\n    console.log();\n    console.log('Publish Assets:');\n    console.log(`- Asset target: ${target}`);\n    console.log();\n  }\n\n  Analytics.logEvent('Publish', {\n    developerTool: Config.developerTool,\n  });\n\n  const validationStatus = await Doctor.validateWithNetworkAsync(projectRoot);\n  if (validationStatus === Doctor.ERROR || validationStatus === Doctor.FATAL) {\n    throw new XDLError(\n      'PUBLISH_VALIDATION_ERROR',\n      \"Couldn't publish because errors were found. (See logs above.) Please fix the errors and try again.\"\n    );\n  }\n\n  // Get project config\n  const { exp, pkg, hooks } = await getPublishExpConfigAsync(projectRoot, options);\n\n  // TODO: refactor this out to a function, throw error if length doesn't match\n  const validPostPublishHooks: LoadedHook[] = prepareHooks(hooks, 'postPublish', projectRoot);\n  const bundles = await createBundlesAsync(projectRoot, options, {\n    platforms: ['ios', 'android'],\n    useDevServer: Env.shouldUseDevServer(exp),\n  });\n\n  printBundleSizes(bundles);\n\n  await ProjectAssets.publishAssetsAsync({ projectRoot, exp, bundles });\n\n  const androidBundle = bundles.android?.hermesBytecodeBundle ?? bundles.android?.code!;\n  const iosBundle = bundles.ios?.hermesBytecodeBundle ?? bundles.ios?.code!;\n\n  const hasHooks = validPostPublishHooks.length > 0;\n\n  const androidSourceMap = hasHooks\n    ? bundles.android?.hermesSourcemap ?? bundles.android?.map ?? null\n    : null;\n  const iosSourceMap = hasHooks ? bundles.ios?.hermesSourcemap ?? bundles.ios?.map ?? null : null;\n\n  let response;\n  try {\n    response = await _uploadArtifactsAsync({\n      pkg,\n      exp,\n      iosBundle,\n      androidBundle,\n      options,\n    });\n  } catch (e: any) {\n    if (e.serverError === 'SCHEMA_VALIDATION_ERROR') {\n      throw new Error(\n        `There was an error validating your project schema. Check for any warnings about the contents of your app.json or app.config.js.`\n      );\n    }\n    throw e;\n  }\n\n  let androidManifest = {};\n  let iosManifest = {};\n  const fullManifestUrl = response.url.replace('exp://', 'https://');\n\n  if (\n    validPostPublishHooks.length ||\n    exp.ios?.publishManifestPath ||\n    exp.android?.publishManifestPath ||\n    EmbeddedAssets.shouldEmbedAssetsForExpoUpdates(projectRoot, exp, pkg, target)\n  ) {\n    const sdkOrRuntimeVersion = exp.runtimeVersion\n      ? {\n          'expo-runtime-version': exp.runtimeVersion,\n        }\n      : { 'expo-sdk-version': exp.sdkVersion };\n\n    [androidManifest, iosManifest] = await Promise.all([\n      ExponentTools.getManifestAsync(response.url, {\n        ...sdkOrRuntimeVersion,\n        'Exponent-Platform': 'android',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n      ExponentTools.getManifestAsync(response.url, {\n        ...sdkOrRuntimeVersion,\n        'Exponent-Platform': 'ios',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n    ]);\n\n    const hookOptions: Omit<HookArguments, 'config'> = {\n      url: response.url,\n      exp,\n      iosBundle,\n      iosSourceMap,\n      iosManifest,\n      iosManifestUrl: fullManifestUrl,\n      androidBundle,\n      androidSourceMap,\n      androidManifest,\n      androidManifestUrl: fullManifestUrl,\n      projectRoot,\n      log: (msg: any) => {\n        logger.global.info({ quiet: true }, msg);\n      },\n    };\n\n    for (const hook of validPostPublishHooks) {\n      logger.global.info(`Running postPublish hook: ${hook.file}`);\n      try {\n        runHook(hook, hookOptions);\n      } catch (e: any) {\n        logger.global.warn(`Warning: postPublish hook '${hook.file}' failed: ${e.stack}`);\n      }\n    }\n  }\n\n  await EmbeddedAssets.configureAsync({\n    projectRoot,\n    pkg,\n    exp,\n    releaseChannel: options.releaseChannel ?? 'default',\n    iosManifestUrl: fullManifestUrl,\n    iosManifest,\n    iosBundle,\n    androidManifestUrl: fullManifestUrl,\n    androidManifest,\n    androidBundle,\n    target,\n  });\n\n  // TODO: move to postPublish hook\n  if (exp.isKernel) {\n    await _handleKernelPublishedAsync({\n      user,\n      exp,\n      projectRoot,\n      url: response.url,\n    });\n  }\n\n  // Create project manifest URL\n  const url =\n    options.releaseChannel && options.releaseChannel !== 'default'\n      ? `${response.url}?release-channel=${options.releaseChannel}`\n      : response.url;\n\n  const projectPageUrl = createProjectPageURL({\n    projectPageUrl: response.projectPageUrl,\n    releaseChannel: options.releaseChannel,\n  });\n\n  return {\n    ...response,\n    url,\n    projectPageUrl,\n  };\n}\n\nasync function _uploadArtifactsAsync({\n  exp,\n  iosBundle,\n  androidBundle,\n  options,\n  pkg,\n}: {\n  exp: ExpoConfig;\n  iosBundle: string | Uint8Array;\n  androidBundle: string | Uint8Array;\n  options: PublishOptions;\n  pkg: PackageJSONConfig;\n}) {\n  logger.global.info('');\n  logger.global.info('Uploading JavaScript bundles');\n  const formData = new FormData();\n\n  formData.append('expJson', JSON.stringify(exp));\n  formData.append('packageJson', JSON.stringify(pkg));\n  formData.append('iosBundle', iosBundle, 'iosBundle');\n  formData.append('androidBundle', androidBundle, 'androidBundle');\n  formData.append('options', JSON.stringify(options));\n\n  const user = await UserManager.ensureLoggedInAsync();\n  const api = ApiV2.clientForUser(user);\n\n  return await api.uploadFormDataAsync('publish/new', formData);\n}\n\nasync function _handleKernelPublishedAsync({\n  projectRoot,\n  user,\n  exp,\n  url,\n}: {\n  projectRoot: string;\n  user: User | RobotUser;\n  exp: ExpoAppManifest;\n  url: string;\n}) {\n  let owner = exp.owner;\n  if (!owner) {\n    if (user.kind !== 'user') {\n      throw new XDLError(\n        'ROBOT_ACCOUNT_ERROR',\n        'Kernel builds are not available for robot users when owner app.json field is not supplied'\n      );\n    }\n    owner = user.username;\n  }\n\n  let kernelBundleUrl = `${Config.api.scheme}://${Config.api.host}`;\n  if (Config.api.port) {\n    kernelBundleUrl = `${kernelBundleUrl}:${Config.api.port}`;\n  }\n  kernelBundleUrl = `${kernelBundleUrl}/@${owner}/${exp.slug}/bundle`;\n  const sdkOrRuntimeVersion = exp.runtimeVersion\n    ? {\n        'expo-runtime-version': exp.runtimeVersion,\n      }\n    : { 'expo-sdk-version': exp.sdkVersion };\n\n  if (exp.kernel?.androidManifestPath) {\n    const manifest = await ExponentTools.getManifestAsync(url, {\n      ...sdkOrRuntimeVersion,\n      'Exponent-Platform': 'android',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.androidManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n\n  if (exp.kernel?.iosManifestPath) {\n    const manifest = await ExponentTools.getManifestAsync(url, {\n      ...sdkOrRuntimeVersion,\n      'Exponent-Platform': 'ios',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.iosManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n}\n\nfunction createProjectPageURL({\n  projectPageUrl,\n  releaseChannel,\n}: {\n  projectPageUrl: string;\n  releaseChannel?: string;\n}): string | null {\n  if (!projectPageUrl) {\n    return null;\n  }\n\n  const formattedProjectUrl = `${projectPageUrl}?serviceType=classic&distribution=expo-go`;\n  if (releaseChannel && releaseChannel !== 'default') {\n    return `${formattedProjectUrl}&release-channel=${releaseChannel}`;\n  } else {\n    return formattedProjectUrl;\n  }\n}\n"],"mappings":"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"}